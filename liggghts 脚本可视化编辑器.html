<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIGGGHTS ÂèØËßÜÂåñÁïåÈù¢</title>
    <style>
        :root {
            /* ‰∫ÆËâ≤‰∏ªÈ¢ò */
            --bg-primary: #f5f5f5;
            --bg-secondary: white;
            --bg-tertiary: #f9fafb;
            --bg-quaternary: #f3f4f6;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-primary: #e5e5e5;
            --border-secondary: #d1d5db;
            --shadow-primary: rgba(0,0,0,0.1);
            --shadow-secondary: rgba(0,0,0,0.2);
        }

        [data-theme="dark"] {
            /* ÊöóËâ≤‰∏ªÈ¢ò */
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --bg-quaternary: #4b5563;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-tertiary: #9ca3af;
            --border-primary: #374151;
            --border-secondary: #4b5563;
            --shadow-primary: rgba(0,0,0,0.3);
            --shadow-secondary: rgba(0,0,0,0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .toolbar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px var(--shadow-primary);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .toolbar h1 {
            font-size: 20px;
            font-weight: bold;
            color: var(--text-primary);
            margin-right: 16px;
            transition: color 0.3s ease;
        }
        
        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn {
            background: white;
            color: black;
            border: 1px solid transparent;
            border-radius: 6em;
            padding: 0.5em 1.2em;
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            font-weight: 500;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:active {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        /* Áªü‰∏ÄÊâÄÊúâÊåâÈíÆÊ†∑Âºè */
        .btn-primary,
        .btn-gray,
        .btn-green,
        .btn-red {
            background: white;
            color: black;
            border: 1px solid transparent;
            border-radius: 6em;
            padding: 0.5em 1.2em;
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            font-weight: 500;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .btn-primary::before,
        .btn-gray::before,
        .btn-green::before,
        .btn-red::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-primary:hover,
        .btn-gray:hover,
        .btn-green:hover,
        .btn-red:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-primary:hover::before,
        .btn-gray:hover::before,
        .btn-green:hover::before,
        .btn-red:hover::before {
            left: 100%;
        }
        
        .btn-primary:active,
        .btn-gray:active,
        .btn-green:active,
        .btn-red:active {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        /* ÁâπÊÆäÊåâÈíÆÊ†∑ÂºèÁªü‰∏Ä */
        .btn-gray:nth-child(3),
        #runBtn {
            background: white !important;
            color: black !important;
            border: 1px solid transparent !important;
            position: relative !important;
            overflow: hidden !important;
        }
        
        .btn-gray:nth-child(3):hover,
        #runBtn:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2) !important;
        }
        
        .btn-gray:nth-child(3):active,
        #runBtn:active {
            transform: translateY(-1px) scale(0.98) !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
        }
        
        /* ÊöóËâ≤‰∏ªÈ¢òÊåâÈíÆÊ†∑Âºè */
        [data-theme="dark"] .btn,
        [data-theme="dark"] .btn-primary,
        [data-theme="dark"] .btn-gray,
        [data-theme="dark"] .btn-green,
        [data-theme="dark"] .btn-red {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }
        
        [data-theme="dark"] .btn::before,
        [data-theme="dark"] .btn-primary::before,
        [data-theme="dark"] .btn-gray::before,
        [data-theme="dark"] .btn-green::before,
        [data-theme="dark"] .btn-red::before {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        }
        
        [data-theme="dark"] .btn:hover,
        [data-theme="dark"] .btn-primary:hover,
        [data-theme="dark"] .btn-gray:hover,
        [data-theme="dark"] .btn-green:hover,
        [data-theme="dark"] .btn-red:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }
        
        /* ÊöóËâ≤‰∏ªÈ¢òÁâπÊÆäÊåâÈíÆ */
        [data-theme="dark"] .btn-gray:nth-child(3),
        [data-theme="dark"] #runBtn {
            background: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-primary) !important;
        }
        
        [data-theme="dark"] .btn-gray:nth-child(3):hover,
        [data-theme="dark"] #runBtn:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.4) !important;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            width: 100%;
        }
        
        .commands-panel {
            flex: 0.3;
            width: 30%;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .search-bar {
            height: 56px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid var(--border-primary);
            background: var(--bg-secondary);
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        
        .search-bar h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            transition: color 0.3s ease;
        }
        
        .search-bar .search-wrapper {
            flex: 1;
            max-width: 280px;
            margin-left: 16px;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            position: relative;
            z-index: 5;
            background: var(--bg-secondary);
        }
        
        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .search-wrapper {
            position: relative;
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            z-index: 10;
            pointer-events: none;
        }
        
        .search-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 16px;
            padding: 2px;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .search-clear:hover {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .search-clear.show {
            display: flex;
        }
        
        .tabs {
            display: flex;
            background: #f9fafb;
            border-bottom: 1px solid #e5e5e5;
            overflow-x: hidden; /* ÁßªÈô§ÊªöÂä®Êù° */
        }
        
        .tab {
            padding: 8px 6px; /* Ëøõ‰∏ÄÊ≠•ÂáèÂ∞ëÂÜÖËæπË∑ù */
            border: none;
            background: none;
            cursor: pointer;
            font-size: 12px; /* Â¢ûÂ§ßÂ≠ó‰Ωì */
            color: var(--text-secondary); /* ‰ΩøÁî®‰∏ªÈ¢òËâ≤ */
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px; /* Ëøõ‰∏ÄÊ≠•ÂáèÂ∞ëÈó¥Ë∑ù */
            transition: all 0.2s;
            position: relative;
            flex: 1; /* ËÆ©Ê†áÁ≠æÂùáÂàÜÂÆΩÂ∫¶ */
            justify-content: center; /* Â±Ö‰∏≠ÂØπÈΩê */
            min-width: 0; /* ÂÖÅËÆ∏Êî∂Áº© */
            overflow: hidden; /* Èò≤Ê≠¢ÂÜÖÂÆπÊ∫¢Âá∫ */
        }
        
        .tab-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-shrink: 1;
        }
        
        .tab-count {
            background: #e5e7eb;
            color: #6b7280;
            font-size: 9px; /* Êõ¥Â∞èÁöÑÂ≠ó‰Ωì */
            padding: 1px 3px; /* Ëøõ‰∏ÄÊ≠•ÂáèÂ∞ëÂÜÖËæπË∑ù */
            border-radius: 6px; /* Êõ¥Â∞èÁöÑÂúÜËßí */
            min-width: 12px; /* Êõ¥Â∞èÁöÑÊúÄÂ∞èÂÆΩÂ∫¶ */
            text-align: center;
            line-height: 1.1;
            margin-left: 1px; /* Ëøõ‰∏ÄÊ≠•ÂáèÂ∞ëÂ§ñËæπË∑ù */
            flex-shrink: 0; /* Èò≤Ê≠¢Êî∂Áº© */
        }
        
        .tab.active .tab-count {
            background: #3b82f6;
            color: white;
        }
        
        .tab.drag-hover {
            background: #e0f2fe !important;
            border-bottom-color: #0891b2 !important;
            transform: scale(1.02);
        }
        
        .tab:hover {
            color: #374151;
            background: #f3f4f6;
        }
        
        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background: white;
        }
        
        .tab.search-highlight {
            background: #fef3c7;
            color: #d97706;
            border-bottom-color: #f59e0b;
        }
        
        .tab.search-highlight.active {
            background: #fbbf24;
            color: white;
            border-bottom-color: #f59e0b;
        }
        

        
        .commands-grid {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        .commands-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            grid-auto-rows: 120px;
            gap: 12px;
            padding: 16px;
            min-height: 400px;
        }
        
        .grid-cell {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            position: relative;
            transition: all 0.2s ease;
            background: var(--bg-tertiary);
            opacity: 0.3;
        }
        
        .grid-cell.occupied {
            border: 1px solid #e5e5e5;
            background: var(--bg-secondary);
            opacity: 1;
        }
        
        .grid-cell.drop-target {
            border-color: #3b82f6;
            background: #eff6ff;
            opacity: 0.8;
        }
        
        .grid-cell.drop-invalid {
            border-color: #ef4444;
            background: #fef2f2;
            opacity: 0.8;
        }
        
        .grid-cell.add-command {
            border: 2px dashed #3b82f6;
            background: var(--bg-tertiary);
            opacity: 0.6;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .grid-cell.add-command:hover {
            opacity: 0.9;
            border-color: #2563eb;
            background: #eff6ff;
        }
        
        .add-command-icon {
            font-size: 24px;
            color: #3b82f6;
            user-select: none;
        }
        
        .command-card {
            position: absolute;
            top: 4px;
            left: 4px;
            right: 4px;
            bottom: 4px;
            padding: 12px;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .command-card .drag-handle {
            position: absolute;
            top: 4px;
            right: 4px;
            opacity: 0;
            transition: opacity 0.2s;
            user-select: none;
            font-size: 10px;
            cursor: grab;
            z-index: 10;
        }
        
        .command-card .command-actions {
            position: absolute;
            top: 4px;
            right: 4px;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            gap: 2px;
            z-index: 10;
        }
        
        .command-card.selected .command-actions {
            opacity: 1;
        }
        
        .command-action-btn {
            width: 16px;
            height: 16px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .command-action-btn.edit {
            background: #f59e0b;
            color: white;
        }
        
        .command-action-btn.edit:hover {
            background: #d97706;
        }
        
        .command-action-btn.delete {
            background: #ef4444;
            color: white;
        }
        
        .command-action-btn.delete:hover {
            background: #dc2626;
        }
        
        .command-card.dragging {
            z-index: 1000 !important;
            opacity: 0.8 !important;
            transform: rotate(2deg) scale(0.75) !important;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3) !important;
        }
        
        .command-card:hover {
            border-color: #d1d5db;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .command-card.selected {
            border-color: #3b82f6;
            background: #eff6ff;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2);
        }
        
        .command-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            font-size: 13px;
            line-height: 1.2;
        }
        
        .command-desc {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            line-height: 1.2;
            flex: 1;
        }
        
        .command-params {
            font-size: 9px;
            color: var(--text-tertiary);
            line-height: 1.1;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .params-panel {
            flex: 0.3;
            width: 30%;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .params-header {
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            border-bottom: 1px solid var(--border-primary);
            background: var(--bg-secondary);
            box-sizing: border-box;
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }
        
        .params-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        
        .param-reset-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
            opacity: 0.6;
            display: none;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }
        
        .param-reset-btn:hover {
            background: var(--bg-tertiary);
            opacity: 1;
            transform: scale(1.1);
        }
        
        .param-reset-btn:active {
            transform: scale(0.95);
        }
        
        .reset-icon {
            font-size: 16px;
            transition: transform 0.6s ease;
            display: inline-block;
        }
        
        .param-reset-btn:hover .reset-icon {
            transform: rotate(360deg);
        }
        
        .param-reset-btn.spinning .reset-icon {
            animation: spin 0.6s ease-in-out;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .params-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: var(--bg-secondary);
            transition: background-color 0.3s ease;
        }
        
        .params-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .command-info {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: background-color 0.3s ease;
        }
        
        .command-info h3 {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            transition: color 0.3s ease;
        }
        
        .command-info p {
            font-size: 14px;
            color: var(--text-secondary);
            transition: color 0.3s ease;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.5;
        }
        
        .param-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .param-label {
            font-size: 12px;
            font-weight: 400;
            color: #6b7280;
            transition: color 0.3s ease;
            margin-bottom: 4px;
        }
        
        .param-input {
            padding: 8px 12px;
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;
        }
        
        .param-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .add-command-btn {
            width: 100%;
            margin-top: 24px;
            padding: 14px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }
        
        .add-command-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #9ca3af;
            text-align: center;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .script-panel {
            flex: 0.4;
            width: 40%;
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }
        
        .script-header {
            height: 56px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid var(--border-primary);
            background: var(--bg-secondary);
            box-sizing: border-box;
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }
        
        .script-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        
        .script-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #6b7280;
        }
        
        .script-info .btn {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
        }
        
        .script-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: var(--bg-secondary);
            transition: background-color 0.3s ease;
        }
        
        .script-lines {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }
        
        .script-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            cursor: move;
            border-bottom: 1px solid #e5e7eb;
            line-height: 1.4;
        }
        
        .script-line:first-child {
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
        }
        
        .script-line:last-child {
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
            border-bottom: none;
        }
        
        .script-line:hover {
            background: #f1f3f4;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .script-line.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .script-line.drag-over {
            border-top: 2px solid #3b82f6;
            background: #eff6ff;
        }
        
        .script-line .drag-handle {
            cursor: grab;
            color: #9ca3af;
            margin-right: 8px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .script-line:hover .drag-handle {
            opacity: 1;
        }
        
        .script-line .drag-handle:active {
            cursor: grabbing;
        }
        
        .script-line.editing {
            background: #fff;
            border: 2px solid #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .script-line.editing .drag-handle {
            display: none;
        }
        
        .script-line.editing .line-number {
            color: #3b82f6;
            min-width: 20px;
            flex-shrink: 0;
        }
        
        .script-line.editing .line-content {
            flex: 1;
            min-width: 0;
        }
        
        .edit-input {
            flex: 1;
            width: 100%;
            border: none;
            outline: none;
            background: transparent;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #1f2937;
            padding: 2px 4px;
            min-width: 0;
        }
        
        .edit-actions {
            display: flex;
            gap: 4px;
            opacity: 1;
        }
        
        .edit-btn {
            padding: 2px 6px;
            border: none;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .edit-btn.save {
            background: #10b981;
            color: white;
        }
        
        .edit-btn.save:hover {
            background: #059669;
        }
        
        .edit-btn.cancel {
            background: #6b7280;
            color: white;
        }
        
        .edit-btn.cancel:hover {
            background: #4b5563;
        }
        
        .script-line:hover .delete-btn {
            opacity: 1;
        }
        
        .delete-btn {
            opacity: 0;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            transition: opacity 0.2s;
        }
        
        .delete-btn:hover {
            background: #dc2626;
        }
        
        .script-actions {
            padding: 16px;
            border-top: 1px solid #e5e5e5;
            background: #f9fafb;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .drag-hint {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 12px;
            color: #6b7280;
            padding: 8px;
            background: #f3f4f6;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .drag-hint.hidden {
            display: none;
        }
        
        /* Ê†áÁ≠æÊøÄÊ¥ªÁä∂ÊÄÅÈ¢úËâ≤ - 7ÁßçÊòéÊòæÂå∫ÂàÜÁöÑÈ¢úËâ≤ */
        .tab.active.tab-color-blue { 
            color: #2563eb; 
            font-weight: 600; 
        }
        .tab.active.tab-color-green { 
            color: #059669; 
            font-weight: 600; 
        }
        .tab.active.tab-color-purple { 
            color: #7c3aed; 
            font-weight: 600; 
        }
        .tab.active.tab-color-orange { 
            color: #d97706; 
            font-weight: 600; 
        }
        .tab.active.tab-color-red { 
            color: #dc2626; 
            font-weight: 600; 
        }
        .tab.active.tab-color-indigo { 
            color: #0891b2; 
            font-weight: 600; 
        }
        .tab.active.tab-color-gray { 
            color: #6b7280; 
            font-weight: 600; 
        }
        
        /* ÊöóËâ≤Ê®°Âºè‰∏ãÁöÑÊøÄÊ¥ªÁä∂ÊÄÅÈ¢úËâ≤ */
        [data-theme="dark"] .tab.active.tab-color-blue { 
            color: #60a5fa; 
            font-weight: 600; 
        }
        [data-theme="dark"] .tab.active.tab-color-green { 
            color: #34d399; 
            font-weight: 600; 
        }
        [data-theme="dark"] .tab.active.tab-color-purple { 
            color: #a78bfa; 
            font-weight: 600; 
        }
        [data-theme="dark"] .tab.active.tab-color-orange { 
            color: #fbbf24; 
            font-weight: 600; 
        }
        [data-theme="dark"] .tab.active.tab-color-red { 
            color: #f87171; 
            font-weight: 600; 
        }
        [data-theme="dark"] .tab.active.tab-color-indigo { 
            color: #22d3ee; 
            font-weight: 600; 
        }
        [data-theme="dark"] .tab.active.tab-color-gray { 
            color: #9ca3af; 
            font-weight: 600; 
        }
        
        /* Ê≠•È™§ËÉåÊôØÈ¢úËâ≤ - ÁßªÈô§ÊâÄÊúâÈ¢úËâ≤Ôºå‰øùÊåÅÁªü‰∏ÄÂ§ñËßÇ */
        .step-init, 
        .step-geometry, 
        .step-material, 
        .step-particle, 
        .step-solver, 
        .step-output, 
        .step-other {
            background: transparent;
            color: inherit;
        }
        
        /* ÊöóËâ≤‰∏ªÈ¢òÈ¢ùÂ§ñÊ†∑Âºè */
        [data-theme="dark"] .tabs {
            background: var(--bg-tertiary);
        }
        
        [data-theme="dark"] .script-line {
            background: #2d3748;
        }
        
        [data-theme="dark"] .script-line:hover {
            background: #374151;
        }
        
        [data-theme="dark"] .tab {
            color: var(--text-secondary);
        }
        
        [data-theme="dark"] .tab.active {
            background: var(--bg-secondary);
            color: #3b82f6;
        }
        
        [data-theme="dark"] .tab-count {
            background: #374151;
            color: #9ca3af;
        }
        
        [data-theme="dark"] .tab.active .tab-count {
            background: #3b82f6;
            color: white;
        }
        
        [data-theme="dark"] .tab.drag-hover {
            background: #1e293b !important;
            border-bottom-color: #0891b2 !important;
            transform: scale(1.02);
        }
        
        [data-theme="dark"] .command-card {
            background: var(--bg-tertiary);
            border-color: var(--border-primary);
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .command-card:hover {
            background: var(--bg-quaternary);
        }
        
        [data-theme="dark"] .search-input {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border-secondary);
        }
        
        [data-theme="dark"] .script-line {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-primary);
        }
        
        [data-theme="dark"] .script-line:hover {
            background: var(--bg-quaternary);
        }
        
        [data-theme="dark"] .script-info {
            color: var(--text-secondary);
        }
        
        [data-theme="dark"] .empty-state {
            color: var(--text-tertiary);
        }
        
        [data-theme="dark"] .script-actions {
            background: var(--bg-tertiary);
            border-color: var(--border-primary);
        }
        
        [data-theme="dark"] .search-icon {
            color: var(--text-tertiary);
        }
        
        [data-theme="dark"] .command-name {
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .command-desc {
            color: var(--text-secondary);
        }
        
        [data-theme="dark"] .command-params {
            color: var(--text-tertiary);
        }
        
        [data-theme="dark"] .param-label {
            color: #d1d5db;
        }
        
        /* ÂºπÂá∫ÂºèÂëΩ‰ª§ÁºñËæëÂô® */
        .command-editor-overlay {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-primary);
            box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 2000;
            height: 50vh;
            overflow: hidden;
        }
        
        .command-editor-overlay.show {
            transform: translateY(0);
        }
        
        .command-editor-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-tertiary);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .command-editor-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .command-editor-actions-header {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .command-editor-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .command-editor-close:hover {
            background: var(--bg-quaternary);
        }
        
        .command-editor-content {
            height: calc(50vh - 80px);
            overflow-y: auto;
            padding: 24px;
        }
        
        .command-editor-three-column {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 24px;
            height: 100%;
        }
        
        .command-editor-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .command-editor-column-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-primary);
            margin-bottom: 8px;
        }
        
        .command-editor-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .command-editor-label {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .command-editor-input {
            padding: 12px 16px;
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color 0.2s;
            width: 100%;
        }
        
        .command-editor-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .command-editor-textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        /* Markdown È¢ÑËßàÊ†∑Âºè */
        .markdown-preview {
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            background: var(--bg-secondary);
            padding: 12px 16px;
            min-height: 120px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .markdown-preview-content h1,
        .markdown-preview-content h2,
        .markdown-preview-content h3,
        .markdown-preview-content h4,
        .markdown-preview-content h5,
        .markdown-preview-content h6 {
            margin: 16px 0 8px 0;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .markdown-preview-content h1 { font-size: 1.5em; }
        .markdown-preview-content h2 { font-size: 1.3em; }
        .markdown-preview-content h3 { font-size: 1.1em; }
        .markdown-preview-content h4 { font-size: 1em; }
        
        .markdown-preview-content p {
            margin: 8px 0;
            color: var(--text-primary);
        }
        
        .markdown-preview-content code {
            background: var(--bg-tertiary);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: var(--text-primary);
        }
        
        .markdown-preview-content pre {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 12px 0;
        }
        
        .markdown-preview-content pre code {
            background: none;
            padding: 0;
        }
        
        .markdown-preview-content ul,
        .markdown-preview-content ol {
            margin: 8px 0;
            padding-left: 20px;
            color: var(--text-primary);
        }
        
        .markdown-preview-content li {
            margin: 4px 0;
        }
        
        .markdown-preview-content blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 12px;
            margin: 12px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .markdown-preview-content strong {
            font-weight: 600;
        }
        
        .markdown-preview-content em {
            font-style: italic;
        }
        
        /* Markdown Ë°®Ê†ºÊ†∑Âºè */
        .markdown-preview-content .markdown-table,
        .command-desc-rendered .markdown-table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
            font-size: 12px;
            border: 1px solid var(--border-secondary);
        }
        
        .markdown-preview-content .markdown-table th,
        .markdown-preview-content .markdown-table td,
        .command-desc-rendered .markdown-table th,
        .command-desc-rendered .markdown-table td {
            border: 1px solid var(--border-secondary);
            padding: 6px 8px;
            text-align: left;
        }
        
        .markdown-preview-content .markdown-table th,
        .command-desc-rendered .markdown-table th {
            background-color: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .markdown-preview-content .markdown-table td,
        .command-desc-rendered .markdown-table td {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .markdown-preview-content .markdown-table tr:nth-child(even) td,
        .command-desc-rendered .markdown-table tr:nth-child(even) td {
            background-color: var(--bg-tertiary);
        }
        
        .markdown-preview-content .markdown-table tr:hover td,
        .command-desc-rendered .markdown-table tr:hover td {
            background-color: var(--bg-quaternary);
        }
        
        /* Ê∑±Ëâ≤‰∏ªÈ¢ò‰∏ãÁöÑË°®Ê†ºÊ†∑Âºè‰ºòÂåñ */
        [data-theme="dark"] .markdown-preview-content .markdown-table td,
        [data-theme="dark"] .command-desc-rendered .markdown-table td {
            background-color: var(--bg-tertiary); /* ÊâÄÊúâÂçïÂÖÉÊ†º‰ΩøÁî®‰∏éË°®Â§¥Áõ∏ÂêåÁöÑÈ¢úËâ≤ */
        }
        
        [data-theme="dark"] .markdown-preview-content .markdown-table tr:nth-child(even) td,
        [data-theme="dark"] .command-desc-rendered .markdown-table tr:nth-child(even) td {
            background-color: var(--bg-tertiary); /* Èó¥ÈöîË°å‰πü‰ΩøÁî®Áõ∏ÂêåÈ¢úËâ≤ÔºåÂéªÊéâÊñëÈ©¨Á∫π */
        }
        
        /* ÂëΩ‰ª§ÊèèËø∞Ê∏≤ÊüìÊ†∑Âºè */
        .command-info {
            margin-bottom: 16px;
        }
        
        .command-info h3 {
            font-weight: 600;
            margin: 0 0 8px 0;
            color: var(--text-primary);
        }
        
        .command-desc-rendered {
            line-height: 1.5;
            font-size: 12px;
            color: var(--text-secondary);
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .command-desc-rendered.collapsed {
            max-height: 120px;
        }
        
        .command-desc-rendered.expanded {
            max-height: none;
        }
        
        .command-desc-toggle {
            display: inline-flex;
            align-items: center;
            margin-top: 4px;
            font-size: 11px;
            color: var(--text-tertiary);
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
        }
        
        .command-desc-toggle:hover {
            color: var(--text-secondary);
        }
        
        .command-desc-toggle-icon {
            margin-left: 4px;
            transition: transform 0.2s;
            font-size: 10px;
        }
        
        .command-desc-toggle.expanded .command-desc-toggle-icon {
            transform: rotate(180deg);
        }
        
        .command-desc-rendered h1,
        .command-desc-rendered h2,
        .command-desc-rendered h3,
        .command-desc-rendered h4,
        .command-desc-rendered h5,
        .command-desc-rendered h6 {
            margin: 12px 0 6px 0;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .command-desc-rendered h1 { font-size: 1.1em; }
        .command-desc-rendered h2 { font-size: 1.05em; }
        .command-desc-rendered h3 { font-size: 1em; }
        .command-desc-rendered h4 { font-size: 0.95em; }
        
        .command-desc-rendered p {
            margin: 6px 0;
            color: var(--text-primary);
        }
        
        .command-desc-rendered code {
            background: var(--bg-tertiary);
            padding: 1px 3px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: var(--text-primary);
        }
        
        .command-desc-rendered pre {
            background: var(--bg-tertiary);
            padding: 8px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 8px 0;
            font-size: 0.9em;
        }
        
        .command-desc-rendered pre code {
            background: none;
            padding: 0;
        }
        
        .command-desc-rendered ul,
        .command-desc-rendered ol {
            margin: 6px 0;
            padding-left: 16px;
            color: var(--text-primary);
        }
        
        .command-desc-rendered li {
            margin: 2px 0;
        }
        
        .command-desc-rendered blockquote {
            border-left: 3px solid #3b82f6;
            padding-left: 8px;
            margin: 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .command-desc-rendered strong {
            font-weight: 600;
        }
        
        .command-desc-rendered em {
            font-style: italic;
        }
        
        .command-editor-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .command-editor-btn.primary {
            background: #10b981;
            color: white;
        }
        
        .command-editor-btn.primary:hover {
            background: #059669;
        }
        
        .command-editor-btn.secondary {
            background: #6b7280;
            color: white;
        }
        
        .command-editor-btn.secondary:hover {
            background: #4b5563;
        }
        
        /* ÁºñËæëÁä∂ÊÄÅ‰∏ã‰øùÊåÅÁôΩËâ≤ËÉåÊôØ */
        .script-line.editing {
            background: #fff !important;
            border: 2px solid #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* ÂèÇÊï∞ÂÆö‰πâÂå∫Ê†∑Âºè */
        .parameter-definitions {
            margin-bottom: 12px;
        }
        
        .parameter-row {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            margin-bottom: 8px;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            border: 1px solid var(--border-secondary);
        }
        
        .parameter-row-field {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .parameter-row-field.description {
            flex: 2;
        }
        
        .parameter-row-field.options {
            flex: 1;
        }
        
        .parameter-row-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }
        
        .parameter-row-input {
            padding: 10px 12px;
            border: 1px solid var(--border-secondary);
            border-radius: 4px;
            font-size: 13px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color 0.2s;
            width: 100%;
        }
        
        .parameter-row-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        .parameter-row-remove {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 10px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 22px;
            min-width: 32px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        
        .parameter-row-remove:hover {
            background: #dc2626;
        }
        
        .add-parameter-btn {
            width: 100%;
            margin-top: 8px;
        }
        
        /* ÂèÇÊï∞ÈÖçÁΩÆÂå∫Ê†∑Âºè */
        .param-dual-select {
            display: flex;
            gap: 8px;
        }
        
        .param-dual-select .param-input {
            flex: 1;
            width: 50%;
        }
        
        .examples-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-secondary);
        }
        
        .example-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            border: 1px solid var(--border-secondary);
        }
        
        .example-command {
            flex: 1;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--text-primary);
            background: transparent;
            padding: 0;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- È°∂ÈÉ®Â∑•ÂÖ∑Ê†è -->
        <div class="toolbar">
            <div class="toolbar-left">
                <h1>LIGGGHTS ÂèØËßÜÂåñÁïåÈù¢</h1>
                <button class="btn btn-primary">‚ûï Êñ∞Âª∫</button>
                <button class="btn btn-gray">üìÅ ÊâìÂºÄ</button>
                <button class="btn btn-gray">üíæ ‰øùÂ≠ò</button>
                <button class="btn btn-primary" onclick="importCommands()">üì¶ ÂØºÂÖ•ÂëΩ‰ª§</button>
            </div>
            <div class="toolbar-right">
                <button class="btn btn-gray" id="languageToggle" onclick="toggleLanguage()">üåê EN</button>
                <button class="btn btn-gray" id="themeToggle" onclick="toggleTheme()">üåô ÊöóËâ≤</button>
                <button class="btn btn-primary" onclick="importScript()">üì• ÂØºÂÖ•ËÑöÊú¨</button>
                <button class="btn btn-green" onclick="exportScript()">‚¨áÔ∏è ÂØºÂá∫ËÑöÊú¨</button>
                <button class="btn btn-green" id="runBtn">‚ñ∂Ô∏è ËøêË°å</button>
            </div>
        </div>

        <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫ -->
        <div class="main-content">
            <!-- Â∑¶‰æßÂëΩ‰ª§ÈÄâÊã©Âå∫ -->
            <div class="commands-panel">
                <!-- ÊêúÁ¥¢Ê†è -->
                <div class="search-bar">
                    <h2>ÂëΩ‰ª§ÂÆö‰πâ</h2>
                    <div class="search-wrapper">
                        <svg class="search-icon" width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                        <input type="text" id="searchInput" class="search-input" placeholder="ÊêúÁ¥¢ÂëΩ‰ª§...">
                        <button class="search-clear" id="searchClear" onclick="clearSearch()">√ó</button>
                    </div>
                </div>

                <!-- Ê®™ÂêëÊ†áÁ≠æÈ°µ -->
                <div class="tabs" id="tabs">
                    <button class="tab active tab-color-blue" data-category="ÂàùÂßãËÆæÁΩÆ">
                        <span class="tab-text">ÂàùÂßãËÆæÁΩÆ</span>
                        <span class="tab-count">0</span>
                    </button>
                    <button class="tab tab-color-green" data-category="Âá†‰ΩïÂÆö‰πâ">
                        <span class="tab-text">Âá†‰ΩïÂÆö‰πâ</span>
                        <span class="tab-count">0</span>
                    </button>
                    <button class="tab tab-color-purple" data-category="ÊùêÊñôÂ±ûÊÄß">
                        <span class="tab-text">ÊùêÊñôÂ±ûÊÄß</span>
                        <span class="tab-count">0</span>
                    </button>
                    <button class="tab tab-color-orange" data-category="È¢óÁ≤íËÆæÁΩÆ">
                        <span class="tab-text">È¢óÁ≤íËÆæÁΩÆ</span>
                        <span class="tab-count">0</span>
                    </button>
                    <button class="tab tab-color-red" data-category="Ê±ÇËß£ÊéßÂà∂">
                        <span class="tab-text">Ê±ÇËß£ÊéßÂà∂</span>
                        <span class="tab-count">0</span>
                    </button>
                    <button class="tab tab-color-indigo" data-category="ËæìÂá∫ÊéßÂà∂">
                        <span class="tab-text">ËæìÂá∫ÊéßÂà∂</span>
                        <span class="tab-count">0</span>
                    </button>
                    <button class="tab tab-color-gray" data-category="ÂÖ∂ÂÆÉËÆæÁΩÆ">
                        <span class="tab-text">ÂÖ∂ÂÆÉËÆæÁΩÆ</span>
                        <span class="tab-count">0</span>
                    </button>
                </div>

                <!-- ÂëΩ‰ª§ÁΩëÊ†º -->
                <div class="commands-grid">
                    <div class="commands-container" id="commandsContainer">
                        <!-- ÂëΩ‰ª§Âç°ÁâáÂ∞ÜÈÄöËøá JavaScript Âä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
            </div>

            <!-- ‰∏≠Â§ÆÂèÇÊï∞ÈÖçÁΩÆÂå∫ -->
            <div class="params-panel">
                <div class="params-header">
                    <h2>ÂèÇÊï∞ÈÖçÁΩÆ</h2>
                    <button class="param-reset-btn" id="paramResetBtn" onclick="clearAllDualParameters()" title="">
                        <span class="reset-icon">üîÑ</span>
                    </button>
                </div>
                <div class="params-content" id="paramsContent">
                    <div class="empty-state">
                        <div class="empty-icon">‚öôÔ∏è</div>
                        <p>ËØ∑‰ªéÂ∑¶‰æßÈÄâÊã©‰∏Ä‰∏™ÂëΩ‰ª§ÂºÄÂßãÈÖçÁΩÆ</p>
                    </div>
                </div>
            </div>

            <!-- Âè≥‰æßËÑöÊú¨È¢ÑËßà -->
            <div class="script-panel">
                <div class="script-header">
                    <h2>ËÑöÊú¨È¢ÑËßà</h2>
                    <div class="script-info">
                        <button class="btn btn-primary" onclick="insertNewLine()" title="Âú®Êú´Â∞æÊèíÂÖ•Êñ∞Ë°å">‚ûï ÊèíÂÖ•</button>
                        <button class="btn btn-red" onclick="undoLastChange()" id="undoBtn" disabled title="Êí§ÈîÄ‰∏äÊ¨°Êìç‰Ωú">‚Ü∂ Êí§ÈîÄ</button>
                        <button class="btn btn-gray" onclick="clearScript()" title="Ê∏ÖÁ©∫ÊâÄÊúâËÑöÊú¨">üóëÔ∏è Ê∏ÖÁ©∫</button>
                        <div style="width: 1px; height: 16px; background: var(--border-primary); margin: 0 4px;"></div>
                        <span>üìÑ</span>
                        <span id="lineCount">0 Ë°å</span>
                    </div>
                </div>
                <div class="script-content" id="scriptContent">
                    <div class="empty-state">
                        <div class="empty-icon">üëÅÔ∏è</div>
                        <p>ËÑöÊú¨Â∞ÜÂú®ËøôÈáåÊòæÁ§∫</p>
                        <p style="font-size: 12px; margin-top: 8px; color: #9ca3af;">Ê∑ªÂä†ÂëΩ‰ª§ÂêéÂç≥ÂèØÈ¢ÑËßà</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÂëΩ‰ª§ÁºñËæëÂô®Ë¶ÜÁõñÂ±Ç -->
    <div class="command-editor-overlay" id="commandEditorOverlay">
        <div class="command-editor-header">
            <h3 class="command-editor-title" id="commandEditorTitle">Êñ∞Âª∫ÂëΩ‰ª§</h3>
            <div class="command-editor-actions-header">
                <button class="command-editor-btn secondary" onclick="hideCommandEditor()">ÂèñÊ∂à</button>
                <button class="command-editor-btn primary" onclick="saveUserCommand()">‰øùÂ≠ò</button>
                <button class="command-editor-close" onclick="hideCommandEditor()">√ó</button>
            </div>
        </div>
        <div class="command-editor-content">
            <div class="command-editor-three-column">
                <!-- Á¨¨‰∏ÄÊ†èÔºöÂëΩ‰ª§ÂêçÁß∞ÂíåÊèèËø∞ -->
                <div class="command-editor-column">
                    <h4 class="command-editor-column-title">ÂëΩ‰ª§‰ø°ÊÅØ</h4>
                    
                    <div class="command-editor-field">
                        <label class="command-editor-label">ÂëΩ‰ª§ÂêçÁß∞</label>
                        <input type="text" class="command-editor-input" id="commandNameInput" placeholder="ËØ∑ËæìÂÖ•ÂëΩ‰ª§ÂêçÁß∞" required>
                    </div>
                    
                    <div class="command-editor-field">
                        <label class="command-editor-label">ÂëΩ‰ª§ÊèèËø∞</label>
                        <textarea class="command-editor-input command-editor-textarea" id="commandDescInput" placeholder="ËØ∑ËæìÂÖ•ÂëΩ‰ª§ÊèèËø∞" rows="5"></textarea>
                    </div>
                </div>
                
                <!-- Á¨¨‰∫åÊ†èÔºöÂèÇÊï∞ÂÆö‰πâ -->
                <div class="command-editor-column">
                    <h4 class="command-editor-column-title">ÂèÇÊï∞ÂÆö‰πâ</h4>
                    
                    <div class="parameter-definitions" id="parameterDefinitions">
                        <!-- Âä®ÊÄÅÂèÇÊï∞Ë°åÂ∞ÜÂú®ËøôÈáåÊèíÂÖ• -->
                    </div>
                    <button type="button" class="command-editor-btn secondary" onclick="addParameterRow()" style="width: 100%;">‚ûï Ê∑ªÂä†ÂèÇÊï∞</button>
                </div>
                
                <!-- Á¨¨‰∏âÊ†èÔºöÁ§∫‰æãÂëΩ‰ª§ -->
                <div class="command-editor-column">
                    <h4 class="command-editor-column-title">Á§∫‰æãÂëΩ‰ª§</h4>
                    
                    <div class="command-editor-field">
                        <label class="command-editor-label">ÂëΩ‰ª§Á§∫‰æã (ÊØèË°å‰∏Ä‰∏™ÂÆåÊï¥ÂëΩ‰ª§)</label>
                        <textarea class="command-editor-input command-editor-textarea" id="commandExamplesInput" placeholder="ËØ∑ËæìÂÖ•Á§∫‰æãÂëΩ‰ª§ÔºåÊØèË°å‰∏Ä‰∏™&#10;‰æãÂ¶ÇÔºö&#10;fix grav all gravity 9.81 vector 0 0 -1&#10;fix grav_x all gravity 5.0 vector 1 0 0" rows="8"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ËØ≠Ë®ÄÊîØÊåÅ
        let currentLanguage = localStorage.getItem('language') || 'zh';
        
        const translations = {
            zh: {
                title: 'LIGGGHTS ÂèØËßÜÂåñÁïåÈù¢',
                newProject: '‚ûï Êñ∞Âª∫',
                open: 'üìÅ ÊâìÂºÄ',
                save: 'üíæ ‰øùÂ≠ò',
                importCommands: 'üì¶ ÂØºÂÖ•ÂëΩ‰ª§',
                language: 'üåê EN',
                theme: 'üåô ÊöóËâ≤',
                themeLight: '‚òÄÔ∏è ‰∫ÆËâ≤',
                importScript: 'üì• ÂØºÂÖ•ËÑöÊú¨',
                exportScript: '‚¨áÔ∏è ÂØºÂá∫ËÑöÊú¨',
                run: '‚ñ∂Ô∏è ËøêË°å',
                stop: '‚è∏Ô∏è ÂÅúÊ≠¢',
                searchPlaceholder: 'ÊêúÁ¥¢ÂëΩ‰ª§...',
                commandDefinition: 'ÂëΩ‰ª§ÂÆö‰πâ',
                paramConfig: 'ÂèÇÊï∞ÈÖçÁΩÆ',
                scriptPreview: 'ËÑöÊú¨È¢ÑËßà',
                insert: '‚ûï ÊèíÂÖ•',
                undo: '‚Ü∂ Êí§ÈîÄ',
                clear: 'üóëÔ∏è Ê∏ÖÁ©∫',
                lines: 'Ë°å',
                selectCommand: 'ËØ∑‰ªéÂ∑¶‰æßÈÄâÊã©‰∏Ä‰∏™ÂëΩ‰ª§ÂºÄÂßãÈÖçÁΩÆ',
                scriptEmpty: 'ËÑöÊú¨Â∞ÜÂú®ËøôÈáåÊòæÁ§∫',
                addAfterCommand: 'Ê∑ªÂä†ÂëΩ‰ª§ÂêéÂç≥ÂèØÈ¢ÑËßà',
                // ÂàÜÁ±ªÂêçÁß∞
                initSettings: 'ÂàùÂßãËÆæÁΩÆ',
                geometry: 'Âá†‰ΩïÂÆö‰πâ',
                materials: 'ÊùêÊñôÂ±ûÊÄß',
                particles: 'È¢óÁ≤íËÆæÁΩÆ',
                solver: 'Ê±ÇËß£ÊéßÂà∂',
                output: 'ËæìÂá∫ÊéßÂà∂',
                others: 'ÂÖ∂ÂÆÉËÆæÁΩÆ',
                // ÁºñËæëÂô®
                newCommand: 'Êñ∞Âª∫ÂëΩ‰ª§',
                editCommand: 'ÁºñËæëÂëΩ‰ª§',
                commandInfo: 'ÂëΩ‰ª§‰ø°ÊÅØ',
                commandName: 'ÂëΩ‰ª§ÂêçÁß∞',
                commandDesc: 'ÂëΩ‰ª§ÊèèËø∞',
                paramDef: 'ÂèÇÊï∞ÂÆö‰πâ',
                exampleCommands: 'Á§∫‰æãÂëΩ‰ª§',
                addParam: '‚ûï Ê∑ªÂä†ÂèÇÊï∞',
                cancel: 'ÂèñÊ∂à',
                saveCmd: '‰øùÂ≠ò',
                addToScript: 'ÁîüÊàêÂπ∂Ê∑ªÂä†Âà∞ËÑöÊú¨',
                expandDesc: 'Â±ïÂºÄÊèèËø∞',
                collapseDesc: 'Êî∂Ëµ∑ÊèèËø∞',
                // ÊèêÁ§∫‰ø°ÊÅØ
                dragHint: 'ÊãñÊãΩËÑöÊú¨Ë°åÂèØË∞ÉÊï¥ÊâßË°åÈ°∫Â∫è ‚Ä¢ ÂèåÂáªÂèØÁºñËæëÂÜÖÂÆπ ‚Ä¢ ‰∏çÂêåÈ¢úËâ≤Ë°®Á§∫‰∏çÂêåÊ≠•È™§',
                createProjectFirst: 'ËØ∑ÂÖàÂàõÂª∫ÊàñÊâìÂºÄ‰∏Ä‰∏™È°πÁõÆ',
                needProjectToSave: 'ÈúÄË¶ÅÈ°πÁõÆÊâçËÉΩ‰øùÂ≠òËá™ÂÆö‰πâÂëΩ‰ª§',
                clearParams: 'Ê∏ÖÁ©∫ÊâÄÊúâÂèÇÊï∞'
            },
            en: {
                title: 'LIGGGHTS Visual Interface',
                newProject: '‚ûï New Project',
                open: 'üìÅ Open',
                save: 'üíæ Save',
                importCommands: 'üì¶ Import Commands',
                language: 'üåê ‰∏≠Êñá',
                theme: 'üåô Dark',
                themeLight: '‚òÄÔ∏è Light',
                importScript: 'üì• Import Script',
                exportScript: '‚¨áÔ∏è Export Script',
                run: '‚ñ∂Ô∏è Run',
                stop: '‚è∏Ô∏è Stop',
                searchPlaceholder: 'Search commands...',
                commandDefinition: 'Command Definition',
                paramConfig: 'Parameter Configuration',
                scriptPreview: 'Script Preview',
                insert: '‚ûï Insert',
                undo: '‚Ü∂ Undo',
                clear: 'üóëÔ∏è Clear',
                lines: 'lines',
                selectCommand: 'Please select a command from the left to start configuration',
                scriptEmpty: 'Script will be displayed here',
                addAfterCommand: 'Preview available after adding commands',
                // ÂàÜÁ±ªÂêçÁß∞
                initSettings: 'Initialization',
                geometry: 'Geometry',
                materials: 'Materials',
                particles: 'Particles',
                solver: 'Solver',
                output: 'Output',
                others: 'Others',
                // ÁºñËæëÂô®
                newCommand: 'New Command',
                editCommand: 'Edit Command',
                commandInfo: 'Command Information',
                commandName: 'Command Name',
                commandDesc: 'Command Description',
                paramDef: 'Parameter Definition',
                exampleCommands: 'Example Commands',
                addParam: '‚ûï Add Parameter',
                cancel: 'Cancel',
                saveCmd: 'Save',
                addToScript: 'Generate and Add to Script',
                expandDesc: 'Expand description',
                collapseDesc: 'Collapse description',
                // ÊèêÁ§∫‰ø°ÊÅØ
                dragHint: 'Drag script lines to reorder ‚Ä¢ Double-click to edit ‚Ä¢ Different colors represent different steps',
                createProjectFirst: 'Please create or open a project first',
                needProjectToSave: 'Project required to save custom commands',
                clearParams: 'Clear all parameters'
            }
        };

        // Ëé∑ÂèñÂΩìÂâçËØ≠Ë®ÄÁöÑÊñáÊú¨
        function t(key) {
            return translations[currentLanguage][key] || key;
        }

        // ÂàáÊç¢ËØ≠Ë®Ä
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'zh' ? 'en' : 'zh';
            localStorage.setItem('language', currentLanguage);
            updateLanguage();
        }

        // Êõ¥Êñ∞ÁïåÈù¢ËØ≠Ë®Ä
        function updateLanguage() {
            // Êõ¥Êñ∞È°µÈù¢Ê†áÈ¢ò
            document.title = t('title');
            
            // Êõ¥Êñ∞Â∑•ÂÖ∑Ê†è
            document.querySelector('.toolbar h1').textContent = t('title');
            document.querySelector('.btn-primary').innerHTML = t('newProject');
            document.querySelectorAll('.btn-gray')[0].innerHTML = t('open');
            document.querySelectorAll('.btn-gray')[1].innerHTML = t('save');
            document.querySelector('[onclick="importCommands()"]').innerHTML = t('importCommands');
            
            // Êõ¥Êñ∞ËØ≠Ë®ÄÊåâÈíÆ
            document.getElementById('languageToggle').innerHTML = t('language');
            updateThemeButton();
            
            document.querySelector('[onclick="importScript()"]').innerHTML = t('importScript');
            document.querySelector('[onclick="exportScript()"]').innerHTML = t('exportScript');
            updateRunButton();
            
            // Êõ¥Êñ∞ÊêúÁ¥¢Ê°Ü
            document.getElementById('searchInput').placeholder = t('searchPlaceholder');
            
            // Êõ¥Êñ∞ÂëΩ‰ª§ÂÆö‰πâÊ†áÈ¢ò
            document.querySelector('.search-bar h2').textContent = t('commandDefinition');
            
            // Êõ¥Êñ∞Ê†áÁ≠æÈ°µ
            updateTabs();
            
            // Êõ¥Êñ∞ÂèÇÊï∞ÈÖçÁΩÆÂå∫Âüü
            document.querySelector('.params-header h2').textContent = t('paramConfig');
            
            // Êõ¥Êñ∞ËÑöÊú¨È¢ÑËßàÂå∫Âüü
            document.querySelector('.script-header h2').textContent = t('scriptPreview');
            document.querySelector('[onclick="insertNewLine()"]').innerHTML = t('insert');
            document.querySelector('[onclick="clearScript()"]').innerHTML = t('clear');
            
            // Êõ¥Êñ∞Á©∫Áä∂ÊÄÅÊñáÊú¨
            updateEmptyStates();
            
            // Êõ¥Êñ∞ÂëΩ‰ª§ÁºñËæëÂô®
            updateCommandEditor();
            
            // Êõ¥Êñ∞ÈáçÁΩÆÊåâÈíÆÊ†áÈ¢ò
            const resetBtn = document.getElementById('paramResetBtn');
            if (resetBtn) {
                resetBtn.title = t('clearParams');
            }
            
            // ÈáçÊñ∞Ê∏≤ÊüìÂëΩ‰ª§ÂíåËÑöÊú¨
            renderCommands();
            renderParameterForm();
            renderScript();
        }

        // Êõ¥Êñ∞Ê†áÁ≠æÈ°µ
        function updateTabs() {
            const categories = [
                { key: 'initSettings', dataCategory: 'ÂàùÂßãËÆæÁΩÆ' },
                { key: 'geometry', dataCategory: 'Âá†‰ΩïÂÆö‰πâ' },
                { key: 'materials', dataCategory: 'ÊùêÊñôÂ±ûÊÄß' },
                { key: 'particles', dataCategory: 'È¢óÁ≤íËÆæÁΩÆ' },
                { key: 'solver', dataCategory: 'Ê±ÇËß£ÊéßÂà∂' },
                { key: 'output', dataCategory: 'ËæìÂá∫ÊéßÂà∂' },
                { key: 'others', dataCategory: 'ÂÖ∂ÂÆÉËÆæÁΩÆ' }
            ];
            
            const tabs = document.querySelectorAll('.tab');
            categories.forEach((cat, index) => {
                if (tabs[index]) {
                    const currentCount = tabs[index].querySelector('.tab-count')?.textContent || '0';
                    tabs[index].innerHTML = `<span class="tab-text">${t(cat.key)}</span><span class="tab-count">${currentCount}</span>`;
                }
            });
            
            // Êõ¥Êñ∞ËÆ°Êï∞
            updateTabCounts();
        }
        
        // Êõ¥Êñ∞Ê†áÁ≠æËÆ°Êï∞
        function updateTabCounts() {
            const categories = ['ÂàùÂßãËÆæÁΩÆ', 'Âá†‰ΩïÂÆö‰πâ', 'ÊùêÊñôÂ±ûÊÄß', 'È¢óÁ≤íËÆæÁΩÆ', 'Ê±ÇËß£ÊéßÂà∂', 'ËæìÂá∫ÊéßÂà∂', 'ÂÖ∂ÂÆÉËÆæÁΩÆ'];
            const tabs = document.querySelectorAll('.tab');
            
            categories.forEach((category, index) => {
                const commandCount = userCommands[category] ? Object.keys(userCommands[category]).length : 0;
                const countElement = tabs[index]?.querySelector('.tab-count');
                if (countElement) {
                    countElement.textContent = commandCount;
                }
            });
        }

        // Êõ¥Êñ∞ËøêË°åÊåâÈíÆ
        function updateRunButton() {
            const runBtn = document.getElementById('runBtn');
            if (runBtn.textContent.includes('ËøêË°å') || runBtn.textContent.includes('Run')) {
                runBtn.innerHTML = t('run');
            } else {
                runBtn.innerHTML = t('stop');
            }
        }

        // Êõ¥Êñ∞Á©∫Áä∂ÊÄÅ
        function updateEmptyStates() {
            // Ëøô‰∏™ÂáΩÊï∞Â∞ÜÂú®Ê∏≤ÊüìÂáΩÊï∞‰∏≠‰ΩøÁî®ÔºåÁ°Æ‰øùÁ©∫Áä∂ÊÄÅÊñáÊú¨‰ΩøÁî®Ê≠£Á°ÆÁöÑËØ≠Ë®Ä
        }

        // Êõ¥Êñ∞ÂëΩ‰ª§ÁºñËæëÂô®ÊñáÊú¨
        function updateCommandEditor() {
            // Êõ¥Êñ∞ÁºñËæëÂô®ÈùôÊÄÅÊñáÊú¨
            const cancelBtns = document.querySelectorAll('.command-editor-btn.secondary');
            const saveBtns = document.querySelectorAll('.command-editor-btn.primary');
            
            cancelBtns.forEach(btn => {
                if (btn.textContent.includes('ÂèñÊ∂à') || btn.textContent.includes('Cancel')) {
                    btn.textContent = t('cancel');
                }
                if (btn.textContent.includes('Ê∑ªÂä†ÂèÇÊï∞') || btn.textContent.includes('Add Parameter')) {
                    btn.innerHTML = t('addParam');
                }
            });
            
            saveBtns.forEach(btn => {
                if (btn.textContent.includes('‰øùÂ≠ò') || btn.textContent.includes('Save')) {
                    btn.textContent = t('saveCmd');
                }
            });

            // Êõ¥Êñ∞ÂàóÊ†áÈ¢ò
            const columnTitles = document.querySelectorAll('.command-editor-column-title');
            if (columnTitles[0]) columnTitles[0].textContent = t('commandInfo');
            if (columnTitles[1]) columnTitles[1].textContent = t('paramDef');
            if (columnTitles[2]) columnTitles[2].textContent = t('exampleCommands');

            // Êõ¥Êñ∞ËæìÂÖ•Ê°ÜÊ†áÁ≠æ
            const labels = document.querySelectorAll('.command-editor-label');
            if (labels[0]) labels[0].textContent = t('commandName');
            if (labels[1]) labels[1].textContent = t('commandDesc');
            if (labels[2]) labels[2].textContent = currentLanguage === 'zh' ? 'ÂëΩ‰ª§Á§∫‰æã (ÊØèË°å‰∏Ä‰∏™ÂÆåÊï¥ÂëΩ‰ª§)' : 'Command Examples (one per line)';

            // Êõ¥Êñ∞placeholders
            const nameInput = document.getElementById('commandNameInput');
            const descInput = document.getElementById('commandDescInput');
            const examplesInput = document.getElementById('commandExamplesInput');
            
            if (nameInput) nameInput.placeholder = currentLanguage === 'zh' ? 'ËØ∑ËæìÂÖ•ÂëΩ‰ª§ÂêçÁß∞' : 'Enter command name';
            if (descInput) descInput.placeholder = currentLanguage === 'zh' ? 'ËØ∑ËæìÂÖ•ÂëΩ‰ª§ÊèèËø∞' : 'Enter command description';
            if (examplesInput) {
                examplesInput.placeholder = currentLanguage === 'zh' ? 
                    'ËØ∑ËæìÂÖ•Á§∫‰æãÂëΩ‰ª§ÔºåÊØèË°å‰∏Ä‰∏™\n‰æãÂ¶ÇÔºö\nfix grav all gravity 9.81 vector 0 0 -1\nfix grav_x all gravity 5.0 vector 1 0 0' :
                    'Enter example commands, one per line\nFor example:\nfix grav all gravity 9.81 vector 0 0 -1\nfix grav_x all gravity 5.0 vector 1 0 0';
            }
            

        }

        // ‰∏ªÈ¢òÂàáÊç¢ÂäüËÉΩ
        let currentTheme = localStorage.getItem('theme') || 'light';
        
        // ÂàùÂßãÂåñ‰∏ªÈ¢ò
        function initTheme() {
            document.documentElement.setAttribute('data-theme', currentTheme);
            updateThemeButton();
        }
        
        // ÂàáÊç¢‰∏ªÈ¢ò
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            updateThemeButton();
        }
        
        // Êõ¥Êñ∞‰∏ªÈ¢òÊåâÈíÆÊñáÊú¨
        function updateThemeButton() {
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                if (currentTheme === 'dark') {
                    themeToggle.innerHTML = t('themeLight');
                } else {
                    themeToggle.innerHTML = t('theme');
                }
            }
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ‰∏ªÈ¢òÂíåËØ≠Ë®Ä
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            updateLanguage();
        });

        // ÂëΩ‰ª§Êï∞ÊçÆ
        const commandCategories = {
            'ÂàùÂßãËÆæÁΩÆ': [
                { name: 'dimension', desc: 'ËÆæÁΩÆÁª¥Â∫¶', params: ['dimension'] },
                { name: 'units', desc: 'ËÆæÁΩÆÂçï‰ΩçÁ≥ªÁªü', params: ['units'] },
                { name: 'atom_style', desc: 'ÂéüÂ≠êÁ±ªÂûã', params: ['style'] },
                { name: 'boundary', desc: 'ËæπÁïåÊù°‰ª∂', params: ['x', 'y', 'z'] },
                { name: 'newton', desc: 'ÁâõÈ°øÁ¨¨‰∏âÂÆöÂæã', params: ['on/off'] }
            ],
            'Âá†‰ΩïÂÆö‰πâ': [
                { name: 'region', desc: 'ÂÆö‰πâÂå∫Âüü', params: ['ID', 'type', 'args'] },
                { name: 'create_box', desc: 'ÂàõÂª∫Ê®°ÊãüÁõíÂ≠ê', params: ['N', 'region-ID'] },
                { name: 'create_atoms', desc: 'ÂàõÂª∫ÂéüÂ≠ê', params: ['type', 'style', 'args'] },
                { name: 'lattice', desc: 'Êô∂Ê†ºËÆæÁΩÆ', params: ['style', 'scale'] }
            ],
            'ÊùêÊñôÂ±ûÊÄß': [
                { name: 'pair_style', desc: 'ÂØπÂäøÂáΩÊï∞', params: ['style', 'args'] },
                { name: 'pair_coeff', desc: 'ÂØπÂäøÁ≥ªÊï∞', params: ['I', 'J', 'args'] },
                { name: 'fix wall/gran', desc: 'Â£ÅÈù¢ËÆæÁΩÆ', params: ['ID', 'group', 'style'] }
            ],
            'È¢óÁ≤íËÆæÁΩÆ': [
                { name: 'fix insert', desc: 'È¢óÁ≤íÊèíÂÖ•', params: ['ID', 'group', 'style'] },
                { name: 'fix gravity', desc: 'ÈáçÂäõËÆæÁΩÆ', params: ['ID', 'group', 'gravity'] },
                { name: 'fix nve/sphere', desc: 'ÁêÉÂΩ¢È¢óÁ≤íÁßØÂàÜ', params: ['ID', 'group'] }
            ],
            'Ê±ÇËß£ÊéßÂà∂': [
                { name: 'timestep', desc: 'Êó∂Èó¥Ê≠•Èïø', params: ['dt'] },
                { name: 'run', desc: 'ËøêË°åÊ≠•Êï∞', params: ['N'] },
                { name: 'minimize', desc: 'ËÉΩÈáèÊúÄÂ∞èÂåñ', params: ['etol', 'ftol', 'maxiter', 'maxeval'] },
                { name: 'reset_timestep', desc: 'ÈáçÁΩÆÊó∂Èó¥Ê≠•', params: ['N'] }
            ],
            'ËæìÂá∫ÊéßÂà∂': [
                { name: 'dump', desc: 'ËæìÂá∫dumpÊñá‰ª∂', params: ['ID', 'group', 'style', 'N', 'file'] },
                { name: 'thermo', desc: 'ÁÉ≠ÂäõÂ≠¶ËæìÂá∫', params: ['N'] },
                { name: 'thermo_style', desc: 'ËæìÂá∫Ê†ºÂºè', params: ['style', 'args'] }
            ]
        };

        // ÂèÇÊï∞Ê®°Êùø
        const parameterTemplates = {
            'dimension': { dimension: { type: 'select', options: ['2', '3'], default: '3' } },
            'units': { units: { type: 'select', options: ['lj', 'real', 'metal', 'si', 'cgs'], default: 'si' } },
            'atom_style': { style: { type: 'select', options: ['atomic', 'sphere', 'granular'], default: 'granular' } },
            'timestep': { dt: { type: 'number', default: '0.00001', step: '0.00001' } },
            'run': { N: { type: 'number', default: '10000', step: '1000' } }
        };

        // ÂÖ®Â±ÄÁä∂ÊÄÅ
        let activeCategory = 'ÂàùÂßãËÆæÁΩÆ';
        let selectedCommand = null;
        let scriptLines = [];
        let parameters = {};
        let currentProject = null; // ÂΩìÂâçÈ°πÁõÆ‰ø°ÊÅØ
        let projectName = ''; // È°πÁõÆÂêçÁß∞
        let currentFileHandle = null; // ÂΩìÂâçÊñá‰ª∂Âè•ÊüÑ
        let previousScriptState = null; // ‰∏ä‰∏ÄÊ¨°ËÑöÊú¨Áä∂ÊÄÅÔºàÁî®‰∫éÊí§ÈîÄÔºâ
        let commandPositions = {}; // ÊØè‰∏™ÂàÜÁ±ªÁöÑÂëΩ‰ª§‰ΩçÁΩÆÔºàÁΩëÊ†ºÂùêÊ†áÔºâ
        let userCommands = {}; // Áî®Êà∑Ëá™ÂÆö‰πâÂëΩ‰ª§Â∫ì
        // ÂëΩ‰ª§ÁºñËæëÂô®Áä∂ÊÄÅ
        let currentEditingCommandId = null;
        let currentEditingPosition = null;
        
        // Markdown Ëß£ÊûêÂíåÈ¢ÑËßàÂäüËÉΩ
        function parseMarkdown(markdown) {
            if (!markdown || markdown.trim() === '') {
                return '<p style="color: #9ca3af; font-style: italic;">ÊöÇÊó†ÊèèËø∞</p>';
            }
            
            let html = markdown;
            
            // È¢ÑÂ§ÑÁêÜÔºöËΩ¨‰πâHTMLÁâπÊÆäÂ≠óÁ¨¶ÔºàÈô§‰∫ÜÊàë‰ª¨Ë¶ÅÂ§ÑÁêÜÁöÑmarkdownËØ≠Ê≥ïÔºâ
            html = html.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            // Â§ÑÁêÜ‰ª£Á†ÅÂùó ```code``` ÔºàÂÖàÂ§ÑÁêÜÔºåÈÅøÂÖçÂÜÖÂÆπË¢´ÂÖ∂‰ªñËßÑÂàôÂΩ±ÂìçÔºâ
            html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            
            // Â§ÑÁêÜË°åÂÜÖ‰ª£Á†Å `code`
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Â§ÑÁêÜÊ†áÈ¢ò (# ## ### #### ##### ######)
            html = html.replace(/^######\s+(.+)$/gm, '<h6>$1</h6>');
            html = html.replace(/^#####\s+(.+)$/gm, '<h5>$1</h5>');
            html = html.replace(/^####\s+(.+)$/gm, '<h4>$1</h4>');
            html = html.replace(/^###\s+(.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^##\s+(.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^#\s+(.+)$/gm, '<h1>$1</h1>');
            
            // Â§ÑÁêÜÂºïÁî® > text
            html = html.replace(/^&gt;\s+(.+)$/gm, '<blockquote>$1</blockquote>');
            
            // Â§ÑÁêÜÁ≤ó‰Ωì **text** Êàñ __text__
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');
            
            // Â§ÑÁêÜÊñú‰Ωì *text* Êàñ _text_ (ÈÅøÂÖç‰∏éÂàóË°®ÂÜ≤Á™Å)
            html = html.replace(/(?<!\*)(\*)(?!\*)([^*]+)\1/g, '<em>$2</em>');
            html = html.replace(/(?<!_)(_)(?!_)([^_]+)\1/g, '<em>$2</em>');
            
            // Â§ÑÁêÜË°®Ê†º
            html = parseMarkdownTables(html);
            
            // Â§ÑÁêÜÂàóË°®È°π
            const lines = html.split('\n');
            let inList = false;
            let listType = '';
            let processedLines = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const isUnorderedItem = /^[-*+]\s+(.+)$/.test(line);
                const isOrderedItem = /^\d+\.\s+(.+)$/.test(line);
                
                if (isUnorderedItem || isOrderedItem) {
                    const content = line.replace(/^[-*+\d.]\s+/, '');
                    const currentListType = isUnorderedItem ? 'ul' : 'ol';
                    
                    if (!inList) {
                        processedLines.push(`<${currentListType}>`);
                        inList = true;
                        listType = currentListType;
                    } else if (listType !== currentListType) {
                        processedLines.push(`</${listType}>`);
                        processedLines.push(`<${currentListType}>`);
                        listType = currentListType;
                    }
                    
                    processedLines.push(`<li>${content}</li>`);
                } else {
                    if (inList) {
                        processedLines.push(`</${listType}>`);
                        inList = false;
                        listType = '';
                    }
                    processedLines.push(line);
                }
            }
            
            if (inList) {
                processedLines.push(`</${listType}>`);
            }
            
            html = processedLines.join('\n');
            
            // Â§ÑÁêÜÊÆµËêΩ - ÂèåÊç¢Ë°åÂèòÊàêÊÆµËêΩÂàÜÈöî
            html = html.split('\n\n').map(paragraph => {
                paragraph = paragraph.trim();
                if (!paragraph) return '';
                if (paragraph.startsWith('<h') || paragraph.startsWith('<ul') || 
                    paragraph.startsWith('<ol') || paragraph.startsWith('<pre') || 
                    paragraph.startsWith('<blockquote') || paragraph.startsWith('<table')) {
                    return paragraph;
                }
                return `<p>${paragraph.replace(/\n/g, '<br>')}</p>`;
            }).filter(p => p).join('\n');
            
            return html;
        }
        
        // Ëß£ÊûêMarkdownË°®Ê†º
        function parseMarkdownTables(html) {
            const lines = html.split('\n');
            const processedLines = [];
            let i = 0;
            
            while (i < lines.length) {
                const line = lines[i];
                
                // Ê£ÄÊµãË°®Ê†ºÂºÄÂßãÔºöÂåÖÂê´ | ÁöÑË°å
                if (line.includes('|') && line.trim() !== '') {
                    const tableLines = [];
                    let j = i;
                    
                    // Êî∂ÈõÜËøûÁª≠ÁöÑË°®Ê†ºË°å
                    while (j < lines.length && lines[j].includes('|') && lines[j].trim() !== '') {
                        tableLines.push(lines[j]);
                        j++;
                    }
                    
                    // Â¶ÇÊûúÊâæÂà∞‰∫ÜË°®Ê†ºË°åÔºåÂ§ÑÁêÜË°®Ê†º
                    if (tableLines.length >= 2) {
                        const tableHtml = parseTableLines(tableLines);
                        processedLines.push(tableHtml);
                        i = j; // Ë∑≥ËøáÂ∑≤Â§ÑÁêÜÁöÑË°®Ê†ºË°å
                        continue;
                    }
                }
                
                // ‰∏çÊòØË°®Ê†ºË°åÔºåÁõ¥Êé•Ê∑ªÂä†
                processedLines.push(line);
                i++;
            }
            
            return processedLines.join('\n');
        }
        
        // Ëß£ÊûêË°®Ê†ºË°åÂπ∂ÁîüÊàêHTML
        function parseTableLines(tableLines) {
            if (tableLines.length < 2) return tableLines.join('\n');
            
            let html = '<table class="markdown-table">\n';
            
            // Ëß£ÊûêÁ¨¨‰∏ÄË°å‰Ωú‰∏∫Ë°®Â§¥
            const headerRow = tableLines[0];
            const headerCells = parseTableRow(headerRow);
            
            // Ê£ÄÊü•Á¨¨‰∫åË°åÊòØÂê¶‰∏∫ÂàÜÈöîÁ¨¶Ë°å
            const separatorRow = tableLines[1];
            const isSeparatorRow = /^[\s\|:\-]+$/.test(separatorRow);
            
            if (isSeparatorRow && headerCells.length > 0) {
                // ÊúâË°®Â§¥ÁöÑË°®Ê†º
                html += '  <thead>\n    <tr>\n';
                headerCells.forEach(cell => {
                    html += `      <th>${cell.trim()}</th>\n`;
                });
                html += '    </tr>\n  </thead>\n';
                
                // Ëß£ÊûêÂØπÈΩêÊñπÂºè
                const alignments = parseTableAlignment(separatorRow);
                
                // Â§ÑÁêÜÊï∞ÊçÆË°å
                if (tableLines.length > 2) {
                    html += '  <tbody>\n';
                    for (let i = 2; i < tableLines.length; i++) {
                        const dataCells = parseTableRow(tableLines[i]);
                        if (dataCells.length > 0) {
                            html += '    <tr>\n';
                            dataCells.forEach((cell, index) => {
                                const alignment = alignments[index] || 'left';
                                const style = alignment !== 'left' ? ` style="text-align: ${alignment}"` : '';
                                html += `      <td${style}>${cell.trim()}</td>\n`;
                            });
                            html += '    </tr>\n';
                        }
                    }
                    html += '  </tbody>\n';
                }
            } else {
                // Ê≤°ÊúâË°®Â§¥ÁöÑÁÆÄÂçïË°®Ê†º
                html += '  <tbody>\n';
                tableLines.forEach(line => {
                    const cells = parseTableRow(line);
                    if (cells.length > 0) {
                        html += '    <tr>\n';
                        cells.forEach(cell => {
                            html += `      <td>${cell.trim()}</td>\n`;
                        });
                        html += '    </tr>\n';
                    }
                });
                html += '  </tbody>\n';
            }
            
            html += '</table>';
            return html;
        }
        
        // Ëß£ÊûêË°®Ê†ºË°åÔºåÂàÜÂâ≤ÂçïÂÖÉÊ†º
        function parseTableRow(row) {
            // ÁßªÈô§È¶ñÂ∞æÁöÑ | Âπ∂ÂàÜÂâ≤
            const trimmed = row.trim();
            let content = trimmed;
            
            // ÁßªÈô§ÂºÄÂ§¥ÂíåÁªìÂ∞æÁöÑ |
            if (content.startsWith('|')) {
                content = content.substring(1);
            }
            if (content.endsWith('|')) {
                content = content.substring(0, content.length - 1);
            }
            
            // ÂàÜÂâ≤ÂçïÂÖÉÊ†ºÔºåÂ§ÑÁêÜËΩ¨‰πâÁöÑ |
            const cells = [];
            let currentCell = '';
            let escaped = false;
            
            for (let i = 0; i < content.length; i++) {
                const char = content[i];
                
                if (char === '\\' && !escaped) {
                    escaped = true;
                    continue;
                }
                
                if (char === '|' && !escaped) {
                    cells.push(currentCell);
                    currentCell = '';
                } else {
                    currentCell += char;
                }
                
                escaped = false;
            }
            
            // Ê∑ªÂä†ÊúÄÂêé‰∏Ä‰∏™ÂçïÂÖÉÊ†º
            if (currentCell !== '' || content.endsWith('|')) {
                cells.push(currentCell);
            }
            
            return cells;
        }
        
        // Ëß£ÊûêË°®Ê†ºÂØπÈΩêÊñπÂºè
        function parseTableAlignment(separatorRow) {
            const cells = parseTableRow(separatorRow);
            return cells.map(cell => {
                const trimmed = cell.trim();
                if (trimmed.startsWith(':') && trimmed.endsWith(':')) {
                    return 'center';
                } else if (trimmed.endsWith(':')) {
                    return 'right';
                } else {
                    return 'left';
                }
            });
        }
        
        // Ê†ºÂºèÂåñËÑöÊú¨Ë°åÊòæÁ§∫
        function formatScriptLine(line) {
            if (!line || line.trim() === '') {
                return line;
            }
            
            // Â§ÑÁêÜÊ≥®ÈáäË°å
            if (line.trim().startsWith('#')) {
                return `<span style="color: #9ca3af;">${line}</span>`;
            }
            
            // Êü•ÊâæË°åÂÜÖÊ≥®ÈáäÁöÑ‰ΩçÁΩÆ
            const commentIndex = line.indexOf('#');
            let mainPart = line;
            let commentPart = '';
            
            if (commentIndex !== -1) {
                mainPart = line.substring(0, commentIndex);
                commentPart = line.substring(commentIndex);
            }
            
            // Â§ÑÁêÜ‰∏ªË¶ÅÈÉ®ÂàÜ
            const trimmedMain = mainPart.trim();
            if (!trimmedMain) {
                return commentPart ? `<span style="color: #9ca3af;">${commentPart}</span>` : line;
            }
            
            // ÂàÜÂâ≤Á¨¨‰∏Ä‰∏™ÂçïËØçÂíåÂÖ∂‰ΩôÈÉ®ÂàÜ
            const words = trimmedMain.split(/\s+/);
            if (words.length === 0) {
                return commentPart ? `${line.substring(0, commentIndex)}<span style="color: #9ca3af;">${commentPart}</span>` : line;
            }
            
            const firstWord = words[0];
            const restWords = words.slice(1);
            
            // ÊûÑÂª∫Ê†ºÂºèÂåñÁöÑË°å
            let formatted = `<strong>${firstWord}</strong>`;
            
            if (restWords.length > 0) {
                // ËÆ°ÁÆóÂØπÈΩêÁ©∫Ê†º - ËÆ©ÂêéÁª≠ÂÜÖÂÆπÂØπÈΩêÂà∞Âõ∫ÂÆö‰ΩçÁΩÆ
                const alignmentSpaces = Math.max(1, 12 - firstWord.length);
                formatted += `<span style="display: inline-block; width: ${alignmentSpaces * 0.6}em;"></span>`;
                formatted += restWords.join(' ');
            }
            
            // Ê∑ªÂä†Ê≥®ÈáäÈÉ®ÂàÜÔºàÂ¶ÇÊûúÊúâÔºâ
            if (commentPart) {
                formatted += `<span style="color: #9ca3af; margin-left: 1em;">${commentPart}</span>`;
            }
            
            return formatted;
        }
        
        // Â±ïÂºÄ/Êî∂Ëµ∑ÂëΩ‰ª§ÊèèËø∞
        function toggleCommandDesc() {
            const descElement = document.getElementById('commandDescRendered');
            const toggleElement = document.querySelector('.command-desc-toggle');
            
            if (!descElement || !toggleElement) return;
            
            const isCollapsed = descElement.classList.contains('collapsed');
            
            if (isCollapsed) {
                descElement.classList.remove('collapsed');
                descElement.classList.add('expanded');
                toggleElement.classList.add('expanded');
                toggleElement.querySelector('span:first-child').textContent = t('collapseDesc');
            } else {
                descElement.classList.remove('expanded');
                descElement.classList.add('collapsed');
                toggleElement.classList.remove('expanded');
                toggleElement.querySelector('span:first-child').textContent = t('expandDesc');
            }
        }

        
        // ÊòæÁ§∫Ê∑ªÂä†ÂëΩ‰ª§ÁºñËæëÂô®
        function showAddCommandEditor(row, col) {
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊ¥ªÂä®È°πÁõÆ
            if (!currentProject || !projectName) {
                const userChoice = confirm('ÈúÄË¶ÅÂÖàÂàõÂª∫È°πÁõÆÊâçËÉΩ‰øùÂ≠òËá™ÂÆö‰πâÂëΩ‰ª§„ÄÇ\n\nÁÇπÂáª"Á°ÆÂÆö"ÂàõÂª∫Êñ∞È°πÁõÆÔºåÁÇπÂáª"ÂèñÊ∂à"ËøîÂõû„ÄÇ');
                if (userChoice) {
                    newProject();
                }
                return;
            }
            
            currentEditingCommandId = null;
            currentEditingPosition = { row, col };
            
            document.getElementById('commandEditorTitle').textContent = t('newCommand');
            document.getElementById('commandNameInput').value = '';
            document.getElementById('commandDescInput').value = '';
            document.getElementById('commandExamplesInput').value = '';
            
            // Ê∏ÖÁ©∫ÂèÇÊï∞Ë°å
            clearParameterRows();
            
            showCommandEditor();
        }
        
        // ÊòæÁ§∫ÁºñËæëÂëΩ‰ª§ÁºñËæëÂô®
        function editUserCommand(commandId) {
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊ¥ªÂä®È°πÁõÆ
            if (!currentProject || !projectName) {
                alert('ÈúÄË¶ÅÂÖàÂàõÂª∫ÊàñÊâìÂºÄ‰∏Ä‰∏™È°πÁõÆÊâçËÉΩÁºñËæëÂëΩ‰ª§„ÄÇ');
                return;
            }
            
            const userCategoryCommands = userCommands[activeCategory] || {};
            const command = userCategoryCommands[commandId];
            
            if (!command) return;
            
            currentEditingCommandId = commandId;
            currentEditingPosition = commandPositions[activeCategory][commandId];
            
            document.getElementById('commandEditorTitle').textContent = t('editCommand');
            document.getElementById('commandNameInput').value = command.name;
            document.getElementById('commandDescInput').value = command.desc || '';
            document.getElementById('commandExamplesInput').value = (command.examples || []).join('\n');
            
            // Âä†ËΩΩÂèÇÊï∞Ë°åÊï∞ÊçÆ
            loadParameterRows(command.parameterRows || []);
            
            showCommandEditor();
        }
        
        // ÊòæÁ§∫ÂëΩ‰ª§ÁºñËæëÂô®
        function showCommandEditor() {
            const overlay = document.getElementById('commandEditorOverlay');
            overlay.classList.add('show');
            
            // ËÅöÁÑ¶Âà∞ÂëΩ‰ª§ÂêçÁß∞ËæìÂÖ•Ê°Ü
            setTimeout(() => {
                document.getElementById('commandNameInput').focus();
            }, 300);
        }
        
        // ÈöêËóèÂëΩ‰ª§ÁºñËæëÂô®
        function hideCommandEditor() {
            const overlay = document.getElementById('commandEditorOverlay');
            overlay.classList.remove('show');
            
            currentEditingCommandId = null;
            currentEditingPosition = null;
        }
        
        // Âà†Èô§Áî®Êà∑ÂëΩ‰ª§
        function deleteUserCommand(commandId) {
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊ¥ªÂä®È°πÁõÆ
            if (!currentProject || !projectName) {
                alert('ÈúÄË¶ÅÂÖàÂàõÂª∫ÊàñÊâìÂºÄ‰∏Ä‰∏™È°πÁõÆÊâçËÉΩÂà†Èô§ÂëΩ‰ª§„ÄÇ');
                return;
            }
            
            const userCategoryCommands = userCommands[activeCategory] || {};
            const command = userCategoryCommands[commandId];
            
            if (!command) return;
            
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÂëΩ‰ª§ "${command.name}" ÂêóÔºü`)) {
                // ‰ªéÁî®Êà∑ÂëΩ‰ª§Â∫ì‰∏≠Âà†Èô§
                delete userCategoryCommands[commandId];
                
                // ‰ªé‰ΩçÁΩÆ‰ø°ÊÅØ‰∏≠Âà†Èô§
                if (commandPositions[activeCategory]) {
                    delete commandPositions[activeCategory][commandId];
                }
                
                // Â¶ÇÊûúÂΩìÂâçÈÄâ‰∏≠ÁöÑÊòØËøô‰∏™ÂëΩ‰ª§ÔºåÊ∏ÖÈô§ÈÄâ‰∏≠Áä∂ÊÄÅ
                if (selectedCommand && selectedCommand.id === commandId) {
                    selectedCommand = null;
                    parameters = {};
                }
                
                // ÈáçÊñ∞Ê∏≤Êüì
                renderCommands();
                renderParameterForm();
                
                // Êõ¥Êñ∞È°πÁõÆÁä∂ÊÄÅ
                updateProjectUserCommands();
                
                // Êõ¥Êñ∞Ê†áÁ≠æËÆ°Êï∞
                updateTabCounts();
            }
        }
        
        // ËÆæÁΩÆÂëΩ‰ª§ÁºñËæëÂô®Ë°®Âçï‰∫ã‰ª∂
        function setupCommandEditorForm() {
            // ESC ÈîÆÂÖ≥Èó≠ÁºñËæëÂô®
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const overlay = document.getElementById('commandEditorOverlay');
                    if (overlay && overlay.classList.contains('show')) {
                        hideCommandEditor();
                    }
                }
            });
        }
        
        // ÂèÇÊï∞Ë°åÁÆ°ÁêÜÂáΩÊï∞
        let parameterRowCounter = 0;
        
        // Ê∑ªÂä†ÂèÇÊï∞Ë°å
        function addParameterRow() {
            const container = document.getElementById('parameterDefinitions');
            const rowId = `paramRow_${parameterRowCounter++}`;
            
            const rowHTML = `
                <div class="parameter-row" id="${rowId}">
                    <div class="parameter-row-field description">
                        <label class="parameter-row-label">ÂèÇÊï∞ÊèèËø∞</label>
                        <input type="text" class="parameter-row-input" placeholder="Â¶ÇÔºöÈáçÂäõÊñπÂêë" data-field="description">
                    </div>
                    <div class="parameter-row-field options">
                        <label class="parameter-row-label">ÂèÇÊï∞Ê°Ü1</label>
                        <input type="text" class="parameter-row-input" placeholder="Â¶ÇÔºöx,y,z" data-field="options1">
                    </div>
                    <div class="parameter-row-field options">
                        <label class="parameter-row-label">ÂèÇÊï∞Ê°Ü2</label>
                        <input type="text" class="parameter-row-input" placeholder="Â¶ÇÔºövector,chute" data-field="options2">
                    </div>
                    <button type="button" class="parameter-row-remove" onclick="removeParameterRow('${rowId}')">√ó</button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', rowHTML);
        }
        
        // Âà†Èô§ÂèÇÊï∞Ë°å
        function removeParameterRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
            }
        }
        
        // Ëé∑ÂèñÊâÄÊúâÂèÇÊï∞Ë°åÊï∞ÊçÆ
        function getParameterRowsData() {
            const rows = document.querySelectorAll('.parameter-row');
            const parameterRows = [];
            
            rows.forEach(row => {
                const description = row.querySelector('[data-field="description"]').value.trim();
                const options1Text = row.querySelector('[data-field="options1"]').value.trim();
                const options2Text = row.querySelector('[data-field="options2"]').value.trim();
                
                // Âè™Ë¶ÅÊúâ‰ªª‰Ωï‰∏Ä‰∏™Â≠óÊÆµÊúâÂÜÖÂÆπÔºåÂ∞±‰øùÂ≠òËøô‰∏ÄË°åÔºà‰∏çÂÜçË¶ÅÊ±ÇÊèèËø∞ÂøÖÂ°´Ôºâ
                if (description || options1Text || options2Text) {
                    parameterRows.push({
                        description: description || 'ÂèÇÊï∞', // Â¶ÇÊûúÊèèËø∞‰∏∫Á©∫Ôºå‰ΩøÁî®ÈªòËÆ§ÊèèËø∞
                        options1: parseOptionsText(options1Text),
                        options2: parseOptionsText(options2Text)
                    });
                }
            });
            
            return parameterRows;
        }
        
        // Ëß£ÊûêÈÄâÈ°πÊñáÊú¨ÔºåÊîØÊåÅÈÄóÂè∑„ÄÅ‰∏≠ÊñáÈÄóÂè∑„ÄÅorÂàÜÈöî
        function parseOptionsText(text) {
            if (!text) return [];
            
            // ÊîØÊåÅÈÄóÂè∑„ÄÅ‰∏≠ÊñáÈÄóÂè∑„ÄÅorÔºà‰∏çÂå∫ÂàÜÂ§ßÂ∞èÂÜôÔºâÂàÜÈöî
            return text.split(/[,Ôºå]|\s+or\s+/i)
                       .map(option => option.trim())
                       .filter(option => option);
        }
        
        // Ê∏ÖÁ©∫ÂèÇÊï∞Ë°å
        function clearParameterRows() {
            const container = document.getElementById('parameterDefinitions');
            container.innerHTML = '';
            parameterRowCounter = 0;
        }
        
        // Âä†ËΩΩÂèÇÊï∞Ë°åÊï∞ÊçÆ
        function loadParameterRows(parameterRows) {
            clearParameterRows();
            
            if (parameterRows && parameterRows.length > 0) {
                parameterRows.forEach(rowData => {
                    addParameterRow();
                    
                    // Â°´ÂÖÖÊúÄÂêé‰∏ÄË°åÁöÑÊï∞ÊçÆ
                    const lastRow = document.querySelector('.parameter-row:last-child');
                    if (lastRow) {
                        lastRow.querySelector('[data-field="description"]').value = rowData.description || '';
                        lastRow.querySelector('[data-field="options1"]').value = (rowData.options1 || []).join(', ');
                        lastRow.querySelector('[data-field="options2"]').value = (rowData.options2 || []).join(', ');
                    }
                });
            }
        }
        
        // ‰øùÂ≠òÁî®Êà∑ÂëΩ‰ª§
        function saveUserCommand() {
            // ÂÜçÊ¨°Ê£ÄÊü•È°πÁõÆÁä∂ÊÄÅÔºàÈò≤Ê≠¢ÁºñËæëËøáÁ®ã‰∏≠È°πÁõÆÁä∂ÊÄÅÊîπÂèòÔºâ
            if (!currentProject || !projectName) {
                alert('‰øùÂ≠òÂ§±Ë¥•ÔºöÈúÄË¶ÅÂÖàÂàõÂª∫È°πÁõÆÊâçËÉΩ‰øùÂ≠òÂëΩ‰ª§ÔºÅ');
                hideCommandEditor();
                return;
            }
            
            const name = document.getElementById('commandNameInput').value.trim();
            const desc = document.getElementById('commandDescInput').value.trim();
            const examples = document.getElementById('commandExamplesInput').value.trim();
            
            if (!name) {
                alert('ËØ∑ËæìÂÖ•ÂëΩ‰ª§ÂêçÁß∞ÔºÅ');
                return;
            }
            
            // Ëé∑ÂèñÂèÇÊï∞Ë°åÊï∞ÊçÆ
            const parameterRows = getParameterRowsData();
            
            // Ëß£ÊûêÁ§∫‰æãÂëΩ‰ª§
            const exampleLines = examples ? examples.split('\n').map(line => line.trim()).filter(line => line) : [];
            
            // ÂàõÂª∫ÊàñÊõ¥Êñ∞ÂëΩ‰ª§
            const commandId = currentEditingCommandId || generateCommandId();
            const position = currentEditingPosition;
            
            // ÂàùÂßãÂåñÂàÜÁ±ª
            if (!userCommands[activeCategory]) {
                userCommands[activeCategory] = {};
            }
            
            if (!commandPositions[activeCategory]) {
                commandPositions[activeCategory] = {};
            }
            
            // ‰øùÂ≠òÂëΩ‰ª§ÔºàÊñ∞Êï∞ÊçÆÁªìÊûÑÔºâ
            userCommands[activeCategory][commandId] = {
                id: commandId,
                name: name,
                desc: desc || 'Áî®Êà∑Ëá™ÂÆö‰πâÂëΩ‰ª§',
                parameterRows: parameterRows,
                examples: exampleLines
            };
            
            // ‰øùÂ≠ò‰ΩçÁΩÆ
            commandPositions[activeCategory][commandId] = position;
            
            // ÈöêËóèÁºñËæëÂô®
            hideCommandEditor();
            
            // ÈáçÊñ∞Ê∏≤Êüì
            renderCommands();
            
            // Êõ¥Êñ∞È°πÁõÆÁä∂ÊÄÅ
            updateProjectUserCommands();
            
            // Êõ¥Êñ∞Ê†áÁ≠æËÆ°Êï∞
            updateTabCounts();
            
            // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
            const action = currentEditingCommandId ? 'Êõ¥Êñ∞' : 'ÂàõÂª∫';
            alert(`ÂëΩ‰ª§ "${name}" ${action}ÊàêÂäüÔºÅ\n\nÈ°πÁõÆÔºö${projectName}`);
        }
        
        // ÁîüÊàêÂëΩ‰ª§ID
        function generateCommandId() {
            return 'user_cmd_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Ëé∑ÂèñÂëΩ‰ª§ÂèÇÊï∞ÊòæÁ§∫ÊñáÊú¨ÔºàÂÖºÂÆπÊñ∞ÊóßÊ†ºÂºèÔºâ
        function getCommandParamsDisplay(command) {
            if (command.parameterRows && command.parameterRows.length > 0) {
                // Êñ∞Ê†ºÂºèÔºöÂèÇÊï∞Ë°å
                const paramCount = command.parameterRows.length;
                const exampleCount = (command.examples || []).length;
                return `ÂèÇÊï∞Ë°å: ${paramCount} | Á§∫‰æã: ${exampleCount}`;
            } else if (command.params && command.params.length > 0) {
                // ÊóßÊ†ºÂºèÔºöÂèÇÊï∞ÂàóË°®
                return `ÂèÇÊï∞: ${command.params.join(', ')}`;
            } else {
                return 'ÂèÇÊï∞: Êó†';
            }
        }
        
        // Êï∞ÊçÆÊ†ºÂºèÂÖºÂÆπÊÄßÂ§ÑÁêÜ
        function migrateCommandToNewFormat(command) {
            // Â¶ÇÊûúÂ∑≤ÁªèÊòØÊñ∞Ê†ºÂºèÔºåÁõ¥Êé•ËøîÂõû
            if (command.parameterRows) {
                return command;
            }
            
            // Â¶ÇÊûúÊòØÊóßÊ†ºÂºèÔºåËΩ¨Êç¢‰∏∫Êñ∞Ê†ºÂºè
            const migratedCommand = {
                id: command.id,
                name: command.name,
                desc: command.desc,
                parameterRows: [],
                examples: []
            };
            
            // Â¶ÇÊûúÊúâÊóßÁöÑÊ®°ÊùøÔºåÊ∑ªÂä†‰∏∫Á§∫‰æã
            if (command.template) {
                migratedCommand.examples.push(command.template);
            }
            
            // Â¶ÇÊûúÊúâÊóßÁöÑÂèÇÊï∞ÔºåÂ∞ùËØïËΩ¨Êç¢ÔºàËøôÊòØ‰∏Ä‰∏™ÁÆÄÂçïÁöÑÊò†Â∞ÑÔºâ
            if (command.params && command.params.length > 0) {
                // ‰∏∫ÊØè‰∏™ÊóßÂèÇÊï∞ÂàõÂª∫‰∏Ä‰∏™ÂèÇÊï∞Ë°å
                command.params.forEach(param => {
                    migratedCommand.parameterRows.push({
                        description: `ÂèÇÊï∞: ${param}`,
                        options1: [param],
                        options2: []
                    });
                });
            }
            
            return migratedCommand;
        }
        
        // Á°Æ‰øùÊâÄÊúâÁî®Êà∑ÂëΩ‰ª§ÈÉΩ‰ΩøÁî®Êñ∞Ê†ºÂºè
        function ensureCommandsNewFormat() {
            Object.keys(userCommands).forEach(category => {
                const categoryCommands = userCommands[category];
                Object.keys(categoryCommands).forEach(commandId => {
                    categoryCommands[commandId] = migrateCommandToNewFormat(categoryCommands[commandId]);
                });
            });
        }
        
        // Êõ¥Êñ∞ÁïåÈù¢Áä∂ÊÄÅÔºàÂü∫‰∫éÈ°πÁõÆÁä∂ÊÄÅÔºâ
        function updateInterfaceState() {
            const hasProject = currentProject && projectName;
            
            // Â∑•ÂÖ∑Ê†èÊåâÈíÆÁä∂ÊÄÅ
            const saveBtn = document.querySelector('.toolbar-left .btn-gray:nth-child(4)');
            const importCommandsBtn = document.querySelector('.btn-primary[onclick="importCommands()"]');
            const importScriptBtn = document.querySelector('.btn-primary[onclick="importScript()"]');
            const exportBtn = document.querySelector('.btn-green[onclick="exportScript()"]');
            const runBtn = document.getElementById('runBtn');
            
            // ËÑöÊú¨Âå∫ÊåâÈíÆÁä∂ÊÄÅÔºàÊí§ÈîÄÊåâÈíÆÈúÄË¶ÅÁâπÊÆäÂ§ÑÁêÜÔºâ
            const insertBtn = document.querySelector('.btn-primary[onclick="insertNewLine()"]');
            const undoBtn = document.getElementById('undoBtn');
            const clearBtn = document.querySelector('.btn-gray[onclick="clearScript()"]');
            
            // ÂëΩ‰ª§ÁΩëÊ†ºÂÆπÂô®
            const commandsContainer = document.getElementById('commandsContainer');
            const searchInput = document.getElementById('searchInput');
            const tabs = document.getElementById('tabs');
            
            if (hasProject) {
                // ÊúâÈ°πÁõÆÊó∂ÔºöÂêØÁî®ÊâÄÊúâÂäüËÉΩÔºàÈô§‰∫ÜÊí§ÈîÄÊåâÈíÆÔºâ
                [saveBtn, importCommandsBtn, importScriptBtn, exportBtn, runBtn, insertBtn, clearBtn].forEach(btn => {
                    if (btn) {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                        btn.style.pointerEvents = 'auto';
                    }
                });
                
                // Êí§ÈîÄÊåâÈíÆÁâπÊÆäÂ§ÑÁêÜÔºöÂÖàÂêØÁî®Ê†∑ÂºèÔºåÁÑ∂ÂêéÁî± updateUndoButton ÂÜ≥ÂÆöÂÆûÈôÖÁä∂ÊÄÅ
                if (undoBtn) {
                    undoBtn.style.pointerEvents = 'auto';
                    undoBtn.style.cursor = 'pointer';
                    // ‰∏çÂú®ËøôÈáåËÆæÁΩÆ disabled Âíå opacityÔºåÁî± updateUndoButton ÂÜ≥ÂÆö
                }
                
                // ÂêØÁî®ÊêúÁ¥¢ÂíåÊ†áÁ≠æ
                if (searchInput) {
                    searchInput.disabled = false;
                    searchInput.style.opacity = '1';
                    searchInput.style.cursor = 'text';
                }
                
                // Á°Æ‰øùÊêúÁ¥¢ÂõæÊ†áÂèØËßÅ
                const searchIcon = document.querySelector('.search-icon');
                if (searchIcon) {
                    searchIcon.style.opacity = '1';
                }
                
                if (tabs) {
                    tabs.style.pointerEvents = 'auto';
                    tabs.style.opacity = '1';
                }
                
                if (commandsContainer) {
                    commandsContainer.style.pointerEvents = 'auto';
                    commandsContainer.style.opacity = '1';
                }
                
                // Êí§ÈîÄÊåâÈíÆÁî±ÂÆÉËá™Â∑±ÁöÑÈÄªËæëÂÜ≥ÂÆöÁä∂ÊÄÅ
                updateUndoButton();
                
            } else {
                // Êó†È°πÁõÆÊó∂ÔºöÁ¶ÅÁî®Â§ßÈÉ®ÂàÜÂäüËÉΩ
                [saveBtn, importCommandsBtn, importScriptBtn, exportBtn, runBtn, insertBtn, undoBtn, clearBtn].forEach(btn => {
                    if (btn) {
                        btn.disabled = true;
                        btn.style.opacity = '0.4';
                        btn.style.cursor = 'not-allowed';
                        btn.style.pointerEvents = 'none';
                    }
                });
                
                // Á¶ÅÁî®ÊêúÁ¥¢ÂíåÊ†áÁ≠æ
                if (searchInput) {
                    searchInput.disabled = true;
                    searchInput.style.opacity = '0.4';
                    searchInput.style.cursor = 'not-allowed';
                    searchInput.value = ''; // Ê∏ÖÁ©∫ÊêúÁ¥¢
                }
                
                // ÊêúÁ¥¢ÂõæÊ†á‰πüÈúÄË¶ÅÁõ∏Â∫îÁöÑÈÄèÊòéÂ∫¶Â§ÑÁêÜ
                const searchIcon = document.querySelector('.search-icon');
                if (searchIcon) {
                    searchIcon.style.opacity = '0.4';
                }
                
                if (tabs) {
                    tabs.style.pointerEvents = 'none';
                    tabs.style.opacity = '0.4';
                }
                
                if (commandsContainer) {
                    commandsContainer.style.pointerEvents = 'none';
                    commandsContainer.style.opacity = '0.4';
                }
            }
        }
        
        // Ê£ÄÊü•È°πÁõÆÁä∂ÊÄÅÁöÑÈÄöÁî®ÂáΩÊï∞
        function checkProjectRequired(actionName = 'Ê≠§Êìç‰Ωú') {
            if (!currentProject || !projectName) {
                alert(`${actionName}ÈúÄË¶ÅÂÖàÂàõÂª∫ÊàñÊâìÂºÄ‰∏Ä‰∏™È°πÁõÆ„ÄÇ`);
                return false;
            }
            return true;
        }
        
        // Êõ¥Êñ∞È°πÁõÆ‰∏≠ÁöÑÁî®Êà∑ÂëΩ‰ª§
        function updateProjectUserCommands() {
            if (currentProject) {
                currentProject.userCommands = {...userCommands};
                currentProject.commandPositions = {...commandPositions};
                currentProject.timestamp = new Date().toISOString();
            }
        }

        // ÂëΩ‰ª§Ê≠•È™§Êò†Â∞Ñ
        const commandStepMapping = {
            // ÂàùÂßãËÆæÁΩÆ
            'dimension': 'ÂàùÂßãËÆæÁΩÆ',
            'units': 'ÂàùÂßãËÆæÁΩÆ',
            'atom_style': 'ÂàùÂßãËÆæÁΩÆ',
            'boundary': 'ÂàùÂßãËÆæÁΩÆ',
            'newton': 'ÂàùÂßãËÆæÁΩÆ',
            
            // Âá†‰ΩïÂÆö‰πâ
            'region': 'Âá†‰ΩïÂÆö‰πâ',
            'create_box': 'Âá†‰ΩïÂÆö‰πâ',
            'create_atoms': 'Âá†‰ΩïÂÆö‰πâ',
            'lattice': 'Âá†‰ΩïÂÆö‰πâ',
            
            // ÊùêÊñôÂ±ûÊÄß
            'pair_style': 'ÊùêÊñôÂ±ûÊÄß',
            'pair_coeff': 'ÊùêÊñôÂ±ûÊÄß',
            'fix wall/gran': 'ÊùêÊñôÂ±ûÊÄß',
            
            // È¢óÁ≤íËÆæÁΩÆ
            'fix insert': 'È¢óÁ≤íËÆæÁΩÆ',
            'fix gravity': 'È¢óÁ≤íËÆæÁΩÆ',
            'fix nve/sphere': 'È¢óÁ≤íËÆæÁΩÆ',
            
            // Ê±ÇËß£ÊéßÂà∂
            'timestep': 'Ê±ÇËß£ÊéßÂà∂',
            'run': 'Ê±ÇËß£ÊéßÂà∂',
            'minimize': 'Ê±ÇËß£ÊéßÂà∂',
            'reset_timestep': 'Ê±ÇËß£ÊéßÂà∂',
            
            // ËæìÂá∫ÊéßÂà∂
            'dump': 'ËæìÂá∫ÊéßÂà∂',
            'thermo': 'ËæìÂá∫ÊéßÂà∂',
            'thermo_style': 'ËæìÂá∫ÊéßÂà∂'
        };

        // Ê≠•È™§Âà∞CSSÁ±ªÁöÑÊò†Â∞Ñ
        const stepToClassMapping = {
            'ÂàùÂßãËÆæÁΩÆ': 'step-init',
            'Âá†‰ΩïÂÆö‰πâ': 'step-geometry',
            'ÊùêÊñôÂ±ûÊÄß': 'step-material',
            'È¢óÁ≤íËÆæÁΩÆ': 'step-particle',
            'Ê±ÇËß£ÊéßÂà∂': 'step-solver',
            'ËæìÂá∫ÊéßÂà∂': 'step-output',
            'ÂÖ∂ÂÆÉËÆæÁΩÆ': 'step-other'
        };

        // ‰øùÂ≠òÂΩìÂâçËÑöÊú¨Áä∂ÊÄÅÔºàÁî®‰∫éÊí§ÈîÄÔºâ
        function saveScriptState() {
            previousScriptState = [...scriptLines];
            updateUndoButton();
        }

        // Êõ¥Êñ∞Êí§ÈîÄÊåâÈíÆÁä∂ÊÄÅ
        function updateUndoButton() {
            const undoBtn = document.getElementById('undoBtn');
            if (undoBtn) {
                const canUndo = previousScriptState !== null && previousScriptState.length !== scriptLines.length || 
                               (previousScriptState !== null && JSON.stringify(previousScriptState) !== JSON.stringify(scriptLines));
                undoBtn.disabled = !canUndo;
                undoBtn.style.opacity = canUndo ? '1' : '0.5';
            }
        }

        // Êí§ÈîÄ‰∏äÊ¨°Êõ¥Êîπ
        function undoLastChange() {
            if (!checkProjectRequired('Êí§ÈîÄÊìç‰Ωú')) return;
            if (previousScriptState !== null) {
                const currentState = [...scriptLines];
                scriptLines = [...previousScriptState];
                previousScriptState = null; // Âè™ËÉΩÊí§ÈîÄ‰∏ÄÊ¨°
                
                renderScript();
                
                // Êõ¥Êñ∞È°πÁõÆÁä∂ÊÄÅ
                if (currentProject) {
                    currentProject.scriptLines = [...scriptLines];
                    currentProject.timestamp = new Date().toISOString();
                }
                
                updateUndoButton();
                
                // ÊòæÁ§∫Êí§ÈîÄÊèêÁ§∫
                const linesDiff = currentState.length - scriptLines.length;
                if (linesDiff > 0) {
                    console.log(`Â∑≤Êí§ÈîÄÔºöÂà†Èô§‰∫Ü ${linesDiff} Ë°åËÑöÊú¨`);
                } else if (linesDiff < 0) {
                    console.log(`Â∑≤Êí§ÈîÄÔºöÊ∑ªÂä†‰∫Ü ${Math.abs(linesDiff)} Ë°åËÑöÊú¨`);
                } else {
                    console.log('Â∑≤Êí§ÈîÄÔºöÊÅ¢Â§çÂà∞‰∏ä‰∏ÄÊ¨°Áä∂ÊÄÅ');
                }
            }
        }

        // Ëé∑ÂèñÂëΩ‰ª§ÁöÑÊ≠•È™§
        function getCommandStep(commandLine) {
            if (!commandLine || typeof commandLine !== 'string') {
                return 'ÂàùÂßãËÆæÁΩÆ'; // ÈªòËÆ§Ê≠•È™§
            }
            
            const command = commandLine.trim().split(' ')[0];
            
            // Ê£ÄÊü•ÂÆåÊï¥ÂëΩ‰ª§Âêç
            if (commandStepMapping[commandLine.trim()]) {
                return commandStepMapping[commandLine.trim()];
            }
            
            // Ê£ÄÊü•ÂëΩ‰ª§ÁöÑÁ¨¨‰∏Ä‰∏™ËØç
            if (commandStepMapping[command]) {
                return commandStepMapping[command];
            }
            
            // Ê£ÄÊü•Â§çÂêàÂëΩ‰ª§ÔºàÂ¶Ç "fix insert"Ôºâ
            const firstTwoWords = commandLine.trim().split(' ').slice(0, 2).join(' ');
            if (commandStepMapping[firstTwoWords]) {
                return commandStepMapping[firstTwoWords];
            }
            
            // ÁâπÊÆäÂ§ÑÁêÜfixÂëΩ‰ª§
            if (command === 'fix') {
                const fixType = commandLine.trim().split(' ')[2];
                if (fixType) {
                    if (fixType.includes('wall') || fixType.includes('gran')) {
                        return 'ÊùêÊñôÂ±ûÊÄß';
                    } else if (fixType.includes('insert')) {
                        return 'È¢óÁ≤íËÆæÁΩÆ';
                    } else if (fixType.includes('gravity') || fixType.includes('nve')) {
                        return 'È¢óÁ≤íËÆæÁΩÆ';
                    }
                }
            }
            
            return 'ÂàùÂßãËÆæÁΩÆ'; // ÈªòËÆ§Ê≠•È™§
        }

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            renderCommands();
            setupEventListeners();
            setupCommandEditorForm();
            updateInterfaceState(); // ÂàùÂßãÂåñÁïåÈù¢Áä∂ÊÄÅ
            updateTabCounts(); // ÂàùÂßãÂåñÊ†áÁ≠æËÆ°Êï∞
        });

        // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function setupEventListeners() {
            // Ê†áÁ≠æÂàáÊç¢
            document.getElementById('tabs').addEventListener('click', function(e) {
                // Êü•ÊâæÊúÄËøëÁöÑ .tab Áà∂ÂÖÉÁ¥†
                const tabElement = e.target.closest('.tab');
                if (tabElement) {
                    switchTab(tabElement.dataset.category);
                }
            });

            // ÊêúÁ¥¢
            document.getElementById('searchInput').addEventListener('input', function(e) {
                const searchTerm = e.target.value;
                updateSearchClearButton(searchTerm);
                performCrossTabSearch(searchTerm);
            });

            // ËøêË°åÊåâÈíÆ
            document.getElementById('runBtn').addEventListener('click', function() {
                this.classList.toggle('btn-red');
                this.classList.toggle('btn-green');
                if (this.textContent.includes('ËøêË°å')) {
                    this.innerHTML = '‚è∏Ô∏è ÂÅúÊ≠¢';
                } else {
                    this.innerHTML = '‚ñ∂Ô∏è ËøêË°å';
                }
            });

            // È°πÁõÆÁÆ°ÁêÜÊåâÈíÆ
            setupProjectButtons();
        }

        // ËÆæÁΩÆÈ°πÁõÆÁÆ°ÁêÜÊåâÈíÆ‰∫ã‰ª∂
        function setupProjectButtons() {
            // Êñ∞Âª∫È°πÁõÆÊåâÈíÆ
            document.querySelector('.toolbar-left .btn-primary').addEventListener('click', newProject);
            
            // ÊâìÂºÄÈ°πÁõÆÊåâÈíÆ
            document.querySelector('.toolbar-left .btn-gray:nth-child(3)').addEventListener('click', openProject);
            
            // ‰øùÂ≠òÈ°πÁõÆÊåâÈíÆ
            document.querySelector('.toolbar-left .btn-gray:nth-child(4)').addEventListener('click', saveProject);
        }

        // ÂàáÊç¢Ê†áÁ≠æ
        function switchTab(category) {
            activeCategory = category;
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.category === category);
            });
            renderCommands();
        }

        // Êõ¥Êñ∞ÊêúÁ¥¢Ê∏ÖÈô§ÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
        function updateSearchClearButton(searchTerm) {
            const clearBtn = document.getElementById('searchClear');
            if (searchTerm.trim()) {
                clearBtn.classList.add('show');
            } else {
                clearBtn.classList.remove('show');
            }
        }

        // Ê∏ÖÈô§ÊêúÁ¥¢
        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = '';
            updateSearchClearButton('');
            clearSearchHighlights();
            renderCommands();
        }

        // Ë∑®Ê†áÁ≠æÊêúÁ¥¢
        function performCrossTabSearch(searchTerm) {
            clearSearchHighlights();
            
            if (!searchTerm.trim()) {
                renderCommands();
                return;
            }

            const matchingCategories = [];
            const allCategories = ['ÂàùÂßãËÆæÁΩÆ', 'Âá†‰ΩïÂÆö‰πâ', 'ÊùêÊñôÂ±ûÊÄß', 'È¢óÁ≤íËÆæÁΩÆ', 'Ê±ÇËß£ÊéßÂà∂', 'ËæìÂá∫ÊéßÂà∂', 'ÂÖ∂ÂÆÉËÆæÁΩÆ'];
            
            // ÊêúÁ¥¢ÊâÄÊúâÂàÜÁ±ª‰∏≠ÁöÑÂëΩ‰ª§
            allCategories.forEach(category => {
                const categoryCommands = userCommands[category] || {};
                const hasMatches = Object.values(categoryCommands).some(cmd => 
                    cmd.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    cmd.desc.toLowerCase().includes(searchTerm.toLowerCase())
                );
                
                if (hasMatches) {
                    matchingCategories.push(category);
                }
            });

            if (matchingCategories.length > 0) {
                // È´ò‰∫ÆÂåπÈÖçÁöÑÊ†áÁ≠æ
                highlightSearchTabs(matchingCategories);
                
                // Â¶ÇÊûúÂΩìÂâçÊ†áÁ≠æÊ≤°ÊúâÂåπÈÖçÁªìÊûúÔºåÂàáÊç¢Âà∞Á¨¨‰∏Ä‰∏™ÊúâÁªìÊûúÁöÑÊ†áÁ≠æ
                if (!matchingCategories.includes(activeCategory)) {
                    switchTab(matchingCategories[0]);
                } else {
                    renderCommands(searchTerm);
                }
            } else {
                renderCommands(searchTerm);
            }
        }

        // È´ò‰∫ÆÊêúÁ¥¢ÂåπÈÖçÁöÑÊ†áÁ≠æ
        function highlightSearchTabs(matchingCategories) {
            document.querySelectorAll('.tab').forEach(tab => {
                const category = tab.dataset.category;
                if (matchingCategories.includes(category)) {
                    tab.classList.add('search-highlight');
                } else {
                    tab.classList.remove('search-highlight');
                }
            });
        }

        // Ê∏ÖÈô§ÊêúÁ¥¢È´ò‰∫Æ
        function clearSearchHighlights() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('search-highlight');
            });
            document.querySelectorAll('.command-card').forEach(card => {
                card.classList.remove('search-highlight');
            });
        }

        // Ê∏≤ÊüìÂëΩ‰ª§ÁΩëÊ†ºÂ∑•‰ΩúÂè∞
        function renderCommands(searchTerm = '') {
            const container = document.getElementById('commandsContainer');
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÈ°πÁõÆ
            if (!currentProject || !projectName) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1; grid-row: 1 / -1; opacity: 1 !important; margin-top: 430px;">
                        <div class="empty-icon" style="opacity: 1 !important;">üìÅ</div>
                        <p style="opacity: 1 !important; color: #9ca3af !important;">${t('createProjectFirst')}</p>
                        <p style="font-size: 12px; margin-top: 8px; color: #9ca3af; opacity: 1 !important;">${t('needProjectToSave')}</p>
                    </div>
                `;
                return;
            }
            
            // Ëé∑ÂèñÁî®Êà∑ÂëΩ‰ª§ÔºàÂ¶ÇÊûú‰∏∫Á©∫ÂàôÊòæÁ§∫ÂàùÂßãÁä∂ÊÄÅÔºâ
            const userCategoryCommands = userCommands[activeCategory] || {};
            const commands = Object.values(userCategoryCommands);
            
            // ËøáÊª§ÂëΩ‰ª§
            const filteredCommands = searchTerm ? commands.filter(cmd => 
                cmd.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                cmd.desc.toLowerCase().includes(searchTerm.toLowerCase())
            ) : commands;

            if (filteredCommands.length === 0 && searchTerm) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1; grid-row: 1 / -1;">
                        <div class="empty-icon">üîç</div>
                        <p>Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÂëΩ‰ª§</p>
                    </div>
                `;
                return;
            }

            // Âä®ÊÄÅËÆ°ÁÆóÁΩëÊ†ºÂ§ßÂ∞è
            const containerWidth = container.clientWidth;
            const cellMinWidth = 280;
            const actualCols = Math.max(2, Math.floor((containerWidth - 32) / (cellMinWidth + 12)));
            const minRows = 3; // ÊúÄÂ∞ëÊòæÁ§∫3Ë°å
            const neededRows = Math.ceil((commands.length + 1) / actualCols); // +1 for add button
            const actualRows = Math.max(minRows, neededRows);
            
            // Êõ¥Êñ∞CSSÁΩëÊ†º
            container.style.gridTemplateColumns = `repeat(${actualCols}, 1fr)`;
            container.style.gridTemplateRows = `repeat(${actualRows}, 120px)`;
            
            // ÂàùÂßãÂåñ‰ΩçÁΩÆ‰ø°ÊÅØ
            if (!commandPositions[activeCategory]) {
                commandPositions[activeCategory] = {};
            }
            
            // Ê∏ÖÁêÜÊó†Êïà‰ΩçÁΩÆÔºàË∂ÖÂá∫ÁΩëÊ†ºËåÉÂõ¥ÁöÑÔºâ
            const positions = commandPositions[activeCategory];
            Object.keys(positions).forEach(cmdId => {
                const pos = positions[cmdId];
                if (pos.row >= actualRows || pos.col >= actualCols) {
                    // ÈáçÊñ∞ÂàÜÈÖç‰ΩçÁΩÆ
                    const availablePos = findFirstAvailablePosition(actualRows, actualCols, positions, commands);
                    if (availablePos) {
                        positions[cmdId] = availablePos;
                    }
                }
            });
            
            // ‰∏∫Êñ∞ÂëΩ‰ª§ÂàÜÈÖç‰ΩçÁΩÆÔºàÂ¶ÇÊûúÊ≤°Êúâ‰ΩçÁΩÆ‰ø°ÊÅØÔºâ
            commands.forEach(cmd => {
                if (!positions[cmd.id]) {
                    const availablePos = findFirstAvailablePosition(actualRows, actualCols, positions, commands);
                    if (availablePos) {
                        positions[cmd.id] = availablePos;
                    }
                }
            });
            
            // ÊâæÂà∞Á¨¨‰∏Ä‰∏™Á©∫ÁôΩ‰ΩçÁΩÆÁî®‰∫éÊîæÁΩÆÊ∑ªÂä†ÊåâÈíÆ
            const addButtonPosition = findFirstAvailablePosition(actualRows, actualCols, positions, commands);
            
            let gridHTML = '';
            
            // ÁîüÊàêÊâÄÊúâÁΩëÊ†ºÂçïÂÖÉÊ†º
            for (let row = 0; row < actualRows; row++) {
                for (let col = 0; col < actualCols; col++) {
                    const command = findUserCommandAtPosition(row, col, filteredCommands);
                    
                    if (command) {
                        // ÊúâÁî®Êà∑ÂëΩ‰ª§ÁöÑÂçïÂÖÉÊ†º
                        gridHTML += `
                            <div class="grid-cell occupied" 
                                 data-row="${row}" 
                                 data-col="${col}"
                                 ondrop="handleGridDrop(event, ${row}, ${col})"
                                 ondragover="handleGridDragOver(event)">
                                <div class="command-card" 
                                     draggable="true" 
                                     data-command-id="${command.id}"
                                     onclick="selectUserCommand('${command.id}')"
                                     ondragstart="handleCommandDragStart(event)">
                                    <div class="command-actions">
                                        <button class="command-action-btn edit" onclick="editUserCommand('${command.id}'); event.stopPropagation();">‚úè</button>
                                        <button class="command-action-btn delete" onclick="deleteUserCommand('${command.id}'); event.stopPropagation();">‚úï</button>
                                    </div>
                                    <div class="command-name">${command.name}</div>
                                    <div class="command-desc">${command.desc}</div>
                                    <div class="command-params">${getCommandParamsDisplay(command)}</div>
                                </div>
                            </div>
                        `;
                    } else if (!searchTerm && addButtonPosition && row === addButtonPosition.row && col === addButtonPosition.col) {
                        // Ê∑ªÂä†ÂëΩ‰ª§ÊåâÈíÆÔºàÂè™Âú®ÈùûÊêúÁ¥¢Áä∂ÊÄÅ‰∏ãÊòæÁ§∫Ôºâ
                        gridHTML += `
                            <div class="grid-cell add-command" 
                                 data-row="${row}" 
                                 data-col="${col}"
                                 onclick="showAddCommandEditor(${row}, ${col})">
                                <div class="add-command-icon">‚ûï</div>
                            </div>
                        `;
                    } else {
                        // Á©∫ÁôΩÂçïÂÖÉÊ†º
                        gridHTML += `
                            <div class="grid-cell" 
                                 data-row="${row}" 
                                 data-col="${col}"
                                 ondrop="handleGridDrop(event, ${row}, ${col})"
                                 ondragover="handleGridDragOver(event)">
                            </div>
                        `;
                    }
                }
            }
            
            container.innerHTML = gridHTML;
            
            // ËÆæÁΩÆÊ†áÁ≠æÊãñÊãΩÁõëÂê¨Âô®
            setupTabDragListeners();
        }
        
        // ÊâæÂà∞Á¨¨‰∏Ä‰∏™ÂèØÁî®‰ΩçÁΩÆ
        function findFirstAvailablePosition(maxRows, maxCols, positions, commands) {
            const occupiedPositions = new Set();
            
            // Ê†áËÆ∞ÊâÄÊúâÂ∑≤Âç†Áî®ÁöÑ‰ΩçÁΩÆ
            Object.values(positions).forEach(pos => {
                if (pos && pos.row < maxRows && pos.col < maxCols) {
                    occupiedPositions.add(`${pos.row}-${pos.col}`);
                }
            });
            
            // ÊâæÂà∞Á¨¨‰∏Ä‰∏™Á©∫ÁôΩ‰ΩçÁΩÆ
            for (let row = 0; row < maxRows; row++) {
                for (let col = 0; col < maxCols; col++) {
                    const posKey = `${row}-${col}`;
                    if (!occupiedPositions.has(posKey)) {
                        return { row, col };
                    }
                }
            }
            
            return null; // Ê≤°ÊúâÂèØÁî®‰ΩçÁΩÆ
        }

        // Ê†πÊçÆ‰ΩçÁΩÆÊü•ÊâæÁî®Êà∑ÂëΩ‰ª§
        function findUserCommandAtPosition(row, col, commands) {
            const positions = commandPositions[activeCategory] || {};
            return commands.find(cmd => {
                const pos = positions[cmd.id];
                return pos && pos.row === row && pos.col === col;
            });
        }

        // ÈÄâÊã©Áî®Êà∑ÂëΩ‰ª§
        function selectUserCommand(commandId) {
            const userCategoryCommands = userCommands[activeCategory] || {};
            selectedCommand = userCategoryCommands[commandId];
            parameters = {};
            
            // Ê∏ÖÁ©∫ÂèåÂèÇÊï∞Áä∂ÊÄÅÔºàÂàáÊç¢ÂëΩ‰ª§Êó∂ÈáçÁΩÆÔºâ
            dualParameters = [];
            originalDualParameters = [];
            isParametersCleared = false; // ÈáçÁΩÆÊ∏ÖÁ©∫Ê†áËÆ∞
            
            // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.command-card').forEach(card => {
                const isSelected = card.dataset.commandId === commandId;
                card.classList.toggle('selected', isSelected);
            });

            renderParameterForm();
        }

        // ÁΩëÊ†ºÊãñÊãΩÂ§ÑÁêÜ
        let draggedCommandId = null;
        let draggedFromPosition = null;
        let draggedFromCategory = null; // Êñ∞Â¢ûÔºöËÆ∞ÂΩïÊ∫êÊ†áÁ≠æ
        let dragOverTabTimer = null; // Áî®‰∫éÊ†áÁ≠æÂàáÊç¢ÁöÑËÆ°Êó∂Âô®

        function handleCommandDragStart(event) {
            const commandCard = event.target.closest('.command-card');
            const gridCell = event.target.closest('.grid-cell');
            
            draggedCommandId = commandCard.dataset.commandId;
            draggedFromCategory = activeCategory; // ËÆ∞ÂΩïÊ∫êÊ†áÁ≠æ
            draggedFromPosition = {
                row: parseInt(gridCell.dataset.row),
                col: parseInt(gridCell.dataset.col)
            };
            
            // Ê∑ªÂä†ÊãñÊãΩÊ†∑Âºè
            commandCard.classList.add('dragging');
            
            // ÂàõÂª∫‰∏Ä‰∏™ÊûÅÂ∞èÁöÑÊãñÊãΩÂõæÂÉè
            const dragImage = document.createElement('div');
            const commandName = commandCard.querySelector('.command-name')?.textContent || 'ÂëΩ‰ª§';
            
            dragImage.style.cssText = `
                position: fixed;
                top: -1000px;
                left: -1000px;
                width: 80px;
                height: 20px;
                background: rgba(59, 130, 246, 0.8);
                color: white;
                font-size: 10px;
                font-weight: bold;
                text-align: center;
                line-height: 20px;
                border-radius: 10px;
                padding: 0 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                z-index: 9999;
            `;
            
            dragImage.textContent = commandName;
            
            // ‰∏¥Êó∂Ê∑ªÂä†Âà∞È°µÈù¢‰∏≠
            document.body.appendChild(dragImage);
            
            // ËÆæÁΩÆÊãñÊãΩÊï∞ÊçÆ
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', commandCard.outerHTML);
            event.dataTransfer.setData('application/json', JSON.stringify({
                commandId: draggedCommandId,
                fromCategory: draggedFromCategory,
                fromPosition: draggedFromPosition
            }));
            
            // ËÆæÁΩÆÈùûÂ∏∏Â∞èÁöÑÊãñÊãΩÂõæÂÉè
            event.dataTransfer.setDragImage(dragImage, 40, 10);
            
            // Âª∂ËøüÁßªÈô§‰∏¥Êó∂ÂÖÉÁ¥†
            setTimeout(() => {
                if (dragImage.parentNode) {
                    dragImage.parentNode.removeChild(dragImage);
                }
            }, 0);
            
            // È´ò‰∫ÆÊâÄÊúâÂèØÊîæÁΩÆÁöÑÂå∫Âüü
            document.querySelectorAll('.grid-cell').forEach(cell => {
                cell.classList.add('drop-target');
            });
            
            // Ê∑ªÂä†Ê†áÁ≠æÊãñÊãΩÁõëÂê¨
            setupTabDragListeners();
        }

        function handleGridDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }

        function handleGridDrop(event, targetRow, targetCol) {
            event.preventDefault();
            
            if (!draggedCommandId) return;
            
            const targetPosition = { row: targetRow, col: targetCol };
            const positions = commandPositions[activeCategory];
            
            // Ê£ÄÊü•ÁõÆÊ†á‰ΩçÁΩÆÊòØÂê¶ÊúâÂëΩ‰ª§
            const targetCommandId = Object.keys(positions || {}).find(cmdId => {
                const pos = positions[cmdId];
                return pos && pos.row === targetRow && pos.col === targetCol;
            });
            
            if (targetCommandId && targetCommandId !== draggedCommandId) {
                // ÁõÆÊ†á‰ΩçÁΩÆÊúâÂÖ∂‰ªñÂëΩ‰ª§Ôºå‰∫§Êç¢‰ΩçÁΩÆ
                const draggedPos = positions[draggedCommandId];
                positions[targetCommandId] = draggedPos;
                positions[draggedCommandId] = targetPosition;
            } else if (!targetCommandId) {
                // ÁõÆÊ†á‰ΩçÁΩÆ‰∏∫Á©∫ÔºåÁõ¥Êé•ÁßªÂä®
                positions[draggedCommandId] = targetPosition;
            }
            // Â¶ÇÊûúÁõÆÊ†á‰ΩçÁΩÆÊòØËá™Â∑±Ôºå‰ªÄ‰πàÈÉΩ‰∏çÂÅö
            
            // Ê∏ÖÁêÜÊãñÊãΩÁä∂ÊÄÅ
            cleanupDragState();
            
            // ÈáçÊñ∞Ê∏≤Êüì
            renderCommands();
            
            // Êõ¥Êñ∞È°πÁõÆÁä∂ÊÄÅ
            updateProjectUserCommands();
            
            // Êõ¥Êñ∞Ê†áÁ≠æËÆ°Êï∞
            updateTabCounts();
        }
        
        // Êü•ÊâæÁ©∫‰ΩçÁΩÆ
        function findEmptyPosition(category) {
            const positions = commandPositions[category] || {};
            const occupiedPositions = Object.values(positions);
            
            for (let row = 0; row < 10; row++) {
                for (let col = 0; col < 4; col++) {
                    const isOccupied = occupiedPositions.some(pos => pos.row === row && pos.col === col);
                    if (!isOccupied) {
                        return { row, col };
                    }
                }
            }
            return null; // Ê≤°ÊúâÁ©∫‰ΩçÁΩÆ
        }
        
        // ËÆæÁΩÆÊ†áÁ≠æÊãñÊãΩÁõëÂê¨Âô®
        function setupTabDragListeners() {
            // ÁßªÈô§ÊâÄÊúâÁé∞ÊúâÁöÑÁõëÂê¨Âô®
            document.querySelectorAll('.tab').forEach(tab => {
                tab.removeEventListener('dragover', handleTabDragOver, true);
                tab.removeEventListener('dragleave', handleTabDragLeave, true);
                tab.removeEventListener('drop', handleTabDrop, true);
            });
            
            // Ê∑ªÂä†Êñ∞ÁöÑÁõëÂê¨Âô®Ôºå‰ΩøÁî®ÊçïËé∑Ê®°Âºè
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('dragover', handleTabDragOver, true);
                tab.addEventListener('dragleave', handleTabDragLeave, true);
                tab.addEventListener('drop', handleTabDrop, true);
            });
        }
        
        // Ê†áÁ≠æÊãñÊãΩÊÇ¨ÂÅú
        function handleTabDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            
            if (!draggedCommandId) return;
            
            const tab = event.currentTarget;
            const targetCategory = tab.dataset.category;
            
            // Â¶ÇÊûú‰∏çÊòØÂΩìÂâçÊ†áÁ≠æ‰∏îÊúâÊãñÊãΩÁöÑÂëΩ‰ª§
            if (targetCategory && targetCategory !== activeCategory) {
                tab.classList.add('drag-hover');
                
                // Ê∏ÖÈô§‰πãÂâçÁöÑËÆ°Êó∂Âô®
                if (dragOverTabTimer) {
                    clearTimeout(dragOverTabTimer);
                }
                
                // ËÆæÁΩÆÊñ∞ÁöÑËÆ°Êó∂Âô®Ôºå800ÊØ´ÁßíÂêéÂàáÊç¢Ê†áÁ≠æ
                dragOverTabTimer = setTimeout(() => {
                    if (targetCategory !== activeCategory) {
                        switchTab(targetCategory);
                        tab.classList.remove('drag-hover');
                    }
                }, 800);
            }
        }
        
        // Ê†áÁ≠æÊãñÊãΩÁ¶ªÂºÄ
        function handleTabDragLeave(event) {
            const tab = event.currentTarget;
            tab.classList.remove('drag-hover');
            
            // Ê∏ÖÈô§ËÆ°Êó∂Âô®
            if (dragOverTabTimer) {
                clearTimeout(dragOverTabTimer);
                dragOverTabTimer = null;
            }
        }
        
        // Ê†áÁ≠æ‰∏äÁöÑÊîæÁΩÆÂ§ÑÁêÜ
        function handleTabDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            console.log('Ê†áÁ≠æÊãñÊãΩÊîæÁΩÆ‰∫ã‰ª∂Ëß¶Âèë');
            console.log('draggedCommandId:', draggedCommandId);
            console.log('draggedFromCategory:', draggedFromCategory);
            
            if (!draggedCommandId || !draggedFromCategory) return;
            
            const tab = event.currentTarget;
            const targetCategory = tab.dataset.category;
            
            console.log('ÁõÆÊ†áÊ†áÁ≠æ:', targetCategory);
            
            // ‰øùÂ≠òÊãñÊãΩ‰ø°ÊÅØÔºåÈò≤Ê≠¢Ë¢´Ê∏ÖÁêÜÂáΩÊï∞Ê∏ÖÈô§
            const tempCommandId = draggedCommandId;
            const tempFromCategory = draggedFromCategory;
            
            // Â¶ÇÊûúÊãñÊãΩÂà∞‰∏çÂêåÁöÑÊ†áÁ≠æ
            if (targetCategory && targetCategory !== tempFromCategory) {
                console.log('ÊâßË°åË∑®Ê†áÁ≠æÁßªÂä®');
                
                // ÂÖàÊâßË°åÁßªÂä®ÂëΩ‰ª§
                moveCommandToCategory(tempCommandId, tempFromCategory, targetCategory);
                
                // ÁÑ∂ÂêéÂàáÊç¢Âà∞ÁõÆÊ†áÊ†áÁ≠æ
                setTimeout(() => {
                    switchTab(targetCategory);
                }, 50);
            } else {
                console.log('ÂêåÊ†áÁ≠æÊàñÊó†ÊïàÁõÆÊ†áÔºå‰∏çÊâßË°åÁßªÂä®');
            }
            
            // Ê∏ÖÁêÜÊãñÊãΩÁä∂ÊÄÅ
            cleanupDragState();
        }
        
        // ÁßªÂä®ÂëΩ‰ª§Âà∞ÊåáÂÆöÂàÜÁ±ª
        function moveCommandToCategory(commandId, fromCategory, toCategory) {
            console.log(`ÁßªÂä®ÂëΩ‰ª§: ${commandId} ‰ªé ${fromCategory} Âà∞ ${toCategory}`);
            
            if (!userCommands[fromCategory] || !userCommands[fromCategory][commandId]) {
                console.log('Ê∫êÂëΩ‰ª§‰∏çÂ≠òÂú®');
                return;
            }
            
            const command = userCommands[fromCategory][commandId];
            console.log('ÊâæÂà∞ÂëΩ‰ª§:', command);
            
            // Âà†Èô§Ê∫ê‰ΩçÁΩÆÁöÑÊï∞ÊçÆ
            delete userCommands[fromCategory][commandId];
            if (commandPositions[fromCategory]) {
                delete commandPositions[fromCategory][commandId];
            }
            
            // Âú®ÁõÆÊ†áÊ†áÁ≠æÂàõÂª∫ÂëΩ‰ª§Êï∞ÊçÆÁªìÊûÑÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
            if (!userCommands[toCategory]) {
                userCommands[toCategory] = {};
            }
            if (!commandPositions[toCategory]) {
                commandPositions[toCategory] = {};
            }
            
            // Êâæ‰∏Ä‰∏™Á©∫‰ΩçÁΩÆÊîæÁΩÆÂëΩ‰ª§
            const emptyPosition = findEmptyPosition(toCategory);
            if (emptyPosition) {
                commandPositions[toCategory][commandId] = emptyPosition;
                console.log('ÊîæÁΩÆÂú®Á©∫‰ΩçÁΩÆ:', emptyPosition);
            } else {
                // Ê≤°ÊúâÁ©∫‰ΩçÁΩÆÔºåÊîæÂú®Á¨¨‰∏Ä‰∏™‰ΩçÁΩÆ
                commandPositions[toCategory][commandId] = { row: 0, col: 0 };
                console.log('ÊîæÁΩÆÂú®Á¨¨‰∏Ä‰∏™‰ΩçÁΩÆ');
            }
            
            // Ê∑ªÂä†Âà∞ÁõÆÊ†áÊ†áÁ≠æ
            userCommands[toCategory][commandId] = command;
            console.log('ÂëΩ‰ª§ÁßªÂä®ÂÆåÊàê');
            
            // ÈáçÊñ∞Ê∏≤Êüì
            renderCommands();
            
            // Êõ¥Êñ∞È°πÁõÆÁä∂ÊÄÅ
            updateProjectUserCommands();
            
            // Êõ¥Êñ∞Ê†áÁ≠æËÆ°Êï∞
            updateTabCounts();
        }

        function cleanupDragState() {
            // Ê∏ÖÈô§ÊâÄÊúâÊãñÊãΩÁõ∏ÂÖ≥ÁöÑÊ†∑Âºè
            document.querySelectorAll('.command-card.dragging').forEach(card => {
                card.classList.remove('dragging');
            });
            
            document.querySelectorAll('.grid-cell').forEach(cell => {
                cell.classList.remove('drop-target', 'drop-invalid');
            });
            
            // Ê∏ÖÈô§Ê†áÁ≠æÊãñÊãΩÊ†∑Âºè
            document.querySelectorAll('.tab.drag-hover').forEach(tab => {
                tab.classList.remove('drag-hover');
            });
            
            // Ê∏ÖÈô§ËÆ°Êó∂Âô®
            if (dragOverTabTimer) {
                clearTimeout(dragOverTabTimer);
                dragOverTabTimer = null;
            }
            
            // ÁßªÈô§Ê†áÁ≠æÁõëÂê¨Âô®
            document.querySelectorAll('.tab').forEach(tab => {
                tab.removeEventListener('dragover', handleTabDragOver, true);
                tab.removeEventListener('dragleave', handleTabDragLeave, true);
                tab.removeEventListener('drop', handleTabDrop, true);
            });
            
            draggedCommandId = null;
            draggedFromPosition = null;
            draggedFromCategory = null;
        }

        // ÁõëÂê¨ÊãñÊãΩÁªìÊùü‰∫ã‰ª∂
        document.addEventListener('dragend', function(event) {
            if (event.target.classList.contains('command-card')) {
                cleanupDragState();
            }
        });

        // Êõ¥Êñ∞È°πÁõÆ‰∏≠ÁöÑÂëΩ‰ª§‰ΩçÁΩÆ
        function updateProjectCommandPositions() {
            if (currentProject) {
                currentProject.commandPositions = {...commandPositions};
                currentProject.timestamp = new Date().toISOString();
            }
        }

        // Ê∏≤ÊüìÂèÇÊï∞Ë°®Âçï
        function renderParameterForm() {
            const container = document.getElementById('paramsContent');
            
            if (!selectedCommand) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚öôÔ∏è</div>
                        <p>${t('selectCommand')}</p>
                    </div>
                `;
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶ÊòØÁî®Êà∑Ëá™ÂÆö‰πâÂëΩ‰ª§
            const isUserCommand = selectedCommand.id && selectedCommand.id.startsWith('user_cmd_');
            
            if (isUserCommand) {
                // Êñ∞ÁöÑÁî®Êà∑Ëá™ÂÆö‰πâÂëΩ‰ª§ÁªìÊûÑ
                const parameterRows = selectedCommand.parameterRows || [];
                const examples = selectedCommand.examples || [];
                
                // ÂÖàÂàùÂßãÂåñÂèÇÊï∞Êï∞ÁªÑ
                initializeDualParameters(parameterRows.length, parameterRows);
                
                let parameterFormHTML = '';
                
                // ÁîüÊàêÂèÇÊï∞Ë°åË°®Âçï
                parameterRows.forEach((row, index) => {
                    // Ëé∑ÂèñÂΩìÂâçË°åÁöÑÂÄº
                    const defaultValue1 = (row.options1 && row.options1.length > 0) ? row.options1[0] : '';
                    const defaultValue2 = (row.options2 && row.options2.length > 0) ? row.options2[0] : '';
                    
                    // Â¶ÇÊûúÂèÇÊï∞Ë¢´Ê∏ÖÁ©∫ÔºåÊòæÁ§∫Á©∫ÂÄºÔºõÂê¶ÂàôÊòæÁ§∫ÂΩìÂâçÂÄºÊàñÈªòËÆ§ÂÄº
                    let currentValue1, currentValue2;
                    if (isParametersCleared) {
                        // ÂèÇÊï∞Ë¢´Ê∏ÖÁ©∫ÔºåÊòæÁ§∫Á©∫ÂÄº
                        currentValue1 = '';
                        currentValue2 = '';
                    } else if (dualParameters[index]) {
                        // ÊúâÂΩìÂâçÂÄºÔºå‰ΩøÁî®ÂΩìÂâçÂÄº
                        currentValue1 = dualParameters[index][0];
                        currentValue2 = dualParameters[index][1];
                    } else {
                        // Ê≤°ÊúâÂΩìÂâçÂÄºÔºå‰ΩøÁî®ÈªòËÆ§ÂÄº
                        currentValue1 = defaultValue1;
                        currentValue2 = defaultValue2;
                    }
                    
                    parameterFormHTML += `
                        <div class="param-group">
                            <label class="param-label">${row.description}</label>
                            <div class="param-dual-select">
                                <select class="param-input" onchange="updateDualParameter(${index}, 0, this.value)">
                                    ${(row.options1 || []).map(option => `
                                        <option value="${option}" ${currentValue1 === option ? 'selected' : ''}>${option}</option>
                                    `).join('')}
                                    <option value="" ${currentValue1 === '' ? 'selected' : ''}></option>
                                </select>
                                <select class="param-input" onchange="updateDualParameter(${index}, 1, this.value)">
                                    ${(row.options2 || []).map(option => `
                                        <option value="${option}" ${currentValue2 === option ? 'selected' : ''}>${option}</option>
                                    `).join('')}
                                    <option value="" ${currentValue2 === '' ? 'selected' : ''}></option>
                                </select>
                            </div>
                        </div>
                    `;
                });
                
                // ÁîüÊàêÁ§∫‰æãÂëΩ‰ª§ÂàóË°®
                let examplesHTML = '';
                if (examples.length > 0) {
                    examplesHTML = `
                        <div class="examples-section">
                            <h4 style="margin: 16px 0 8px 0; font-size: 14px; color: var(--text-primary);">Á§∫‰æãÂëΩ‰ª§</h4>
                            ${examples.map((example, index) => `
                                <div class="example-item">
                                    <code class="example-command">${example}</code>
                                    <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px; margin-left: 8px;" onclick="addExampleToScript('${example}')">Ê∑ªÂä†</button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Ê∏≤ÊüìÊèèËø∞ÁöÑ Markdown
                const renderedDesc = parseMarkdown(selectedCommand.desc || '');
                const hasLongDesc = (selectedCommand.desc || '').length > 100; // Âà§Êñ≠ÊòØÂê¶ÈúÄË¶ÅÂ±ïÂºÄ/Êî∂Ëµ∑ÂäüËÉΩ
                
                container.innerHTML = `
                    <div class="params-form">
                        <div class="command-info">
                            <h3>${selectedCommand.name}</h3>
                            <div class="command-desc-rendered ${hasLongDesc ? 'collapsed' : 'expanded'}" id="commandDescRendered">
                                ${renderedDesc}
                            </div>
                            ${hasLongDesc ? `
                                <div class="command-desc-toggle" onclick="toggleCommandDesc()">
                                    <span>${t('expandDesc')}</span>
                                    <span class="command-desc-toggle-icon">‚ñº</span>
                                </div>
                            ` : ''}
                        </div>
                        ${parameterFormHTML}
                        ${examplesHTML}
                        ${parameterRows.length > 0 ? '<button class="add-command-btn" onclick="addCommand()" style="margin-top: 16px;">ÁîüÊàêÂπ∂Ê∑ªÂä†Âà∞ËÑöÊú¨</button>' : ''}
                    </div>
                `;
                
                // ÂèÇÊï∞Â∑≤Âú®ÂâçÈù¢ÂàùÂßãÂåñÔºå‰∏çÈúÄË¶ÅÈáçÂ§çÂàùÂßãÂåñ
                
            } else {
                // ÊóßÁöÑÈ¢ÑÂÆö‰πâÂëΩ‰ª§ÁªìÊûÑÔºà‰øùÊåÅÂÖºÂÆπÔºâ
                const template = parameterTemplates[selectedCommand.name] || {};
                const commandParams = selectedCommand.params || [];
                
                container.innerHTML = `
                    <div class="params-form">
                        <div class="command-info">
                            <h3>${selectedCommand.name}</h3>
                            <p>${selectedCommand.desc}</p>
                        </div>
                        ${commandParams.map(param => {
                            const paramTemplate = template[param];
                            return `
                                <div class="param-group">
                                    <label class="param-label">${param}</label>
                                    ${paramTemplate?.type === 'select' ? `
                                        <select class="param-input" onchange="updateParameter('${param}', this.value)">
                                            ${paramTemplate.options.map(option => `
                                                <option value="${option}" ${option === paramTemplate.default ? 'selected' : ''}>${option}</option>
                                            `).join('')}
                                        </select>
                                    ` : `
                                        <input type="${paramTemplate?.type || 'text'}" 
                                               class="param-input" 
                                               placeholder="ËæìÂÖ• ${param}"
                                               value="${paramTemplate?.default || ''}"
                                               ${paramTemplate?.step ? `step="${paramTemplate.step}"` : ''}
                                               onchange="updateParameter('${param}', this.value)">
                                    `}
                                </div>
                            `;
                        }).join('')}
                        <button class="add-command-btn" onclick="addCommand()">Ê∑ªÂä†Âà∞ËÑöÊú¨</button>
                    </div>
                `;

                // ÂàùÂßãÂåñÂèÇÊï∞
                commandParams.forEach(param => {
                    const paramTemplate = template[param];
                    if (paramTemplate?.default) {
                        parameters[param] = paramTemplate.default;
                    }
                });
            }
            
            // ÊéßÂà∂ÈáçÁΩÆÊåâÈíÆÁöÑÊòæÁ§∫Áä∂ÊÄÅ
            updateResetButtonVisibility();
        }
        
        // ÊéßÂà∂ÈáçÁΩÆÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
        function updateResetButtonVisibility() {
            const resetBtn = document.getElementById('paramResetBtn');
            if (resetBtn) {
                // Âè™ÊúâÂú®ÊúâÈÄâ‰∏≠ÂëΩ‰ª§‰∏îÊúâÂèÇÊï∞Êó∂ÊâçÊòæÁ§∫ÈáçÁΩÆÊåâÈíÆ
                const hasParameters = selectedCommand && 
                    ((selectedCommand.parameterRows && selectedCommand.parameterRows.length > 0) ||
                     (selectedCommand.params && selectedCommand.params.length > 0));
                
                if (hasParameters) {
                    resetBtn.style.display = 'flex';
                    resetBtn.style.opacity = '0.6';
                } else {
                    resetBtn.style.display = 'none';
                }
            }
        }

        // Êõ¥Êñ∞ÂèÇÊï∞
        function updateParameter(param, value) {
            parameters[param] = value;
        }
        
        // ÂèåÂèÇÊï∞ÁÆ°ÁêÜ
        let dualParameters = [];
        let originalDualParameters = []; // Â≠òÂÇ®ÂéüÂßãÂèÇÊï∞Áä∂ÊÄÅ
        let isParametersCleared = false; // Ê†áËÆ∞ÂèÇÊï∞ÊòØÂê¶Ë¢´Ê∏ÖÁ©∫
        
        // ÂàùÂßãÂåñÂèåÂèÇÊï∞Êï∞ÁªÑ
        function initializeDualParameters(rowCount, parameterRows = []) {
            // Âè™ÊúâÂú®Êï∞ÁªÑÈïøÂ∫¶‰∏çÂåπÈÖçÊó∂ÊâçÈáçÊñ∞ÂàùÂßãÂåñÔºå‰øùÁïôÁé∞ÊúâÂÄº
            if (dualParameters.length !== rowCount) {
                const oldParameters = [...dualParameters];
                dualParameters = [];
                originalDualParameters = []; // ÂêåÊó∂ÂàùÂßãÂåñÂéüÂßãÁä∂ÊÄÅ
                
                for (let i = 0; i < rowCount; i++) {
                    // Â¶ÇÊûúÊóßÊï∞ÁªÑ‰∏≠ÊúâÂÄºÔºå‰øùÁïôÂÆÉÔºåÂê¶Âàô‰ΩøÁî®ÈªòËÆ§ÂÄº
                    if (oldParameters[i]) {
                        dualParameters.push([...oldParameters[i]]);
                        originalDualParameters.push([...oldParameters[i]]);
                    } else {
                        // ‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÂèØÁî®ÈÄâÈ°π‰Ωú‰∏∫ÈªòËÆ§ÂÄºÔºåÂ¶ÇÊûúÊ≤°ÊúâÈÄâÈ°πÂàô‰ΩøÁî®Á©∫Â≠óÁ¨¶‰∏≤
                        const row = parameterRows[i];
                        const defaultValue1 = (row && row.options1 && row.options1.length > 0) ? row.options1[0] : '';
                        const defaultValue2 = (row && row.options2 && row.options2.length > 0) ? row.options2[0] : '';
                        dualParameters.push([defaultValue1, defaultValue2]); // [ÂèÇÊï∞Ê°Ü1ÂÄº, ÂèÇÊï∞Ê°Ü2ÂÄº]
                        originalDualParameters.push([defaultValue1, defaultValue2]); // ‰øùÂ≠òÂéüÂßãÁä∂ÊÄÅ
                    }
                }
                
                // ÈáçÁΩÆÊ∏ÖÁ©∫Ê†áËÆ∞ÔºàÂè™ÊúâÂú®ÈáçÊñ∞ÂàùÂßãÂåñÊó∂ÊâçÈáçÁΩÆÔºâ
                isParametersCleared = false;
                
                console.log('ÂàùÂßãÂåñ/Êõ¥Êñ∞ÂèÇÊï∞Êï∞ÁªÑ:', dualParameters);
                console.log('‰øùÂ≠òÂéüÂßãÂèÇÊï∞Áä∂ÊÄÅ:', originalDualParameters);
            }
        }
        
        // Êõ¥Êñ∞ÂèåÂèÇÊï∞ÂÄº
        function updateDualParameter(rowIndex, selectIndex, value) {
            if (dualParameters[rowIndex]) {
                // Á°Æ‰øù dualParameters Êï∞ÁªÑÂ∑≤Ê≠£Á°ÆÂàùÂßãÂåñ
                dualParameters[rowIndex][selectIndex] = value;
                
                // Â¶ÇÊûúÁî®Êà∑ÊâãÂä®‰øÆÊîπ‰∫ÜÂèÇÊï∞ÔºåÊ∏ÖÈô§Ê∏ÖÁ©∫Ê†áËÆ∞
                if (isParametersCleared) {
                    isParametersCleared = false;
                    console.log('Áî®Êà∑‰øÆÊîπÂèÇÊï∞ÔºåÊ∏ÖÈô§Ê∏ÖÁ©∫Ê†áËÆ∞');
                }
                
                // Ë∞ÉËØïÊó•ÂøóÔºàÂèØ‰ª•Âú®ÂºÄÂèëÊó∂Êü•ÁúãÔºâ
                console.log(`Êõ¥Êñ∞ÂèÇÊï∞ [${rowIndex}][${selectIndex}] = "${value}"`);
                console.log('ÂΩìÂâçÊâÄÊúâÂèÇÊï∞:', dualParameters);
            }
        }
        
        // Ê∏ÖÁ©∫ÊâÄÊúâÂèåÂèÇÊï∞
        function clearAllDualParameters() {
            if (dualParameters.length === 0) return;
            
            // Ê∑ªÂä†ÊóãËΩ¨Âä®Áîª
            const resetBtn = document.getElementById('paramResetBtn');
            if (resetBtn) {
                resetBtn.classList.add('spinning');
                // 600ms ÂêéÁßªÈô§Âä®ÁîªÁ±ª
                setTimeout(() => {
                    resetBtn.classList.remove('spinning');
                }, 600);
            }
            
            // Â∞ÜÊâÄÊúâÂèÇÊï∞ËÆæÁΩÆ‰∏∫Á©∫
            for (let i = 0; i < dualParameters.length; i++) {
                dualParameters[i] = ['', ''];
            }
            
            // Ê†áËÆ∞ÂèÇÊï∞Â∑≤Ë¢´Ê∏ÖÁ©∫
            isParametersCleared = true;
            
            // ÈáçÊñ∞Ê∏≤ÊüìÂèÇÊï∞Ë°®Âçï‰ª•ÊòæÁ§∫Á©∫ÂÄº
            renderParameterForm();
            
            console.log('Â∑≤Ê∏ÖÁ©∫ÊâÄÊúâÂèÇÊï∞:', dualParameters);
        }
        
        // ÊÅ¢Â§çÂéüÂßãÂèåÂèÇÊï∞ÔºàÂΩìÈáçÊñ∞ÈÄâÊã©ÂëΩ‰ª§Êó∂Ë∞ÉÁî®Ôºâ
        function restoreOriginalDualParameters() {
            if (originalDualParameters.length > 0 && isParametersCleared) {
                // ÊÅ¢Â§çÂà∞ÂéüÂßãÁä∂ÊÄÅ
                dualParameters = originalDualParameters.map(param => [...param]);
                isParametersCleared = false;
                
                console.log('ÊÅ¢Â§çÂéüÂßãÂèÇÊï∞Áä∂ÊÄÅ:', dualParameters);
            }
        }
        
        // Ê∑ªÂä†Á§∫‰æãÂëΩ‰ª§Âà∞ËÑöÊú¨
        function addExampleToScript(example) {
            if (!checkProjectRequired('Ê∑ªÂä†Á§∫‰æãÂëΩ‰ª§Âà∞ËÑöÊú¨')) return;
            
            // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅÁî®‰∫éÊí§ÈîÄ
            saveScriptState();
            
            // ËÆ°ÁÆóÊúÄ‰Ω≥ÊèíÂÖ•‰ΩçÁΩÆ
            const insertPosition = calculateBestInsertPosition();
            
            // Âú®ÊåáÂÆö‰ΩçÁΩÆÊèíÂÖ•Á§∫‰æãÂëΩ‰ª§
            scriptLines.splice(insertPosition, 0, example);
            
            renderScript();
            
            // Êõ¥Êñ∞È°πÁõÆÁä∂ÊÄÅ
            if (currentProject) {
                currentProject.scriptLines = [...scriptLines];
                currentProject.timestamp = new Date().toISOString();
            }
            
            updateUndoButton();
            
            // Âª∂Ëøü‰∏ÄÁÇπÊó∂Èó¥Á°Æ‰øù DOM Êõ¥Êñ∞ÂÆåÊàêÔºåÁÑ∂ÂêéÊªöÂä®Âà∞Êñ∞ÊèíÂÖ•ÁöÑË°åÂπ∂È´ò‰∫ÆÊòæÁ§∫
            setTimeout(() => {
                scrollToLine(insertPosition);
                highlightNewLine(insertPosition);
            }, 100);
        }

        // Ê∑ªÂä†ÂëΩ‰ª§Âà∞ËÑöÊú¨
        function addCommand() {
            if (!checkProjectRequired('Ê∑ªÂä†ÂëΩ‰ª§Âà∞ËÑöÊú¨')) return;
            if (!selectedCommand) return;
            
            // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅÁî®‰∫éÊí§ÈîÄ
            saveScriptState();
            
            let commandLine = '';
            
            // Ê£ÄÊü•ÊòØÂê¶ÊòØÁî®Êà∑Ëá™ÂÆö‰πâÂëΩ‰ª§
            const isUserCommand = selectedCommand.id && selectedCommand.id.startsWith('user_cmd_');
            
            if (isUserCommand) {
                // Êñ∞ÁöÑÁî®Êà∑Ëá™ÂÆö‰πâÂëΩ‰ª§Ôºö‰ΩøÁî®ÂèåÂèÇÊï∞ÁîüÊàê
                commandLine = selectedCommand.name;
                
                console.log('ÁîüÊàêÂëΩ‰ª§ÂºÄÂßã:', commandLine);
                console.log('dualParameters:', dualParameters);
                
                if (dualParameters && dualParameters.length > 0) {
                    dualParameters.forEach((paramPair, index) => {
                        console.log(`Â§ÑÁêÜÂèÇÊï∞Ë°å ${index}:`, paramPair);
                        
                        // Ê∑ªÂä†ÈùûÁ©∫ÁöÑÂèÇÊï∞ÂÄºÔºàÊ≥®ÊÑèÔºöÁ©∫Â≠óÁ¨¶‰∏≤""Ë°®Á§∫Áî®Êà∑ÈÄâÊã©‰∫ÜÁ©∫ÁôΩÈÄâÈ°πÔºâ
                        if (paramPair[0] && paramPair[0].trim() !== '') {
                            commandLine += ` ${paramPair[0]}`;
                            console.log(`Ê∑ªÂä†ÂèÇÊï∞Ê°Ü1: "${paramPair[0]}"`);
                        }
                        if (paramPair[1] && paramPair[1].trim() !== '') {
                            commandLine += ` ${paramPair[1]}`;
                            console.log(`Ê∑ªÂä†ÂèÇÊï∞Ê°Ü2: "${paramPair[1]}"`);
                        }
                    });
                }
                
                console.log('ÊúÄÁªàÂëΩ‰ª§:', commandLine);
                
            } else if (selectedCommand.template) {
                // ÊóßÁâàÁî®Êà∑Ê®°ÊùøÊñπÂºèÔºà‰øùÊåÅÂÖºÂÆπÔºâ
                commandLine = selectedCommand.template;
                if (selectedCommand.params) {
                    selectedCommand.params.forEach(param => {
                        const value = parameters[param] || '';
                        const placeholder = `{${param}}`;
                        commandLine = commandLine.replace(new RegExp(placeholder, 'g'), value);
                    });
                }
            } else {
                // È¢ÑÂÆö‰πâÂëΩ‰ª§ÊñπÂºè
                commandLine = selectedCommand.name;
                const template = parameterTemplates[selectedCommand.name] || {};
                
                if (selectedCommand.params) {
                    selectedCommand.params.forEach(param => {
                        const value = parameters[param] || template[param]?.default || '';
                        if (value) commandLine += ` ${value}`;
                    });
                }
            }
            
            // Ê∏ÖÁêÜÂ§ö‰ΩôÁöÑÁ©∫Ê†º
            commandLine = commandLine.replace(/\s+/g, ' ').trim();
            
            // ËÆ°ÁÆóÊúÄ‰Ω≥ÊèíÂÖ•‰ΩçÁΩÆ
            const insertPosition = calculateBestInsertPosition();
            
            // Âú®ÊåáÂÆö‰ΩçÁΩÆÊèíÂÖ•Êñ∞ÂëΩ‰ª§
            scriptLines.splice(insertPosition, 0, commandLine);
            
            renderScript();
            
            // ‰∏çÊ∏ÖÁ©∫ÂèÇÊï∞Áä∂ÊÄÅÔºåËÆ©Áî®Êà∑ÂèØ‰ª•ÈáçÂ§ç‰ΩøÁî®Áõ∏ÂêåÂèÇÊï∞
            // parameters = {};
            // dualParameters = [];
            
            // Êõ¥Êñ∞È°πÁõÆÁä∂ÊÄÅ
            if (currentProject) {
                currentProject.scriptLines = [...scriptLines];
                currentProject.timestamp = new Date().toISOString();
            }
            
            updateUndoButton();
            
            // Âª∂Ëøü‰∏ÄÁÇπÊó∂Èó¥Á°Æ‰øù DOM Êõ¥Êñ∞ÂÆåÊàêÔºåÁÑ∂ÂêéÊªöÂä®Âà∞Êñ∞ÊèíÂÖ•ÁöÑË°åÂπ∂È´ò‰∫ÆÊòæÁ§∫
            setTimeout(() => {
                scrollToLine(insertPosition);
                highlightNewLine(insertPosition);
            }, 100);
        }

        // È´ò‰∫ÆÊòæÁ§∫Êñ∞ÊèíÂÖ•ÁöÑË°å
        function highlightNewLine(index) {
            const scriptLineElements = document.querySelectorAll('.script-line');
            if (scriptLineElements[index]) {
                const lineElement = scriptLineElements[index];
                
                // Ê∑ªÂä†È´ò‰∫ÆÊïàÊûú
                lineElement.style.backgroundColor = '#3b82f6';
                lineElement.style.color = 'white';
                lineElement.style.transform = 'scale(1.02)';
                lineElement.style.transition = 'all 0.3s ease';
                
                // 1.5ÁßíÂêéÁßªÈô§È´ò‰∫ÆÊïàÊûú
                setTimeout(() => {
                    lineElement.style.backgroundColor = '';
                    lineElement.style.color = '';
                    lineElement.style.transform = '';
                    lineElement.style.transition = 'all 0.5s ease';
                }, 1500);
            }
        }

        // Ê∏≤ÊüìËÑöÊú¨
        function renderScript() {
            const container = document.getElementById('scriptContent');
            const lineCount = document.getElementById('lineCount');
            
            lineCount.textContent = `${scriptLines.length} ${t('lines')}`;
            
            if (scriptLines.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üëÅÔ∏è</div>
                        <p>${t('scriptEmpty')}</p>
                        <p style="font-size: 12px; margin-top: 8px; color: #9ca3af;">${t('addAfterCommand')}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="drag-hint" id="dragHint">
                    <span>‚ãÆ‚ãÆ</span>
                    <span>${t('dragHint')}</span>
                </div>
                <div class="script-lines" id="scriptLines">
                    ${scriptLines.map((line, index) => {
                        const step = getCommandStep(line);
                        const stepClass = stepToClassMapping[step] || 'step-init';
                        const formattedLine = formatScriptLine(line);
                        return `
                            <div class="script-line ${stepClass}" draggable="true" data-index="${index}" data-step="${step}" ondblclick="editScriptLine(${index})">
                                <div style="display: flex; align-items: center; flex: 1;">
                                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                                    <span class="line-number" style="color: #9ca3af; margin-right: 8px; font-size: 11px; min-width: 20px;">${index + 1}.</span>
                                    <span class="line-content">${formattedLine}</span>
                                </div>
                                <button class="delete-btn" data-index="${index}">√ó</button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            // ‰∏∫Âà†Èô§ÊåâÈíÆÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
            const deleteButtons = document.querySelectorAll('.delete-btn');
            deleteButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const index = parseInt(this.dataset.index);
                    removeScriptLine(index);
                });
            });
            
            // Ê∑ªÂä†ÊãñÊãΩ‰∫ã‰ª∂ÁõëÂê¨
            setupDragAndDrop();
            
            // Êõ¥Êñ∞Êí§ÈîÄÊåâÈíÆÁä∂ÊÄÅ
            updateUndoButton();
        }

        // Âà†Èô§ËÑöÊú¨Ë°å
        function removeScriptLine(index) {
            // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅÁî®‰∫éÊí§ÈîÄ
            saveScriptState();
            
            scriptLines.splice(index, 1);
            renderScript();
            updateUndoButton();
        }

        // Ê∏ÖÁ©∫ËÑöÊú¨
        function clearScript() {
            if (!checkProjectRequired('Ê∏ÖÁ©∫ËÑöÊú¨')) return;
            if (scriptLines.length > 0) {
                // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅÁî®‰∫éÊí§ÈîÄ
                saveScriptState();
                
                scriptLines = [];
                renderScript();
                updateUndoButton();
            }
        }

        // ÊèíÂÖ•Êñ∞Ë°åÂäüËÉΩ
        function insertNewLine() {
            if (!checkProjectRequired('ÊèíÂÖ•Êñ∞Ë°å')) return;
            // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅÁî®‰∫éÊí§ÈîÄ
            saveScriptState();
            
            // Âú®Êú´Â∞æÊ∑ªÂä†Á©∫Ë°å
            scriptLines.push('');
            
            // ÈáçÊñ∞Ê∏≤ÊüìËÑöÊú¨
            renderScript();
            
            // Êõ¥Êñ∞È°πÁõÆÁä∂ÊÄÅ
            if (currentProject) {
                currentProject.scriptLines = [...scriptLines];
                currentProject.timestamp = new Date().toISOString();
            }
            
            updateUndoButton();
            
            // Âª∂Ëøü‰∏ÄÁÇπÊó∂Èó¥Á°Æ‰øùDOMÊõ¥Êñ∞ÂÆåÊàêÔºåÁÑ∂ÂêéËá™Âä®ËøõÂÖ•ÁºñËæëÁä∂ÊÄÅ
            setTimeout(() => {
                const newIndex = scriptLines.length - 1;
                scrollToLine(newIndex);
                editScriptLine(newIndex);
            }, 50);
        }

        // ÊªöÂä®Âà∞ÊåáÂÆöË°å
        function scrollToLine(index) {
            const scriptContent = document.getElementById('scriptContent');
            const scriptLines = document.querySelectorAll('.script-line');
            
            if (scriptLines[index] && scriptContent) {
                // ÊªöÂä®Âà∞ÁõÆÊ†áË°å
                scriptLines[index].scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }
        }

        // ËÆ°ÁÆóÊúÄ‰Ω≥ÊèíÂÖ•‰ΩçÁΩÆ
        function calculateBestInsertPosition() {
            // Ëé∑Âèñ"Ê∑ªÂä†Âà∞ËÑöÊú¨"ÊåâÈíÆÁöÑ‰ΩçÁΩÆ
            const addButton = document.querySelector('.add-command-btn');
            if (!addButton) {
                return scriptLines.length; // Â¶ÇÊûúÊâæ‰∏çÂà∞ÊåâÈíÆÔºåÊèíÂÖ•Âà∞Êú´Â∞æ
            }
            
            const buttonRect = addButton.getBoundingClientRect();
            const buttonCenterY = buttonRect.top + buttonRect.height / 2;
            
            // Ëé∑ÂèñËÑöÊú¨È¢ÑËßàÂå∫Âüü
            const scriptContent = document.getElementById('scriptContent');
            if (!scriptContent) {
                return scriptLines.length; // Â¶ÇÊûúÊâæ‰∏çÂà∞ËÑöÊú¨Âå∫ÂüüÔºåÊèíÂÖ•Âà∞Êú´Â∞æ
            }
            
            const scriptContentRect = scriptContent.getBoundingClientRect();
            
            // Â¶ÇÊûúÊåâÈíÆ‰ΩçÁΩÆÂú®ËÑöÊú¨Âå∫Âüü‰∏äÊñπÔºåÊèíÂÖ•Âà∞ÂºÄÂ§¥
            if (buttonCenterY < scriptContentRect.top) {
                return 0;
            }
            
            // Â¶ÇÊûúÊåâÈíÆ‰ΩçÁΩÆÂú®ËÑöÊú¨Âå∫Âüü‰∏ãÊñπÔºåÊèíÂÖ•Âà∞Êú´Â∞æ
            if (buttonCenterY > scriptContentRect.bottom) {
                return scriptLines.length;
            }
            
            // Ëé∑ÂèñÊâÄÊúâËÑöÊú¨Ë°å
            const scriptLineElements = document.querySelectorAll('.script-line');
            if (scriptLineElements.length === 0) {
                return 0; // Â¶ÇÊûúÊ≤°ÊúâËÑöÊú¨Ë°åÔºåÊèíÂÖ•Âà∞ÂºÄÂ§¥
            }
            
            // ÊâæÂà∞‰∏éÊåâÈíÆ‰ΩçÁΩÆÊúÄÊé•ËøëÁöÑËÑöÊú¨Ë°å
            let bestIndex = scriptLines.length;
            let minDistance = Infinity;
            
            scriptLineElements.forEach((lineElement, index) => {
                const lineRect = lineElement.getBoundingClientRect();
                const lineCenterY = lineRect.top + lineRect.height / 2;
                const distance = Math.abs(buttonCenterY - lineCenterY);
                
                if (distance < minDistance) {
                    minDistance = distance;
                    // Â¶ÇÊûúÊåâÈíÆÂú®ËØ•Ë°å‰∏ãÊñπÔºåÊèíÂÖ•Âà∞ËØ•Ë°åÂêéÈù¢ÔºõÂê¶ÂàôÊèíÂÖ•Âà∞ËØ•Ë°åÂâçÈù¢
                    bestIndex = buttonCenterY > lineCenterY ? index + 1 : index;
                }
            });
            
            // Á°Æ‰øùÊèíÂÖ•‰ΩçÁΩÆÂú®ÊúâÊïàËåÉÂõ¥ÂÜÖ
            return Math.max(0, Math.min(bestIndex, scriptLines.length));
        }

        // ËÆæÁΩÆÊãñÊãΩÂäüËÉΩ
        function setupDragAndDrop() {
            const scriptContainer = document.getElementById('scriptLines');
            const dragHint = document.getElementById('dragHint');
            if (!scriptContainer) return;

            let draggedElement = null;
            let draggedIndex = null;
            let hasUserDragged = localStorage.getItem('hasUserDragged') === 'true';

            // Â¶ÇÊûúÁî®Êà∑Â∑≤ÁªèÊãñÊãΩËøáÔºåÈöêËóèÊèêÁ§∫
            if (hasUserDragged && dragHint) {
                dragHint.classList.add('hidden');
            }

            // ‰∏∫ÊØè‰∏™ËÑöÊú¨Ë°åÊ∑ªÂä†ÊãñÊãΩ‰∫ã‰ª∂
            const scriptLineElements = scriptContainer.querySelectorAll('.script-line');
            
            scriptLineElements.forEach((element, index) => {
                // ÊãñÊãΩÂºÄÂßã
                element.addEventListener('dragstart', function(e) {
                    // Â¶ÇÊûúÊ≠£Âú®ÁºñËæëÔºåÁ¶ÅÊ≠¢ÊãñÊãΩ
                    if (this.classList.contains('editing')) {
                        e.preventDefault();
                        return false;
                    }
                    
                    draggedElement = this;
                    draggedIndex = parseInt(this.dataset.index);
                    this.classList.add('dragging');
                    
                    // ÈöêËóèÊãñÊãΩÊèêÁ§∫Âπ∂ËÆ∞‰ΩèÁî®Êà∑Â∑≤ÁªèÊãñÊãΩËøá
                    if (dragHint && !hasUserDragged) {
                        dragHint.classList.add('hidden');
                        localStorage.setItem('hasUserDragged', 'true');
                        hasUserDragged = true;
                    }
                    
                    // ËÆæÁΩÆÊãñÊãΩÊï∞ÊçÆ
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', this.outerHTML);
                });

                // ÊãñÊãΩÁªìÊùü
                element.addEventListener('dragend', function(e) {
                    this.classList.remove('dragging');
                    
                    // Ê∏ÖÈô§ÊâÄÊúâÊãñÊãΩÁä∂ÊÄÅ
                    scriptLineElements.forEach(el => {
                        el.classList.remove('drag-over');
                    });
                    
                    draggedElement = null;
                    draggedIndex = null;
                });

                // ÊãñÊãΩËøõÂÖ•
                element.addEventListener('dragenter', function(e) {
                    e.preventDefault();
                    if (this !== draggedElement) {
                        this.classList.add('drag-over');
                    }
                });

                // ÊãñÊãΩÁªèËøá
                element.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });

                // ÊãñÊãΩÁ¶ªÂºÄ
                element.addEventListener('dragleave', function(e) {
                    // Âè™ÊúâÂú®ÁúüÊ≠£Á¶ªÂºÄÂÖÉÁ¥†Êó∂ÊâçÁßªÈô§Ê†∑Âºè
                    if (!this.contains(e.relatedTarget)) {
                        this.classList.remove('drag-over');
                    }
                });

                // ÊîæÁΩÆ
                element.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    
                    if (this !== draggedElement && draggedElement) {
                        const targetIndex = parseInt(this.dataset.index);
                        
                        // ÈáçÊñ∞ÊéíÂàóËÑöÊú¨Ë°å
                        moveScriptLine(draggedIndex, targetIndex);
                    }
                });
            });
        }

        // ÁßªÂä®ËÑöÊú¨Ë°å
        function moveScriptLine(fromIndex, toIndex) {
            if (fromIndex === toIndex) return;
            
            // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅÁî®‰∫éÊí§ÈîÄ
            saveScriptState();
            
            // ‰øùÂ≠òË¢´ÁßªÂä®ÁöÑË°å
            const movedLine = scriptLines[fromIndex];
            
            // ‰ªéÂéü‰ΩçÁΩÆÂà†Èô§
            scriptLines.splice(fromIndex, 1);
            
            // ÊèíÂÖ•Âà∞Êñ∞‰ΩçÁΩÆ
            scriptLines.splice(toIndex, 0, movedLine);
            
            // ÈáçÊñ∞Ê∏≤ÊüìËÑöÊú¨
            renderScript();
            
            // Êõ¥Êñ∞È°πÁõÆÁä∂ÊÄÅ
            if (currentProject) {
                currentProject.scriptLines = [...scriptLines];
                currentProject.timestamp = new Date().toISOString();
            }
            
            updateUndoButton();
            
            // ÊòæÁ§∫ÁßªÂä®ÊèêÁ§∫ÔºàÂèØÈÄâÔºâ
            console.log(`ËÑöÊú¨Ë°åÂ∑≤‰ªé‰ΩçÁΩÆ ${fromIndex + 1} ÁßªÂä®Âà∞‰ΩçÁΩÆ ${toIndex + 1}`);
        }

        // ÁºñËæëËÑöÊú¨Ë°å
        function editScriptLine(index) {
            const scriptLines = document.querySelectorAll('.script-line');
            const lineElement = scriptLines[index];
            
            if (!lineElement || lineElement.classList.contains('editing')) {
                return; // Â¶ÇÊûúÂ∑≤ÁªèÂú®ÁºñËæëÁä∂ÊÄÅÔºåÂøΩÁï•
            }
            
            // ÈÄÄÂá∫ÂÖ∂‰ªñÊ≠£Âú®ÁºñËæëÁöÑË°å
            exitAllEditingStates();
            
            const lineContent = lineElement.querySelector('.line-content');
            const deleteBtn = lineElement.querySelector('.delete-btn');
            const currentText = lineContent.textContent;
            
            // Á¶ÅÁî®ÊãñÊãΩ
            lineElement.draggable = false;
            lineElement.classList.add('editing');
            
            // ÊõøÊç¢ÂÜÖÂÆπ‰∏∫ÁºñËæëÁïåÈù¢
            lineContent.innerHTML = `<input type="text" class="edit-input" value="${currentText}">`;
            
            // ÊõøÊç¢Âà†Èô§ÊåâÈíÆ‰∏∫ÁºñËæëÊìç‰ΩúÊåâÈíÆ
            deleteBtn.innerHTML = `
                <div class="edit-actions">
                    <button class="edit-btn save" data-action="save">‚úì</button>
                    <button class="edit-btn cancel" data-action="cancel">‚úï</button>
                </div>
            `;
            
            // ÁßªÈô§ÂéüÊù•ÁöÑonclick‰∫ã‰ª∂
            deleteBtn.onclick = null;
            
            // ‰∏∫ÁºñËæëÊåâÈíÆÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
            const saveBtn = deleteBtn.querySelector('.edit-btn.save');
            const cancelBtn = deleteBtn.querySelector('.edit-btn.cancel');
            
            saveBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                saveScriptLine(index);
            });
            
            cancelBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                cancelEdit(index, currentText);
            });
            
            // Ëé∑ÂèñËæìÂÖ•Ê°ÜÂπ∂ËÅöÁÑ¶
            const input = lineElement.querySelector('.edit-input');
            input.focus();
            input.select();
            
            // ÁõëÂê¨ÈîÆÁõò‰∫ã‰ª∂
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveScriptLine(index);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit(index, currentText);
                }
            });
            
            // ÁõëÂê¨Â§±ÂéªÁÑ¶ÁÇπ‰∫ã‰ª∂
            input.addEventListener('blur', function(e) {
                // Âª∂ËøüÊâßË°åÔºå‰ª•‰æøÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂ËÉΩÂ§üËß¶Âèë
                setTimeout(() => {
                    // Ê£ÄÊü•ÁÑ¶ÁÇπÊòØÂê¶Âú®ÁºñËæëÊåâÈíÆ‰∏ä
                    const activeElement = document.activeElement;
                    const isEditButtonFocused = activeElement && 
                        (activeElement.classList.contains('edit-btn') || 
                         activeElement.closest('.edit-actions'));
                    
                    // Âè™ÊúâÂú®ÁÑ¶ÁÇπ‰∏çÂú®ÁºñËæëÊåâÈíÆ‰∏ä‰∏î‰ªçÂú®ÁºñËæëÁä∂ÊÄÅÊó∂ÊâçËá™Âä®‰øùÂ≠ò
                    if (lineElement.classList.contains('editing') && 
                        !lineElement.contains(document.activeElement) &&
                        !isEditButtonFocused) {
                        saveScriptLine(index);
                    }
                }, 150);
            });
        }

        // ‰øùÂ≠òÁºñËæë
        function saveScriptLine(index) {
            const lineElement = document.querySelectorAll('.script-line')[index];
            const input = lineElement.querySelector('.edit-input');
            
            if (!input) return;
            
            const newText = input.value.trim();
            
            // Â¶ÇÊûúÁî®Êà∑ËæìÂÖ•‰∏∫Á©∫ÔºåÂà†Èô§Ëøô‰∏ÄË°å
            if (newText === '') {
                // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅÁî®‰∫éÊí§ÈîÄ
                saveScriptState();
                
                // Âà†Èô§Á©∫Ë°å
                scriptLines.splice(index, 1);
                
                // Êõ¥Êñ∞È°πÁõÆÁä∂ÊÄÅ
                if (currentProject) {
                    currentProject.scriptLines = [...scriptLines];
                    currentProject.timestamp = new Date().toISOString();
                }
                
                // ÈáçÊñ∞Ê∏≤ÊüìËÑöÊú¨
                renderScript();
                updateUndoButton();
                return;
            }
            
            // Âè™ÊúâÂΩìÊñáÊú¨ÁúüÊ≠£ÊîπÂèòÊó∂Êâç‰øùÂ≠òÁä∂ÊÄÅ
            if (newText !== scriptLines[index]) {
                // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅÁî®‰∫éÊí§ÈîÄ
                saveScriptState();
                
                // Êõ¥Êñ∞Êï∞ÊçÆ
                scriptLines[index] = newText;
                
                // Êõ¥Êñ∞È°πÁõÆÁä∂ÊÄÅ
                if (currentProject) {
                    currentProject.scriptLines = [...scriptLines];
                    currentProject.timestamp = new Date().toISOString();
                }
                
                updateUndoButton();
            }
            
            // ÈáçÊñ∞Ê∏≤ÊüìËÑöÊú¨
            renderScript();
        }

        // ÂèñÊ∂àÁºñËæë
        function cancelEdit(index, originalText) {
            const lineElement = document.querySelectorAll('.script-line')[index];
            const lineContent = lineElement.querySelector('.line-content');
            const deleteBtn = lineElement.querySelector('.delete-btn');
            
            // ÊÅ¢Â§çÂéüÂßãÁä∂ÊÄÅ
            lineElement.classList.remove('editing');
            lineElement.draggable = true;
            
            // ÊÅ¢Â§çÂéüÂßãÂÜÖÂÆπ
            lineContent.innerHTML = originalText;
            
            // ÊÅ¢Â§çÂà†Èô§ÊåâÈíÆ
            deleteBtn.innerHTML = '√ó';
            deleteBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                removeScriptLine(index);
            };
        }

        // ÈÄÄÂá∫ÊâÄÊúâÁºñËæëÁä∂ÊÄÅ
        function exitAllEditingStates() {
            const editingLines = document.querySelectorAll('.script-line.editing');
            editingLines.forEach((line) => {
                const input = line.querySelector('.edit-input');
                if (input) {
                    const index = parseInt(line.dataset.index);
                    const originalText = scriptLines[index];
                    cancelEdit(index, originalText);
                }
            });
        }

        // Êñ∞Âª∫È°πÁõÆ
        async function newProject() {
            // ÂÖàÊ£ÄÊü•ÊµèËßàÂô®ÊîØÊåÅÔºåÂÜ≥ÂÆö‰ΩøÁî®Âì™ÁßçÊñπÂºè
            const supportsFilePicker = window.showSaveFilePicker;
            
            // Ëé∑ÂèñÈ°πÁõÆÂêçÁß∞
            const name = prompt('ËØ∑ËæìÂÖ•È°πÁõÆÂêçÁß∞Ôºö');
            if (!name || !name.trim()) {
                return; // Áî®Êà∑ÂèñÊ∂àÊàñÊú™ËæìÂÖ•ÂêçÁß∞
            }
            
            const newProjectName = name.trim();
            
            // ÈáçÁΩÆÊâÄÊúâÁä∂ÊÄÅ
            activeCategory = 'ÂàùÂßãËÆæÁΩÆ';
            selectedCommand = null;
            scriptLines = [];
            parameters = {};
            currentFileHandle = null;
            previousScriptState = null;
            commandPositions = {};
            userCommands = {};
            
            // ÂàõÂª∫È°πÁõÆÂØπË±°
            currentProject = {
                name: newProjectName,
                activeCategory: activeCategory,
                selectedCommand: selectedCommand,
                scriptLines: [...scriptLines],
                parameters: {...parameters},
                commandPositions: {...commandPositions},
                userCommands: {...userCommands},
                timestamp: new Date().toISOString()
            };
            
            try {
                if (supportsFilePicker) {
                    // ‰ΩøÁî®Êñá‰ª∂Á≥ªÁªüAPIÔºå‰ΩÜÈúÄË¶ÅÈáçÊñ∞Ëß¶ÂèëÁî®Êà∑ÊâãÂäø
                    // ÊòæÁ§∫‰∏Ä‰∏™Á°ÆËÆ§ÂØπËØùÊ°ÜÊù•ÈáçÊñ∞Ëé∑ÂèñÁî®Êà∑ÊâãÂäø
                    const shouldSaveNow = confirm(`È°πÁõÆ "${newProjectName}" Â∑≤ÂáÜÂ§áÂ•ΩÔºÅ\n\nÁÇπÂáª"Á°ÆÂÆö"ÈÄâÊã©‰øùÂ≠ò‰ΩçÁΩÆÔºåÁÇπÂáª"ÂèñÊ∂à"Á®çÂêéÊâãÂä®‰øùÂ≠ò„ÄÇ`);
                    
                    if (shouldSaveNow) {
                        const fileHandle = await window.showSaveFilePicker({
                            suggestedName: `${newProjectName}.json`,
                            types: [{
                                description: 'LIGGGHTSÈ°πÁõÆÊñá‰ª∂',
                                accept: {
                                    'application/json': ['.json']
                                }
                            }]
                        });
                        
                        currentFileHandle = fileHandle;
                        // Êõ¥Êñ∞ÂÖ®Â±ÄÈ°πÁõÆÂêçÁß∞
                        projectName = newProjectName;
                        await saveToFile();
                        
                        // ÊàêÂäüÂêéÊõ¥Êñ∞ÁïåÈù¢
                        resetInterface();
                        updateToolbarTitle();
                        updateUndoButton();
                        updateInterfaceState();
                        
                        alert(`È°πÁõÆ "${newProjectName}" ÂàõÂª∫Âπ∂‰øùÂ≠òÊàêÂäüÔºÅ`);
                    } else {
                        // Áî®Êà∑ÈÄâÊã©Á®çÂêé‰øùÂ≠òÔºåÂÖàÂàõÂª∫È°πÁõÆ
                        projectName = newProjectName;
                        
                        // Êõ¥Êñ∞ÁïåÈù¢
                        resetInterface();
                        updateToolbarTitle();
                        updateUndoButton();
                        updateInterfaceState();
                        
                        alert(`È°πÁõÆ "${newProjectName}" Â∑≤ÂàõÂª∫ÔºÅ\n\nËØ∑ËÆ∞Âæó‰ΩøÁî®"‰øùÂ≠ò"ÊåâÈíÆ‰øùÂ≠òÈ°πÁõÆÊñá‰ª∂„ÄÇ`);
                    }
                } else {
                    // ÊµèËßàÂô®‰∏çÊîØÊåÅÔºåÁõ¥Êé•‰∏ãËΩΩ
                    projectName = newProjectName;
                    downloadProjectFile();
                    
                    // Êõ¥Êñ∞ÁïåÈù¢
                    resetInterface();
                    updateToolbarTitle();
                    updateUndoButton();
                    updateInterfaceState();
                    
                    alert(`È°πÁõÆ "${newProjectName}" ÂàõÂª∫ÊàêÂäüÔºÅ\nÊ≥®ÊÑèÔºöÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÁõ¥Êé•Êñá‰ª∂‰øùÂ≠ò„ÄÇ`);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    // Áî®Êà∑ÂèñÊ∂à‰∫Ü‰øùÂ≠òÔºåÊÅ¢Â§çÂàùÂßãÁä∂ÊÄÅ
                    projectName = '';
                    currentProject = null;
                    currentFileHandle = null;
                    // ‰∏çÊõ¥Êñ∞ÁïåÈù¢Ôºå‰øùÊåÅÁ¶ÅÁî®Áä∂ÊÄÅ
                } else {
                    console.error('ÂàõÂª∫È°πÁõÆÂ§±Ë¥•:', error);
                    
                    // Â¶ÇÊûúÊòØÁî®Êà∑ÊâãÂäøÈîôËØØÔºåÂÖàÂàõÂª∫È°πÁõÆÔºåÁÑ∂ÂêéÊèêÁ§∫Áî®Êà∑ÊâãÂä®‰øùÂ≠ò
                    if (error.message && error.message.includes('user gesture')) {
                        projectName = newProjectName;
                        
                        // Êõ¥Êñ∞ÁïåÈù¢
                        resetInterface();
                        updateToolbarTitle();
                        updateUndoButton();
                        updateInterfaceState();
                        
                        alert(`È°πÁõÆ "${newProjectName}" Â∑≤ÂàõÂª∫ÔºÅ\n\nÁî±‰∫éÊµèËßàÂô®ÂÆâÂÖ®ÈôêÂà∂ÔºåËØ∑ÁÇπÂáª"‰øùÂ≠ò"ÊåâÈíÆÊâãÂä®‰øùÂ≠òÈ°πÁõÆÊñá‰ª∂„ÄÇ`);
                    } else {
                        alert(`È°πÁõÆÂàõÂª∫Â§±Ë¥•Ôºö${error.message}`);
                        // ÂèëÁîüÈîôËØØÊó∂‰πüÊÅ¢Â§çÂàùÂßãÁä∂ÊÄÅ
                        projectName = '';
                        currentProject = null;
                        currentFileHandle = null;
                    }
                }
            }
        }

        // ‰øùÂ≠òÈ°πÁõÆ
        async function saveProject() {
            if (!projectName) {
                alert('ËØ∑ÂÖàÂàõÂª∫È°πÁõÆÔºÅ');
                return;
            }
            
            // Êõ¥Êñ∞È°πÁõÆÊï∞ÊçÆ
            currentProject = {
                name: projectName,
                activeCategory: activeCategory,
                selectedCommand: selectedCommand,
                scriptLines: [...scriptLines],
                parameters: {...parameters},
                commandPositions: {...commandPositions},
                userCommands: {...userCommands},
                timestamp: new Date().toISOString()
            };
            
            try {
                if (currentFileHandle) {
                    // ÊúâÊñá‰ª∂Âè•ÊüÑÔºåÂ∞ùËØïÁõ¥Êé•Ë¶ÜÁõñ‰øùÂ≠ò
                    try {
                        await saveToFile();
                        alert(`È°πÁõÆ "${projectName}" ‰øùÂ≠òÊàêÂäüÔºÅ`);
                        return; // ‰øùÂ≠òÊàêÂäüÔºåÁõ¥Êé•ËøîÂõû
                    } catch (fileError) {
                        // Â¶ÇÊûúÊòØÊñá‰ª∂ËÆøÈóÆÈîôËØØÔºåÊèêÁ§∫Áî®Êà∑Âπ∂ÈáçÊñ∞ÈÄâÊã©‰ΩçÁΩÆ
                        if (fileError.message.includes('Êñá‰ª∂Â∑≤Ë¢´ÁßªÂä®ÊàñÂà†Èô§')) {
                            const shouldChooseNew = confirm(`‚ö†Ô∏è ${fileError.message}\n\nÁÇπÂáª"Á°ÆÂÆö"ÈÄâÊã©Êñ∞ÁöÑ‰øùÂ≠ò‰ΩçÁΩÆÔºåÁÇπÂáª"ÂèñÊ∂à"ÂèñÊ∂à‰øùÂ≠ò„ÄÇ`);
                            if (!shouldChooseNew) {
                                return; // Áî®Êà∑ÂèñÊ∂à‰øùÂ≠ò
                            }
                            // ÁªßÁª≠ÊâßË°å‰∏ãÈù¢ÁöÑÊñá‰ª∂ÈÄâÊã©ÈÄªËæë
                        } else {
                            // ÂÖ∂‰ªñÈîôËØØÁõ¥Êé•ÊäõÂá∫
                            throw fileError;
                        }
                    }
                }
                
                if (window.showSaveFilePicker) {
                    // Ê≤°ÊúâÊñá‰ª∂Âè•ÊüÑÊàñÊñá‰ª∂Âè•ÊüÑÂ§±ÊïàÔºåÈÄâÊã©‰øùÂ≠ò‰ΩçÁΩÆ
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: `${projectName}.json`,
                        types: [{
                            description: 'LIGGGHTSÈ°πÁõÆÊñá‰ª∂',
                            accept: {
                                'application/json': ['.json']
                            }
                        }]
                    });
                    
                    currentFileHandle = fileHandle;
                    await saveToFile();
                    alert(`È°πÁõÆ "${projectName}" ‰øùÂ≠òÊàêÂäüÔºÅ`);
                } else {
                    // ÊµèËßàÂô®‰∏çÊîØÊåÅÔºå‰ΩøÁî®‰∏ãËΩΩÊñπÂºè
                    downloadProjectFile();
                    alert(`È°πÁõÆ "${projectName}" Â∑≤‰∏ãËΩΩÔºÅ`);
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('‰øùÂ≠òÈ°πÁõÆÂ§±Ë¥•:', error);
                    alert(`‰øùÂ≠òÈ°πÁõÆÂ§±Ë¥•Ôºö${error.message}`);
                }
            }
        }

        // ‰øùÂ≠òÂà∞Êñá‰ª∂Ôºà‰ΩøÁî®Êñá‰ª∂Âè•ÊüÑÔºâ
        async function saveToFile() {
            if (!currentFileHandle) {
                throw new Error('Ê≤°ÊúâÊñá‰ª∂Âè•ÊüÑ');
            }
            
            try {
                const dataStr = JSON.stringify(currentProject, null, 2);
                const writable = await currentFileHandle.createWritable();
                await writable.write(dataStr);
                await writable.close();
            } catch (error) {
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÊñá‰ª∂ËÆøÈóÆÊùÉÈôêÈîôËØØÔºàÊñá‰ª∂Ë¢´ÁßªÂä®/Âà†Èô§Ôºâ
                if (error.name === 'NotAllowedError' || 
                    error.name === 'NotFoundError' || 
                    error.message.includes('not allowed') ||
                    error.message.includes('not found')) {
                    
                    // Ê∏ÖÈô§Êó†ÊïàÁöÑÊñá‰ª∂Âè•ÊüÑ
                    currentFileHandle = null;
                    
                    // ÊäõÂá∫Ëá™ÂÆö‰πâÈîôËØØÔºåÊèê‰æõÊõ¥ÊòéÁ°ÆÁöÑ‰ø°ÊÅØ
                    throw new Error('Êñá‰ª∂Â∑≤Ë¢´ÁßªÂä®ÊàñÂà†Èô§ÔºåÊó†Ê≥ï‰øùÂ≠òÂà∞Âéü‰ΩçÁΩÆ„ÄÇËØ∑ÈÄâÊã©Êñ∞ÁöÑ‰øùÂ≠ò‰ΩçÁΩÆ„ÄÇ');
                } else {
                    // ÂÖ∂‰ªñÈîôËØØÁõ¥Êé•‰º†ÈÄí
                    throw error;
                }
            }
        }

        // ‰∏ãËΩΩÈ°πÁõÆÊñá‰ª∂ÔºàÂõûÈÄÄÊñπÊ°àÔºâ
        function downloadProjectFile() {
            const dataStr = JSON.stringify(currentProject, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${projectName}.json`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
        }

        // ÊâìÂºÄÈ°πÁõÆ
        async function openProject() {
            try {
                if (window.showOpenFilePicker) {
                    // ‰ΩøÁî®Êñá‰ª∂Á≥ªÁªüAPI
                    const [fileHandle] = await window.showOpenFilePicker({
                        types: [{
                            description: 'LIGGGHTSÈ°πÁõÆÊñá‰ª∂',
                            accept: {
                                'application/json': ['.json']
                            }
                        }]
                    });
                    
                    const file = await fileHandle.getFile();
                    const contents = await file.text();
                    const projectData = JSON.parse(contents);
                    
                    // ‰øùÂ≠òÊñá‰ª∂Âè•ÊüÑ‰ª•‰æøÂêéÁª≠‰øùÂ≠ò
                    currentFileHandle = fileHandle;
                    
                    loadProject(projectData);
                } else {
                    // ÊµèËßàÂô®‰∏çÊîØÊåÅÔºå‰ΩøÁî®‰º†ÁªüÊñπÂºè
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.style.display = 'none';
                    
                    input.onchange = function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                try {
                                    const projectData = JSON.parse(e.target.result);
                                    // ‰º†ÁªüÊñπÂºèÊâìÂºÄÁöÑÊñá‰ª∂Êó†Ê≥ïËé∑ÂèñÂè•ÊüÑ
                                    currentFileHandle = null;
                                    loadProject(projectData);
                                } catch (error) {
                                    alert('È°πÁõÆÊñá‰ª∂Ê†ºÂºèÈîôËØØÔºÅ');
                                }
                            };
                            reader.readAsText(file);
                        }
                    };
                    
                    document.body.appendChild(input);
                    input.click();
                    document.body.removeChild(input);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    // Áî®Êà∑ÂèñÊ∂à‰∫ÜÊñá‰ª∂ÈÄâÊã©
                    return;
                } else {
                    console.error('ÊâìÂºÄÈ°πÁõÆÂ§±Ë¥•:', error);
                    alert('ÊâìÂºÄÈ°πÁõÆÂ§±Ë¥•ÔºÅ');
                }
            }
        }

        // Âä†ËΩΩÈ°πÁõÆ
        function loadProject(projectData) {
            // È™åËØÅÈ°πÁõÆÊï∞ÊçÆ
            if (!projectData.name) {
                alert('È°πÁõÆÊñá‰ª∂Ê†ºÂºèÈîôËØØÔºöÁº∫Â∞ëÈ°πÁõÆÂêçÁß∞ÔºÅ');
                return;
            }
            
            // ÊÅ¢Â§çÈ°πÁõÆÁä∂ÊÄÅ
            currentProject = projectData;
            projectName = projectData.name;
            activeCategory = projectData.activeCategory || 'ÂàùÂßãËÆæÁΩÆ';
            selectedCommand = projectData.selectedCommand || null;
            scriptLines = [...(projectData.scriptLines || [])];
            parameters = {...(projectData.parameters || {})};
            // ÂÖºÂÆπÊóßÁâàÊú¨Ôºö‰ºòÂÖà‰ΩøÁî®Êñ∞ÁöÑcommandPositionsÔºåÂõûÈÄÄÂà∞commandOrders
            commandPositions = {...(projectData.commandPositions || projectData.commandOrders || {})}; 
            userCommands = {...(projectData.userCommands || {})}; // ÊÅ¢Â§çÁî®Êà∑ÂëΩ‰ª§
            previousScriptState = null; // ÈáçÁΩÆÊí§ÈîÄÁä∂ÊÄÅ
            
            // Á°Æ‰øùÁî®Êà∑ÂëΩ‰ª§‰ΩøÁî®Êñ∞Ê†ºÂºèÔºàÂÖºÂÆπÊÄßÂ§ÑÁêÜÔºâ
            ensureCommandsNewFormat();
            
            // ÈáçÊñ∞Ê∏≤ÊüìÁïåÈù¢
            resetInterface();
            updateToolbarTitle();
            updateUndoButton();
            updateInterfaceState(); // Êõ¥Êñ∞ÁïåÈù¢Áä∂ÊÄÅ
            
            // ÊÅ¢Â§çÂΩìÂâçÂàÜÁ±ªÊ†áÁ≠æ
            switchTab(activeCategory);
            
            // Êõ¥Êñ∞Ê†áÁ≠æËÆ°Êï∞
            updateTabCounts();
            
            // ÊÅ¢Â§çËÑöÊú¨ÊòæÁ§∫
            renderScript();
            
            // ÊÅ¢Â§çÂëΩ‰ª§ÈÄâ‰∏≠Áä∂ÊÄÅ
            if (selectedCommand) {
                setTimeout(() => {
                    document.querySelectorAll('.command-card').forEach(card => {
                        // Á≤æÁ°ÆÂåπÈÖçÂëΩ‰ª§ÂêçÁß∞
                        const cardCommandName = card.querySelector('.command-name');
                        if (cardCommandName && cardCommandName.textContent.trim() === selectedCommand.name) {
                            card.classList.add('selected');
                        }
                    });
                    renderParameterForm();
                }, 100);
            }
            
            // Ê†πÊçÆÊòØÂê¶ÊúâÊñá‰ª∂Âè•ÊüÑÊòæÁ§∫‰∏çÂêåÁöÑÊèêÁ§∫
            if (currentFileHandle) {
                alert(`È°πÁõÆ "${projectName}" Âä†ËΩΩÊàêÂäüÔºÅ\n‚úÖ ÊîØÊåÅË¶ÜÁõñ‰øùÂ≠ò - ÁÇπÂáª‰øùÂ≠òÊåâÈíÆÂ∞ÜÁõ¥Êé•Êõ¥Êñ∞ÂéüÊñá‰ª∂`);
            } else {
                alert(`È°πÁõÆ "${projectName}" Âä†ËΩΩÊàêÂäüÔºÅ\n‚ö†Ô∏è ‰∏çÊîØÊåÅË¶ÜÁõñ‰øùÂ≠ò - ÁÇπÂáª‰øùÂ≠òÊåâÈíÆÂ∞Ü‰∏ãËΩΩÊñ∞Êñá‰ª∂`);
            }
        }

        // ÈáçÁΩÆÁïåÈù¢
        function resetInterface() {
            // Ê∏ÖÈô§ÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.command-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Ê∏ÖÁ©∫ÊêúÁ¥¢Ê°Ü
            document.getElementById('searchInput').value = '';
            
            // ÈáçÊñ∞Ê∏≤ÊüìÊâÄÊúâÁïåÈù¢ÁªÑ‰ª∂
            renderCommands();
            renderParameterForm();
            renderScript(); // Ê∏ÖÁ©∫ËÑöÊú¨Âå∫Âüü
            
            // Êõ¥Êñ∞Ê†áÁ≠æËÆ°Êï∞
            updateTabCounts();
        }

        // Êõ¥Êñ∞Â∑•ÂÖ∑Ê†èÊ†áÈ¢ò
        function updateToolbarTitle() {
            const title = document.querySelector('.toolbar h1');
            if (projectName) {
                title.textContent = `LIGGGHTS ÂèØËßÜÂåñÁïåÈù¢ - ${projectName}`;
            } else {
                title.textContent = 'LIGGGHTS ÂèØËßÜÂåñÁïåÈù¢';
            }
        }

        // ÂØºÂÖ•ËÑöÊú¨
        async function importScript() {
            if (!checkProjectRequired('ÂØºÂÖ•ËÑöÊú¨')) return;
            try {
                if (window.showOpenFilePicker) {
                    // ‰ΩøÁî®Êñá‰ª∂Á≥ªÁªüAPI
                    const [fileHandle] = await window.showOpenFilePicker({
                        types: [{
                            description: 'LIGGGHTSËÑöÊú¨Êñá‰ª∂',
                            accept: {
                                'text/plain': ['.txt', '.in', '.lmp', '.liggghts'],
                                'application/octet-stream': ['.in', '.lmp', '.liggghts']
                            }
                        }]
                    });
                    
                    const file = await fileHandle.getFile();
                    const contents = await file.text();
                    
                    processImportedScript(contents, file.name);
                    
                } else {
                    // ÊµèËßàÂô®‰∏çÊîØÊåÅÔºå‰ΩøÁî®‰º†ÁªüÊñπÂºè
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.txt,.in,.lmp,.liggghts,text/plain';
                    input.style.display = 'none';
                    
                    input.onchange = function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const contents = e.target.result;
                                processImportedScript(contents, file.name);
                            };
                            reader.readAsText(file);
                        }
                    };
                    
                    document.body.appendChild(input);
                    input.click();
                    document.body.removeChild(input);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    // Áî®Êà∑ÂèñÊ∂à‰∫ÜÊñá‰ª∂ÈÄâÊã©
                    return;
                } else {
                    console.error('ÂØºÂÖ•ËÑöÊú¨Â§±Ë¥•:', error);
                    alert('ÂØºÂÖ•ËÑöÊú¨Â§±Ë¥•ÔºÅ');
                }
            }
        }

        // Â§ÑÁêÜÂØºÂÖ•ÁöÑËÑöÊú¨ÂÜÖÂÆπ
        function processImportedScript(contents, fileName) {
            if (!contents || contents.trim() === '') {
                alert('ËÑöÊú¨Êñá‰ª∂‰∏∫Á©∫ÔºÅ');
                return;
            }

            // È¢ÑÂ§ÑÁêÜËÑöÊú¨ÂÜÖÂÆπÔºåËÆ°ÁÆóÊúâÊïàË°åÊï∞
            const lines = contents.split('\n');
            const validLines = lines.filter(line => {
                const trimmedLine = line.trim();
                return trimmedLine && !trimmedLine.startsWith('#') && !trimmedLine.startsWith('//');
            });

            const currentScriptCount = scriptLines.length;
            const importLineCount = validLines.length;
            
            // ÊòæÁ§∫ÂØºÂÖ•ÈÄâÊã©ÂØπËØùÊ°Ü
            let mode = '';
            if (currentScriptCount === 0) {
                // ÂΩìÂâçËÑöÊú¨‰∏∫Á©∫ÔºåÁõ¥Êé•ÂØºÂÖ•
                mode = 'replace';
            } else {
                // ÂΩìÂâçËÑöÊú¨‰∏ç‰∏∫Á©∫ÔºåËÆ©Áî®Êà∑ÈÄâÊã©
                const message = `ËÑöÊú¨Êñá‰ª∂Ôºö"${fileName}"\nÊúâÊïàÂëΩ‰ª§Ë°åÊï∞Ôºö${importLineCount} Ë°å\nÂΩìÂâçËÑöÊú¨Ë°åÊï∞Ôºö${currentScriptCount} Ë°å\n\nËØ∑ÈÄâÊã©ÂØºÂÖ•Ê®°ÂºèÔºö`;
                
                const choice = prompt(message + '\n\nËæìÂÖ• "1" = ÊõøÊç¢ÂΩìÂâçËÑöÊú¨\nËæìÂÖ• "2" = ËøΩÂä†Âà∞ÂΩìÂâçËÑöÊú¨\nËæìÂÖ•ÂÖ∂‰ªñ = ÂèñÊ∂àÂØºÂÖ•', '1');
                
                if (choice === '1') {
                    mode = 'replace';
                } else if (choice === '2') {
                    mode = 'append';
                } else {
                    alert('Â∑≤ÂèñÊ∂àÂØºÂÖ•');
                    return;
                }
            }
            
            if (mode === 'replace') {
                // ÊõøÊç¢ÂΩìÂâçËÑöÊú¨
                scriptLines = [];
            }
            
            // Ê∑ªÂä†ÊúâÊïàË°åÂà∞ËÑöÊú¨
            validLines.forEach(line => {
                scriptLines.push(line.trim());
            });
            
            // Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫
            renderScript();
            
            // Êõ¥Êñ∞È°πÁõÆÁä∂ÊÄÅ
            if (currentProject) {
                currentProject.scriptLines = [...scriptLines];
                currentProject.timestamp = new Date().toISOString();
            }
            
            // ÈáçÁΩÆÊí§ÈîÄÁä∂ÊÄÅÔºåÂõ†‰∏∫ËøôÊòØÂØºÂÖ•Êìç‰Ωú
            previousScriptState = null;
            updateUndoButton();
            
            // ÊòæÁ§∫ÂØºÂÖ•ÁªìÊûú
            const actionText = mode === 'replace' ? 'ÊõøÊç¢' : 'ËøΩÂä†';
            const resultMessage = `‚úÖ ËÑöÊú¨ÂØºÂÖ•ÊàêÂäüÔºÅ\n\nüìÑ Êñá‰ª∂Ôºö${fileName}\nüîÑ Ê®°ÂºèÔºö${actionText}\nüìù ÂØºÂÖ•Ôºö${importLineCount} Ë°å\nüìä ÊÄªËÆ°Ôºö${scriptLines.length} Ë°å`;
            
            alert(resultMessage);
        }

        // ÂØºÂá∫ËÑöÊú¨
        async function exportScript() {
            if (!checkProjectRequired('ÂØºÂá∫ËÑöÊú¨')) return;
            if (scriptLines.length === 0) {
                alert('ÂΩìÂâçËÑöÊú¨‰∏∫Á©∫ÔºåÊó†Ê≥ïÂØºÂá∫ÔºÅ\nËØ∑ÂÖàÊ∑ªÂä†‰∏Ä‰∫õÂëΩ‰ª§Âà∞ËÑöÊú¨‰∏≠„ÄÇ');
                return;
            }

            try {
                // ËÆ©Áî®Êà∑ÈÄâÊã©ÂØºÂá∫Ê†ºÂºè
                const format = prompt('ÈÄâÊã©ÂØºÂá∫Ê†ºÂºèÔºö\n\nËæìÂÖ• "1" = LIGGGHTSËæìÂÖ•Êñá‰ª∂ (.in)\nËæìÂÖ• "2" = ÊñáÊú¨Êñá‰ª∂ (.txt)\nËæìÂÖ• "3" = LAMMPSËÑöÊú¨ (.lmp)\nËæìÂÖ•ÂÖ∂‰ªñ = ÂèñÊ∂àÂØºÂá∫', '1');
                
                let fileExtension = '';
                let fileDescription = '';
                
                switch (format) {
                    case '1':
                        fileExtension = '.in';
                        fileDescription = 'LIGGGHTSËæìÂÖ•Êñá‰ª∂';
                        break;
                    case '2':
                        fileExtension = '.txt';
                        fileDescription = 'ÊñáÊú¨Êñá‰ª∂';
                        break;
                    case '3':
                        fileExtension = '.lmp';
                        fileDescription = 'LAMMPSËÑöÊú¨Êñá‰ª∂';
                        break;
                    default:
                        alert('Â∑≤ÂèñÊ∂àÂØºÂá∫');
                        return;
                }

                // ÁîüÊàêËÑöÊú¨ÂÜÖÂÆπ
                const scriptContent = generateScriptContent(fileExtension);
                
                // Á°ÆÂÆöÊñá‰ª∂Âêç
                let fileName = projectName ? `${projectName}${fileExtension}` : `liggghts_script${fileExtension}`;
                
                if (window.showSaveFilePicker) {
                    // ‰ΩøÁî®Êñá‰ª∂Á≥ªÁªüAPI
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: fileName,
                        types: [{
                            description: fileDescription,
                            accept: {
                                'text/plain': [fileExtension]
                            }
                        }]
                    });
                    
                    const writable = await fileHandle.createWritable();
                    await writable.write(scriptContent);
                    await writable.close();
                    
                    alert(`‚úÖ ËÑöÊú¨ÂØºÂá∫ÊàêÂäüÔºÅ\n\nüìÑ Êñá‰ª∂Ôºö${fileName}\nüìù Ë°åÊï∞Ôºö${scriptLines.length} Ë°å\nüíæ Â∑≤‰øùÂ≠òÂà∞ÊåáÂÆö‰ΩçÁΩÆ`);
                    
                } else {
                    // ÊµèËßàÂô®‰∏çÊîØÊåÅÔºå‰ΩøÁî®‰∏ãËΩΩÊñπÂºè
                    downloadScriptFile(scriptContent, fileName);
                    alert(`‚úÖ ËÑöÊú¨ÂØºÂá∫ÊàêÂäüÔºÅ\n\nüìÑ Êñá‰ª∂Ôºö${fileName}\nüìù Ë°åÊï∞Ôºö${scriptLines.length} Ë°å\nüì• Â∑≤‰∏ãËΩΩÂà∞ÈªòËÆ§‰ΩçÁΩÆ`);
                }
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    // Áî®Êà∑ÂèñÊ∂à‰∫ÜÊñá‰ª∂‰øùÂ≠ò
                    return;
                } else {
                    console.error('ÂØºÂá∫ËÑöÊú¨Â§±Ë¥•:', error);
                    alert('ÂØºÂá∫ËÑöÊú¨Â§±Ë¥•ÔºÅ');
                }
            }
        }

        // ÁîüÊàêËÑöÊú¨ÂÜÖÂÆπ
        function generateScriptContent(fileExtension) {
            const now = new Date();
            const timestamp = now.toLocaleString();
            
            let content = '';
            
            // Ê∑ªÂä†Êñá‰ª∂Â§¥Ê≥®Èáä
            content += `# ${fileExtension === '.in' ? 'LIGGGHTS Input Script' : fileExtension === '.lmp' ? 'LAMMPS Script' : 'Script'}\n`;
            content += `# Generated by LIGGGHTS ÂèØËßÜÂåñÁïåÈù¢\n`;
            content += `# Project: ${projectName || 'Untitled'}\n`;
            content += `# Created: ${timestamp}\n`;
            content += `# Total Commands: ${scriptLines.length}\n`;
            content += `#\n`;
            content += `# This script was automatically generated from the visual interface.\n`;
            content += `# You can run this script directly with LIGGGHTS/LAMMPS.\n`;
            content += `#\n\n`;
            
            // Ê∑ªÂä†ÂàÜÈöîÁ¨¶
            content += `${'#'.repeat(60)}\n`;
            content += `# SCRIPT CONTENT\n`;
            content += `${'#'.repeat(60)}\n\n`;
            
            // Ê∑ªÂä†ËÑöÊú¨ÂëΩ‰ª§
            scriptLines.forEach((line, index) => {
                content += `${line}\n`;
                
                // Âú®ÂÖ≥ÈîÆÂëΩ‰ª§ÂêéÊ∑ªÂä†Á©∫Ë°å‰ª•ÊèêÈ´òÂèØËØªÊÄß
                const nextLine = scriptLines[index + 1];
                if (line.startsWith('run') || 
                    line.startsWith('minimize') || 
                    line.startsWith('dump') ||
                    line.startsWith('fix') ||
                    (nextLine && (nextLine.startsWith('run') || nextLine.startsWith('minimize')))) {
                    content += '\n';
                }
            });
            
            // Ê∑ªÂä†Êñá‰ª∂Â∞æÊ≥®Èáä
            content += `\n${'#'.repeat(60)}\n`;
            content += `# END OF SCRIPT\n`;
            content += `${'#'.repeat(60)}\n`;
            
            return content;
        }

        // ‰∏ãËΩΩËÑöÊú¨Êñá‰ª∂ÔºàÂõûÈÄÄÊñπÊ°àÔºâ
        function downloadScriptFile(content, fileName) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
        }

        // ÂØºÂÖ•ÂëΩ‰ª§Â∫ì
        async function importCommands() {
            if (!checkProjectRequired('ÂØºÂÖ•ÂëΩ‰ª§Â∫ì')) return;
            
            try {
                if (window.showOpenFilePicker) {
                    // ‰ΩøÁî®Êñá‰ª∂Á≥ªÁªüAPI
                    const [fileHandle] = await window.showOpenFilePicker({
                        types: [{
                            description: 'LIGGGHTSÈ°πÁõÆÊñá‰ª∂',
                            accept: {
                                'application/json': ['.json']
                            }
                        }]
                    });
                    
                    const file = await fileHandle.getFile();
                    const contents = await file.text();
                    const projectData = JSON.parse(contents);
                    
                    processImportedCommands(projectData, file.name);
                    
                } else {
                    // ÊµèËßàÂô®‰∏çÊîØÊåÅÔºå‰ΩøÁî®‰º†ÁªüÊñπÂºè
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.style.display = 'none';
                    
                    input.onchange = function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                try {
                                    const projectData = JSON.parse(e.target.result);
                                    processImportedCommands(projectData, file.name);
                                } catch (error) {
                                    alert('Êñá‰ª∂Ê†ºÂºèÈîôËØØÔºÅËØ∑Á°Æ‰øùÊñá‰ª∂ÊòØÊúâÊïàÁöÑJSONÈ°πÁõÆÊñá‰ª∂„ÄÇ');
                                }
                            };
                            reader.readAsText(file);
                        }
                    };
                    
                    document.body.appendChild(input);
                    input.click();
                    document.body.removeChild(input);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    // Áî®Êà∑ÂèñÊ∂à‰∫ÜÊñá‰ª∂ÈÄâÊã©
                    return;
                } else {
                    console.error('ÂØºÂÖ•ÂëΩ‰ª§Â∫ìÂ§±Ë¥•:', error);
                    alert('ÂØºÂÖ•ÂëΩ‰ª§Â∫ìÂ§±Ë¥•ÔºÅ');
                }
            }
        }

        // Â§ÑÁêÜÂØºÂÖ•ÁöÑÂëΩ‰ª§Â∫ì
        function processImportedCommands(projectData, fileName) {
            if (!projectData || typeof projectData !== 'object') {
                alert('Êñá‰ª∂Ê†ºÂºèÈîôËØØÔºö‰∏çÊòØÊúâÊïàÁöÑJSONÈ°πÁõÆÊñá‰ª∂ÔºÅ');
                return;
            }

            // ÊèêÂèñÂëΩ‰ª§Â∫ìÈÉ®ÂàÜÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®ÂàôËØ¥ÊòéÊòØÁ©∫È°πÁõÆÊàñÊ†ºÂºèÈîôËØØÔºâ
            const commandLibrary = projectData.userCommands || {};
            
            if (!commandLibrary || typeof commandLibrary !== 'object') {
                alert(`ÂØºÂÖ•Â§±Ë¥•ÔºöÈ°πÁõÆÊñá‰ª∂ "${fileName}" ‰∏≠Ê≤°ÊúâÂëΩ‰ª§Â∫ìÔºÅ\n\nÂèØËÉΩÁöÑÂéüÂõ†Ôºö\n1. ËøôÊòØ‰∏Ä‰∏™Á©∫È°πÁõÆÔºàÊ≤°ÊúâËá™ÂÆö‰πâÂëΩ‰ª§Ôºâ\n2. Êñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°Æ\n\nüí° ÊèêÁ§∫ÔºöË¶ÅÂàÜ‰∫´ÂëΩ‰ª§Â∫ìÔºåËØ∑ÂÖàÂú®È°πÁõÆ‰∏≠ÂàõÂª∫‰∏Ä‰∫õËá™ÂÆö‰πâÂëΩ‰ª§„ÄÇ`);
                return;
            }

            let importedCount = 0;
            let totalCommands = 0;
            let categoriesAdded = [];

            // ÈÅçÂéÜÂëΩ‰ª§Â∫ì‰∏≠ÁöÑÊâÄÊúâÂàÜÁ±ª
            Object.keys(commandLibrary).forEach(category => {
                const categoryCommands = commandLibrary[category];
                
                if (!categoryCommands || typeof categoryCommands !== 'object') {
                    console.warn(`Ë∑≥ËøáÊó†ÊïàÂàÜÁ±ª: ${category}`);
                    return;
                }

                // ËÆ°ÁÆóËØ•ÂàÜÁ±ªÁöÑÂëΩ‰ª§ÊÄªÊï∞
                const commandCount = Object.keys(categoryCommands).length;
                totalCommands += commandCount;

                if (commandCount === 0) {
                    return; // Ë∑≥ËøáÁ©∫ÂàÜÁ±ª
                }

                // ÂàùÂßãÂåñÁõÆÊ†áÂàÜÁ±ªÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
                if (!userCommands[category]) {
                    userCommands[category] = {};
                    categoriesAdded.push(category);
                }

                if (!commandPositions[category]) {
                    commandPositions[category] = {};
                }

                // ÂØºÂÖ•ËØ•ÂàÜÁ±ª‰∏ãÁöÑÊâÄÊúâÂëΩ‰ª§Ôºà‰∏çË¶ÜÁõñÔºåÈ¢ùÂ§ñÂ¢ûÂä†Ôºâ
                Object.keys(categoryCommands).forEach(commandId => {
                    const command = categoryCommands[commandId];
                    
                    // È™åËØÅÂëΩ‰ª§ÁªìÊûÑ
                    if (!command || !command.name) {
                        console.warn(`Ë∑≥ËøáÊó†ÊïàÂëΩ‰ª§: ${commandId} in ${category}`);
                        return;
                    }

                    // ÁîüÊàêÊñ∞ÁöÑÂëΩ‰ª§ID‰ª•ÈÅøÂÖçÂÜ≤Á™Å
                    const newCommandId = generateCommandId();
                    
                    // Á°Æ‰øùÂëΩ‰ª§‰ΩøÁî®Êñ∞Ê†ºÂºèÔºàÂÖºÂÆπÊÄßÂ§ÑÁêÜÔºâ
                    const migratedCommand = migrateCommandToNewFormat({
                        ...command,
                        id: newCommandId
                    });

                    // Ê∑ªÂä†ÂëΩ‰ª§Âà∞Â∫ì‰∏≠
                    userCommands[category][newCommandId] = migratedCommand;

                    // ‰∏∫ÂëΩ‰ª§ÂàÜÈÖç‰ΩçÁΩÆÔºàÂ¶ÇÊûúÊ≤°Êúâ‰ΩçÁΩÆ‰ø°ÊÅØÔºâ
                    const availablePos = findFirstAvailablePosition(10, 4, commandPositions[category], Object.values(userCommands[category]));
                    if (availablePos) {
                        commandPositions[category][newCommandId] = availablePos;
                    }

                    importedCount++;
                });
            });

            if (importedCount === 0) {
                alert(`ÂØºÂÖ•Â§±Ë¥•ÔºöÈ°πÁõÆÊñá‰ª∂ "${fileName}" ‰∏≠Ê≤°ÊúâÊúâÊïàÁöÑÂëΩ‰ª§ÔºÅ\n\nÂèØËÉΩÁöÑÂéüÂõ†Ôºö\n1. ÊâÄÊúâÂëΩ‰ª§Ê†ºÂºè‰∏çÊ≠£Á°Æ\n2. ÂëΩ‰ª§Êï∞ÊçÆÊçüÂùè\n\nËØ∑Ê£ÄÊü•È°πÁõÆÊñá‰ª∂ÁöÑÂÆåÊï¥ÊÄß„ÄÇ`);
                return;
            }

            // Á°Æ‰øùÊâÄÊúâÂëΩ‰ª§ÈÉΩ‰ΩøÁî®Êñ∞Ê†ºÂºè
            ensureCommandsNewFormat();

            // ÈáçÊñ∞Ê∏≤ÊüìÁïåÈù¢
            renderCommands();

            // Êõ¥Êñ∞È°πÁõÆÁä∂ÊÄÅ
            updateProjectUserCommands();
            
            // Êõ¥Êñ∞Ê†áÁ≠æËÆ°Êï∞
            updateTabCounts();

            // ÊòæÁ§∫ÂØºÂÖ•ÁªìÊûú
            const categoryInfo = categoriesAdded.length > 0 ? 
                `\nüÜï Êñ∞Â¢ûÂàÜÁ±ª: ${categoriesAdded.join(', ')}` : '';
            
            const resultMessage = `‚úÖ ÂëΩ‰ª§ÂØºÂÖ•ÊàêÂäüÔºÅ\n\nüìÑ È°πÁõÆÊñá‰ª∂Ôºö${fileName}\nüì¶ ÂØºÂÖ•ÂëΩ‰ª§Ôºö${importedCount} ‰∏™\nüìä Êñá‰ª∂ÊÄªÂëΩ‰ª§Ôºö${totalCommands} ‰∏™${categoryInfo}\n\nüí° ÂØºÂÖ•ÁöÑÂëΩ‰ª§Â∑≤Ê∑ªÂä†Âà∞ÊÇ®ÁöÑÂëΩ‰ª§Â∫ì‰∏≠Ôºå‰∏ç‰ºöË¶ÜÁõñÁé∞ÊúâÂëΩ‰ª§„ÄÇ`;
            
            alert(resultMessage);
        }
    </script>
</body>
</html>
