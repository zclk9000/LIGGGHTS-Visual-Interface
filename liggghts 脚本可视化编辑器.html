<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIGGGHTS å¯è§†åŒ–ç•Œé¢</title>
    <style>
        :root {
            /* äº®è‰²ä¸»é¢˜ */
            --bg-primary: #f5f5f5;
            --bg-secondary: white;
            --bg-tertiary: #f9fafb;
            --bg-quaternary: #f3f4f6;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-primary: #e5e5e5;
            --border-secondary: #d1d5db;
            --shadow-primary: rgba(0,0,0,0.1);
            --shadow-secondary: rgba(0,0,0,0.2);
        }

        [data-theme="dark"] {
            /* æš—è‰²ä¸»é¢˜ */
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --bg-quaternary: #4b5563;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-tertiary: #9ca3af;
            --border-primary: #374151;
            --border-secondary: #4b5563;
            --shadow-primary: rgba(0,0,0,0.3);
            --shadow-secondary: rgba(0,0,0,0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .toolbar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px var(--shadow-primary);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .toolbar h1 {
            font-size: 20px;
            font-weight: bold;
            color: var(--text-primary);
            margin-right: 16px;
            transition: color 0.3s ease;
        }
        
        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-gray {
            background: #6b7280;
            color: white;
        }
        
        .btn-gray:hover {
            background: #4b5563;
        }
        
        .btn-green {
            background: #10b981;
            color: white;
        }
        
        .btn-green:hover {
            background: #059669;
        }
        
        .btn-red {
            background: #ef4444;
            color: white;
        }
        
        .btn-red:hover {
            background: #dc2626;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            width: 100%;
        }
        
        .commands-panel {
            flex: 1;
            width: 33.333%;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .search-bar {
            height: 56px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid var(--border-primary);
            background: var(--bg-secondary);
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        
        .search-bar h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            transition: color 0.3s ease;
        }
        
        .search-bar .search-wrapper {
            flex: 1;
            max-width: 280px;
            margin-left: 16px;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            position: relative;
            z-index: 5;
            background: var(--bg-secondary);
        }
        
        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .search-wrapper {
            position: relative;
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            z-index: 10;
            pointer-events: none;
        }
        
        .search-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 16px;
            padding: 2px;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .search-clear:hover {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .search-clear.show {
            display: flex;
        }
        
        .tabs {
            display: flex;
            background: #f9fafb;
            border-bottom: 1px solid #e5e5e5;
            overflow-x: auto;
        }
        
        .tab {
            padding: 12px 16px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            position: relative;
        }
        
        .tab-count {
            background: #e5e7eb;
            color: #6b7280;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            line-height: 1.2;
            margin-left: 4px;
        }
        
        .tab.active .tab-count {
            background: #3b82f6;
            color: white;
        }
        
        .tab:hover {
            color: #374151;
            background: #f3f4f6;
        }
        
        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background: white;
        }
        
        .tab.search-highlight {
            background: #fef3c7;
            color: #d97706;
            border-bottom-color: #f59e0b;
        }
        
        .tab.search-highlight.active {
            background: #fbbf24;
            color: white;
            border-bottom-color: #f59e0b;
        }
        
        .tab-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .commands-grid {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        .commands-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            grid-auto-rows: 120px;
            gap: 12px;
            padding: 16px;
            min-height: 400px;
        }
        
        .grid-cell {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            position: relative;
            transition: all 0.2s ease;
            background: var(--bg-tertiary);
            opacity: 0.3;
        }
        
        .grid-cell.occupied {
            border: 1px solid #e5e5e5;
            background: var(--bg-secondary);
            opacity: 1;
        }
        
        .grid-cell.drop-target {
            border-color: #3b82f6;
            background: #eff6ff;
            opacity: 0.8;
        }
        
        .grid-cell.drop-invalid {
            border-color: #ef4444;
            background: #fef2f2;
            opacity: 0.8;
        }
        
        .grid-cell.add-command {
            border: 2px dashed #3b82f6;
            background: var(--bg-tertiary);
            opacity: 0.6;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .grid-cell.add-command:hover {
            opacity: 0.9;
            border-color: #2563eb;
            background: #eff6ff;
        }
        
        .add-command-icon {
            font-size: 24px;
            color: #3b82f6;
            user-select: none;
        }
        
        .command-card {
            position: absolute;
            top: 4px;
            left: 4px;
            right: 4px;
            bottom: 4px;
            padding: 12px;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .command-card .drag-handle {
            position: absolute;
            top: 4px;
            right: 4px;
            opacity: 0;
            transition: opacity 0.2s;
            user-select: none;
            font-size: 10px;
            cursor: grab;
            z-index: 10;
        }
        
        .command-card .command-actions {
            position: absolute;
            top: 4px;
            right: 4px;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            gap: 2px;
            z-index: 10;
        }
        
        .command-card.selected .command-actions {
            opacity: 1;
        }
        
        .command-action-btn {
            width: 16px;
            height: 16px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .command-action-btn.edit {
            background: #f59e0b;
            color: white;
        }
        
        .command-action-btn.edit:hover {
            background: #d97706;
        }
        
        .command-action-btn.delete {
            background: #ef4444;
            color: white;
        }
        
        .command-action-btn.delete:hover {
            background: #dc2626;
        }
        
        .command-card.dragging {
            z-index: 1000;
            opacity: 0.8;
            transform: rotate(3deg) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .command-card:hover {
            border-color: #d1d5db;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .command-card.selected {
            border-color: #3b82f6;
            background: #eff6ff;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2);
        }
        
        .command-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            font-size: 13px;
            line-height: 1.2;
        }
        
        .command-desc {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            line-height: 1.2;
            flex: 1;
        }
        
        .command-params {
            font-size: 9px;
            color: var(--text-tertiary);
            line-height: 1.1;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .params-panel {
            flex: 1;
            width: 33.333%;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .params-header {
            height: 56px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid var(--border-primary);
            background: var(--bg-secondary);
            box-sizing: border-box;
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }
        
        .params-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        
        .params-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: var(--bg-secondary);
            transition: background-color 0.3s ease;
        }
        
        .params-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .command-info {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: background-color 0.3s ease;
        }
        
        .command-info h3 {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            transition: color 0.3s ease;
        }
        
        .command-info p {
            font-size: 14px;
            color: var(--text-secondary);
            transition: color 0.3s ease;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.5;
        }
        
        .param-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .param-label {
            font-size: 12px;
            font-weight: 400;
            color: #6b7280;
            transition: color 0.3s ease;
            margin-bottom: 4px;
        }
        
        .param-input {
            padding: 8px 12px;
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;
        }
        
        .param-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .add-command-btn {
            width: 100%;
            margin-top: 24px;
            padding: 14px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }
        
        .add-command-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #9ca3af;
            text-align: center;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .script-panel {
            flex: 1;
            width: 33.333%;
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }
        
        .script-header {
            height: 56px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid var(--border-primary);
            background: var(--bg-secondary);
            box-sizing: border-box;
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }
        
        .script-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        
        .script-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #6b7280;
        }
        
        .script-info .btn {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
        }
        
        .script-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: var(--bg-secondary);
            transition: background-color 0.3s ease;
        }
        
        .script-lines {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .script-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9fafb;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            group: hover;
            cursor: move;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .script-line:hover {
            background: #f3f4f6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .script-line.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .script-line.drag-over {
            border-top: 2px solid #3b82f6;
            background: #eff6ff;
        }
        
        .script-line .drag-handle {
            cursor: grab;
            color: #9ca3af;
            margin-right: 8px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .script-line:hover .drag-handle {
            opacity: 1;
        }
        
        .script-line .drag-handle:active {
            cursor: grabbing;
        }
        
        .script-line.editing {
            background: #fff;
            border: 2px solid #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .script-line.editing .drag-handle {
            display: none;
        }
        
        .script-line.editing .line-number {
            color: #3b82f6;
            min-width: 20px;
            flex-shrink: 0;
        }
        
        .script-line.editing .line-content {
            flex: 1;
            min-width: 0;
        }
        
        .edit-input {
            flex: 1;
            width: 100%;
            border: none;
            outline: none;
            background: transparent;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #1f2937;
            padding: 2px 4px;
            min-width: 0;
        }
        
        .edit-actions {
            display: flex;
            gap: 4px;
            opacity: 1;
        }
        
        .edit-btn {
            padding: 2px 6px;
            border: none;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .edit-btn.save {
            background: #10b981;
            color: white;
        }
        
        .edit-btn.save:hover {
            background: #059669;
        }
        
        .edit-btn.cancel {
            background: #6b7280;
            color: white;
        }
        
        .edit-btn.cancel:hover {
            background: #4b5563;
        }
        
        .script-line:hover .delete-btn {
            opacity: 1;
        }
        
        .delete-btn {
            opacity: 0;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            transition: opacity 0.2s;
        }
        
        .delete-btn:hover {
            background: #dc2626;
        }
        
        .script-actions {
            padding: 16px;
            border-top: 1px solid #e5e5e5;
            background: #f9fafb;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .drag-hint {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 12px;
            color: #6b7280;
            padding: 8px;
            background: #f3f4f6;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .drag-hint.hidden {
            display: none;
        }
        
        .step-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px 12px;
            background: #f9fafb;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 11px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            flex-shrink: 0;
        }
        
        /* é¢œè‰²å®šä¹‰ */
        .color-blue { background: #3b82f6; }
        .color-green { background: #10b981; }
        .color-purple { background: #8b5cf6; }
        .color-orange { background: #f59e0b; }
        .color-red { background: #ef4444; }
        .color-indigo { background: #6366f1; }
        .color-gray { background: #6b7280; }
        
        /* æ­¥éª¤èƒŒæ™¯é¢œè‰² */
        .step-init { background: #eff6ff; }          /* åˆå§‹åŒ–è®¾ç½® - æµ…è“è‰² */
        .step-geometry { background: #f0fdf4; }      /* å‡ ä½•å®šä¹‰ - æµ…ç»¿è‰² */
        .step-material { background: #faf5ff; }      /* ææ–™å±æ€§ - æµ…ç´«è‰² */
        .step-particle { background: #fff7ed; }      /* é¢—ç²’è®¾ç½® - æµ…æ©™è‰² */
        .step-solver { background: #fef2f2; }        /* æ±‚è§£æ§åˆ¶ - æµ…çº¢è‰² */
        .step-output { background: #eef2ff; }        /* è¾“å‡ºæ§åˆ¶ - æµ…é›è“è‰² */
        .step-other { background: #f3f4f6; }         /* å…¶å®ƒè®¾ç½® - æµ…ç°è‰² */
        
        /* æš—è‰²ä¸»é¢˜é¢å¤–æ ·å¼ */
        [data-theme="dark"] .tabs {
            background: var(--bg-tertiary);
        }
        
        [data-theme="dark"] .tab {
            color: var(--text-secondary);
        }
        
        [data-theme="dark"] .tab.active {
            background: var(--bg-secondary);
            color: #3b82f6;
        }
        
        [data-theme="dark"] .tab-count {
            background: #374151;
            color: #9ca3af;
        }
        
        [data-theme="dark"] .tab.active .tab-count {
            background: #3b82f6;
            color: white;
        }
        
        [data-theme="dark"] .command-card {
            background: var(--bg-tertiary);
            border-color: var(--border-primary);
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .command-card:hover {
            background: var(--bg-quaternary);
        }
        
        [data-theme="dark"] .search-input {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border-secondary);
        }
        
        [data-theme="dark"] .script-line {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .script-line:hover {
            background: var(--bg-quaternary);
        }
        
        /* æš—è‰²ä¸»é¢˜ä¸‹çš„æ­¥éª¤é¢œè‰² */
        [data-theme="dark"] .step-init { background: #1e3a8a; }      /* æ·±è“è‰² */
        [data-theme="dark"] .step-geometry { background: #166534; }  /* æ·±ç»¿è‰² */
        [data-theme="dark"] .step-material { background: #581c87; }  /* æ·±ç´«è‰² */
        [data-theme="dark"] .step-particle { background: #9a3412; }  /* æ·±æ©™è‰² */
        [data-theme="dark"] .step-solver { background: #991b1b; }    /* æ·±çº¢è‰² */
        [data-theme="dark"] .step-output { background: #3730a3; }    /* æ·±é›è“è‰² */
        [data-theme="dark"] .step-other { background: #4b5563; }     /* æ·±ç°è‰² */
        
        [data-theme="dark"] .script-info {
            color: var(--text-secondary);
        }
        
        [data-theme="dark"] .empty-state {
            color: var(--text-tertiary);
        }
        
        [data-theme="dark"] .script-actions {
            background: var(--bg-tertiary);
            border-color: var(--border-primary);
        }
        
        [data-theme="dark"] .search-icon {
            color: var(--text-tertiary);
        }
        
        [data-theme="dark"] .command-name {
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .command-desc {
            color: var(--text-secondary);
        }
        
        [data-theme="dark"] .command-params {
            color: var(--text-tertiary);
        }
        
        [data-theme="dark"] .param-label {
            color: #d1d5db;
        }
        
        /* å¼¹å‡ºå¼å‘½ä»¤ç¼–è¾‘å™¨ */
        .command-editor-overlay {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-primary);
            box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 2000;
            height: 50vh;
            overflow: hidden;
        }
        
        .command-editor-overlay.show {
            transform: translateY(0);
        }
        
        .command-editor-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-tertiary);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .command-editor-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .command-editor-actions-header {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .command-editor-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .command-editor-close:hover {
            background: var(--bg-quaternary);
        }
        
        .command-editor-content {
            height: calc(50vh - 80px);
            overflow-y: auto;
            padding: 24px;
        }
        
        .command-editor-three-column {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 24px;
            height: 100%;
        }
        
        .command-editor-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .command-editor-column-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-primary);
            margin-bottom: 8px;
        }
        
        .command-editor-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .command-editor-label {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .command-editor-input {
            padding: 12px 16px;
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color 0.2s;
            width: 100%;
        }
        
        .command-editor-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .command-editor-textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .command-editor-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .command-editor-btn.primary {
            background: #10b981;
            color: white;
        }
        
        .command-editor-btn.primary:hover {
            background: #059669;
        }
        
        .command-editor-btn.secondary {
            background: #6b7280;
            color: white;
        }
        
        .command-editor-btn.secondary:hover {
            background: #4b5563;
        }
        
        [data-theme="dark"] .step-legend {
            background: var(--bg-quaternary);
            color: white;
        }
        
        [data-theme="dark"] .legend-item {
            color: white;
        }

        /* ç¼–è¾‘çŠ¶æ€ä¸‹ä¿æŒç™½è‰²èƒŒæ™¯ */
        .script-line.editing {
            background: #fff !important;
            border: 2px solid #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* å‚æ•°å®šä¹‰åŒºæ ·å¼ */
        .parameter-definitions {
            margin-bottom: 12px;
        }
        
        .parameter-row {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            margin-bottom: 8px;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            border: 1px solid var(--border-secondary);
        }
        
        .parameter-row-field {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .parameter-row-field.description {
            flex: 2;
        }
        
        .parameter-row-field.options {
            flex: 1;
        }
        
        .parameter-row-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }
        
        .parameter-row-input {
            padding: 10px 12px;
            border: 1px solid var(--border-secondary);
            border-radius: 4px;
            font-size: 13px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color 0.2s;
            width: 100%;
        }
        
        .parameter-row-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        .parameter-row-remove {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 10px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 22px;
            min-width: 32px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        
        .parameter-row-remove:hover {
            background: #dc2626;
        }
        
        .add-parameter-btn {
            width: 100%;
            margin-top: 8px;
        }
        
        /* å‚æ•°é…ç½®åŒºæ ·å¼ */
        .param-dual-select {
            display: flex;
            gap: 8px;
        }
        
        .param-dual-select .param-input {
            flex: 1;
        }
        
        .examples-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-secondary);
        }
        
        .example-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            border: 1px solid var(--border-secondary);
        }
        
        .example-command {
            flex: 1;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--text-primary);
            background: transparent;
            padding: 0;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å·¥å…·æ  -->
        <div class="toolbar">
            <div class="toolbar-left">
                <h1>LIGGGHTS å¯è§†åŒ–ç•Œé¢</h1>
                <button class="btn btn-primary">â• æ–°å»ºé¡¹ç›®</button>
                <button class="btn btn-gray">ğŸ“ æ‰“å¼€</button>
                <button class="btn btn-gray">ğŸ’¾ ä¿å­˜</button>
                <button class="btn btn-primary" onclick="importCommands()">ğŸ“¦ å¯¼å…¥å‘½ä»¤</button>
            </div>
            <div class="toolbar-right">
                <button class="btn btn-gray" id="languageToggle" onclick="toggleLanguage()">ğŸŒ EN</button>
                <button class="btn btn-gray" id="themeToggle" onclick="toggleTheme()">ğŸŒ™ æš—è‰²</button>
                <button class="btn btn-primary" onclick="importScript()">ğŸ“¥ å¯¼å…¥è„šæœ¬</button>
                <button class="btn btn-green" onclick="exportScript()">â¬‡ï¸ å¯¼å‡ºè„šæœ¬</button>
                <button class="btn btn-green" id="runBtn">â–¶ï¸ è¿è¡Œ</button>
            </div>
        </div>

        <!-- ä¸»è¦å†…å®¹åŒº -->
        <div class="main-content">
            <!-- å·¦ä¾§å‘½ä»¤é€‰æ‹©åŒº -->
            <div class="commands-panel">
                <!-- æœç´¢æ  -->
                <div class="search-bar">
                    <h2>å‘½ä»¤å®šä¹‰</h2>
                    <div class="search-wrapper">
                        <svg class="search-icon" width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                        <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢å‘½ä»¤...">
                        <button class="search-clear" id="searchClear" onclick="clearSearch()">Ã—</button>
                    </div>
                </div>

                <!-- æ¨ªå‘æ ‡ç­¾é¡µ -->
                <div class="tabs" id="tabs">
                    <button class="tab active" data-category="åˆå§‹åŒ–è®¾ç½®">
                        <span class="tab-indicator color-blue"></span>
                        åˆå§‹åŒ–è®¾ç½®
                        <span class="tab-count">0</span>
                    </button>
                    <button class="tab" data-category="å‡ ä½•å®šä¹‰">
                        <span class="tab-indicator color-green"></span>
                        å‡ ä½•å®šä¹‰
                        <span class="tab-count">0</span>
                    </button>
                    <button class="tab" data-category="ææ–™å±æ€§">
                        <span class="tab-indicator color-purple"></span>
                        ææ–™å±æ€§
                        <span class="tab-count">0</span>
                    </button>
                    <button class="tab" data-category="é¢—ç²’è®¾ç½®">
                        <span class="tab-indicator color-orange"></span>
                        é¢—ç²’è®¾ç½®
                        <span class="tab-count">0</span>
                    </button>
                    <button class="tab" data-category="æ±‚è§£æ§åˆ¶">
                        <span class="tab-indicator color-red"></span>
                        æ±‚è§£æ§åˆ¶
                        <span class="tab-count">0</span>
                    </button>
                    <button class="tab" data-category="è¾“å‡ºæ§åˆ¶">
                        <span class="tab-indicator color-indigo"></span>
                        è¾“å‡ºæ§åˆ¶
                        <span class="tab-count">0</span>
                    </button>
                    <button class="tab" data-category="å…¶å®ƒè®¾ç½®">
                        <span class="tab-indicator color-gray"></span>
                        å…¶å®ƒè®¾ç½®
                        <span class="tab-count">0</span>
                    </button>
                </div>

                <!-- å‘½ä»¤ç½‘æ ¼ -->
                <div class="commands-grid">
                    <div class="commands-container" id="commandsContainer">
                        <!-- å‘½ä»¤å¡ç‰‡å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- ä¸­å¤®å‚æ•°é…ç½®åŒº -->
            <div class="params-panel">
                <div class="params-header">
                    <h2>å‚æ•°é…ç½®</h2>
                </div>
                <div class="params-content" id="paramsContent">
                    <div class="empty-state">
                        <div class="empty-icon">âš™ï¸</div>
                        <p>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªå‘½ä»¤å¼€å§‹é…ç½®</p>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§è„šæœ¬é¢„è§ˆ -->
            <div class="script-panel">
                <div class="script-header">
                    <h2>è„šæœ¬é¢„è§ˆ</h2>
                    <div class="script-info">
                        <button class="btn btn-primary" onclick="insertNewLine()" title="åœ¨æœ«å°¾æ’å…¥æ–°è¡Œ">â• æ’å…¥</button>
                        <button class="btn btn-red" onclick="undoLastChange()" id="undoBtn" disabled title="æ’¤é”€ä¸Šæ¬¡æ“ä½œ">â†¶ æ’¤é”€</button>
                        <button class="btn btn-gray" onclick="clearScript()" title="æ¸…ç©ºæ‰€æœ‰è„šæœ¬">ğŸ—‘ï¸ æ¸…ç©º</button>
                        <div style="width: 1px; height: 16px; background: var(--border-primary); margin: 0 4px;"></div>
                        <span>ğŸ“„</span>
                        <span id="lineCount">0 è¡Œ</span>
                    </div>
                </div>
                <div class="script-content" id="scriptContent">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ‘ï¸</div>
                        <p>è„šæœ¬å°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                        <p style="font-size: 12px; margin-top: 8px; color: #9ca3af;">æ·»åŠ å‘½ä»¤åå³å¯é¢„è§ˆ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å‘½ä»¤ç¼–è¾‘å™¨è¦†ç›–å±‚ -->
    <div class="command-editor-overlay" id="commandEditorOverlay">
        <div class="command-editor-header">
            <h3 class="command-editor-title" id="commandEditorTitle">æ–°å»ºå‘½ä»¤</h3>
            <div class="command-editor-actions-header">
                <button class="command-editor-btn secondary" onclick="hideCommandEditor()">å–æ¶ˆ</button>
                <button class="command-editor-btn primary" onclick="saveUserCommand()">ä¿å­˜</button>
                <button class="command-editor-close" onclick="hideCommandEditor()">Ã—</button>
            </div>
        </div>
        <div class="command-editor-content">
            <div class="command-editor-three-column">
                <!-- ç¬¬ä¸€æ ï¼šå‘½ä»¤åç§°å’Œæè¿° -->
                <div class="command-editor-column">
                    <h4 class="command-editor-column-title">å‘½ä»¤ä¿¡æ¯</h4>
                    
                    <div class="command-editor-field">
                        <label class="command-editor-label">å‘½ä»¤åç§°</label>
                        <input type="text" class="command-editor-input" id="commandNameInput" placeholder="è¯·è¾“å…¥å‘½ä»¤åç§°" required>
                    </div>
                    
                    <div class="command-editor-field">
                        <label class="command-editor-label">å‘½ä»¤æè¿°</label>
                        <textarea class="command-editor-input command-editor-textarea" id="commandDescInput" placeholder="è¯·è¾“å…¥å‘½ä»¤æè¿°" rows="5"></textarea>
                    </div>
                </div>
                
                <!-- ç¬¬äºŒæ ï¼šå‚æ•°å®šä¹‰ -->
                <div class="command-editor-column">
                    <h4 class="command-editor-column-title">å‚æ•°å®šä¹‰</h4>
                    
                    <div class="parameter-definitions" id="parameterDefinitions">
                        <!-- åŠ¨æ€å‚æ•°è¡Œå°†åœ¨è¿™é‡Œæ’å…¥ -->
                    </div>
                    <button type="button" class="command-editor-btn secondary" onclick="addParameterRow()" style="width: 100%;">â• æ·»åŠ å‚æ•°</button>
                </div>
                
                <!-- ç¬¬ä¸‰æ ï¼šç¤ºä¾‹å‘½ä»¤ -->
                <div class="command-editor-column">
                    <h4 class="command-editor-column-title">ç¤ºä¾‹å‘½ä»¤</h4>
                    
                    <div class="command-editor-field">
                        <label class="command-editor-label">å‘½ä»¤ç¤ºä¾‹ (æ¯è¡Œä¸€ä¸ªå®Œæ•´å‘½ä»¤)</label>
                        <textarea class="command-editor-input command-editor-textarea" id="commandExamplesInput" placeholder="è¯·è¾“å…¥ç¤ºä¾‹å‘½ä»¤ï¼Œæ¯è¡Œä¸€ä¸ª&#10;ä¾‹å¦‚ï¼š&#10;fix grav all gravity 9.81 vector 0 0 -1&#10;fix grav_x all gravity 5.0 vector 1 0 0" rows="8"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è¯­è¨€æ”¯æŒ
        let currentLanguage = localStorage.getItem('language') || 'zh';
        
        const translations = {
            zh: {
                title: 'LIGGGHTS å¯è§†åŒ–ç•Œé¢',
                newProject: 'â• æ–°å»ºé¡¹ç›®',
                open: 'ğŸ“ æ‰“å¼€',
                save: 'ğŸ’¾ ä¿å­˜',
                importCommands: 'ğŸ“¦ å¯¼å…¥å‘½ä»¤',
                language: 'ğŸŒ EN',
                theme: 'ğŸŒ™ æš—è‰²',
                themeLight: 'â˜€ï¸ äº®è‰²',
                importScript: 'ğŸ“¥ å¯¼å…¥è„šæœ¬',
                exportScript: 'â¬‡ï¸ å¯¼å‡ºè„šæœ¬',
                run: 'â–¶ï¸ è¿è¡Œ',
                stop: 'â¸ï¸ åœæ­¢',
                searchPlaceholder: 'æœç´¢å‘½ä»¤...',
                commandDefinition: 'å‘½ä»¤å®šä¹‰',
                paramConfig: 'å‚æ•°é…ç½®',
                scriptPreview: 'è„šæœ¬é¢„è§ˆ',
                insert: 'â• æ’å…¥',
                undo: 'â†¶ æ’¤é”€',
                clear: 'ğŸ—‘ï¸ æ¸…ç©º',
                lines: 'è¡Œ',
                selectCommand: 'è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªå‘½ä»¤å¼€å§‹é…ç½®',
                scriptEmpty: 'è„šæœ¬å°†åœ¨è¿™é‡Œæ˜¾ç¤º',
                addAfterCommand: 'æ·»åŠ å‘½ä»¤åå³å¯é¢„è§ˆ',
                // åˆ†ç±»åç§°
                initSettings: 'åˆå§‹åŒ–è®¾ç½®',
                geometry: 'å‡ ä½•å®šä¹‰',
                materials: 'ææ–™å±æ€§',
                particles: 'é¢—ç²’è®¾ç½®',
                solver: 'æ±‚è§£æ§åˆ¶',
                output: 'è¾“å‡ºæ§åˆ¶',
                others: 'å…¶å®ƒè®¾ç½®',
                // æ­¥éª¤å›¾ä¾‹
                init: 'åˆå§‹åŒ–',
                geo: 'å‡ ä½•',
                mat: 'ææ–™',
                part: 'é¢—ç²’',
                sol: 'æ±‚è§£',
                out: 'è¾“å‡º',
                other: 'å…¶å®ƒ',
                // ç¼–è¾‘å™¨
                newCommand: 'æ–°å»ºå‘½ä»¤',
                editCommand: 'ç¼–è¾‘å‘½ä»¤',
                commandInfo: 'å‘½ä»¤ä¿¡æ¯',
                commandName: 'å‘½ä»¤åç§°',
                commandDesc: 'å‘½ä»¤æè¿°',
                paramDef: 'å‚æ•°å®šä¹‰',
                exampleCommands: 'ç¤ºä¾‹å‘½ä»¤',
                addParam: 'â• æ·»åŠ å‚æ•°',
                cancel: 'å–æ¶ˆ',
                saveCmd: 'ä¿å­˜',
                addToScript: 'ç”Ÿæˆå¹¶æ·»åŠ åˆ°è„šæœ¬',
                // æç¤ºä¿¡æ¯
                dragHint: 'æ‹–æ‹½è„šæœ¬è¡Œå¯è°ƒæ•´æ‰§è¡Œé¡ºåº â€¢ åŒå‡»å¯ç¼–è¾‘å†…å®¹ â€¢ ä¸åŒé¢œè‰²è¡¨ç¤ºä¸åŒæ­¥éª¤',
                createProjectFirst: 'è¯·å…ˆåˆ›å»ºæˆ–æ‰“å¼€ä¸€ä¸ªé¡¹ç›®',
                needProjectToSave: 'éœ€è¦é¡¹ç›®æ‰èƒ½ä¿å­˜è‡ªå®šä¹‰å‘½ä»¤'
            },
            en: {
                title: 'LIGGGHTS Visual Interface',
                newProject: 'â• New Project',
                open: 'ğŸ“ Open',
                save: 'ğŸ’¾ Save',
                importCommands: 'ğŸ“¦ Import Commands',
                language: 'ğŸŒ ä¸­æ–‡',
                theme: 'ğŸŒ™ Dark',
                themeLight: 'â˜€ï¸ Light',
                importScript: 'ğŸ“¥ Import Script',
                exportScript: 'â¬‡ï¸ Export Script',
                run: 'â–¶ï¸ Run',
                stop: 'â¸ï¸ Stop',
                searchPlaceholder: 'Search commands...',
                commandDefinition: 'Command Definition',
                paramConfig: 'Parameter Configuration',
                scriptPreview: 'Script Preview',
                insert: 'â• Insert',
                undo: 'â†¶ Undo',
                clear: 'ğŸ—‘ï¸ Clear',
                lines: 'lines',
                selectCommand: 'Please select a command from the left to start configuration',
                scriptEmpty: 'Script will be displayed here',
                addAfterCommand: 'Preview available after adding commands',
                // åˆ†ç±»åç§°
                initSettings: 'Initialization',
                geometry: 'Geometry',
                materials: 'Materials',
                particles: 'Particles',
                solver: 'Solver',
                output: 'Output',
                others: 'Others',
                // æ­¥éª¤å›¾ä¾‹
                init: 'Init',
                geo: 'Geom',
                mat: 'Mater',
                part: 'Parti',
                sol: 'Solve',
                out: 'Output',
                other: 'Other',
                // ç¼–è¾‘å™¨
                newCommand: 'New Command',
                editCommand: 'Edit Command',
                commandInfo: 'Command Information',
                commandName: 'Command Name',
                commandDesc: 'Command Description',
                paramDef: 'Parameter Definition',
                exampleCommands: 'Example Commands',
                addParam: 'â• Add Parameter',
                cancel: 'Cancel',
                saveCmd: 'Save',
                addToScript: 'Generate and Add to Script',
                // æç¤ºä¿¡æ¯
                dragHint: 'Drag script lines to reorder â€¢ Double-click to edit â€¢ Different colors represent different steps',
                createProjectFirst: 'Please create or open a project first',
                needProjectToSave: 'Project required to save custom commands'
            }
        };

        // è·å–å½“å‰è¯­è¨€çš„æ–‡æœ¬
        function t(key) {
            return translations[currentLanguage][key] || key;
        }

        // åˆ‡æ¢è¯­è¨€
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'zh' ? 'en' : 'zh';
            localStorage.setItem('language', currentLanguage);
            updateLanguage();
        }

        // æ›´æ–°ç•Œé¢è¯­è¨€
        function updateLanguage() {
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            document.title = t('title');
            
            // æ›´æ–°å·¥å…·æ 
            document.querySelector('.toolbar h1').textContent = t('title');
            document.querySelector('.btn-primary').innerHTML = t('newProject');
            document.querySelectorAll('.btn-gray')[0].innerHTML = t('open');
            document.querySelectorAll('.btn-gray')[1].innerHTML = t('save');
            document.querySelector('[onclick="importCommands()"]').innerHTML = t('importCommands');
            
            // æ›´æ–°è¯­è¨€æŒ‰é’®
            document.getElementById('languageToggle').innerHTML = t('language');
            updateThemeButton();
            
            document.querySelector('[onclick="importScript()"]').innerHTML = t('importScript');
            document.querySelector('[onclick="exportScript()"]').innerHTML = t('exportScript');
            updateRunButton();
            
            // æ›´æ–°æœç´¢æ¡†
            document.getElementById('searchInput').placeholder = t('searchPlaceholder');
            
            // æ›´æ–°å‘½ä»¤å®šä¹‰æ ‡é¢˜
            document.querySelector('.search-bar h2').textContent = t('commandDefinition');
            
            // æ›´æ–°æ ‡ç­¾é¡µ
            updateTabs();
            
            // æ›´æ–°å‚æ•°é…ç½®åŒºåŸŸ
            document.querySelector('.params-header h2').textContent = t('paramConfig');
            
            // æ›´æ–°è„šæœ¬é¢„è§ˆåŒºåŸŸ
            document.querySelector('.script-header h2').textContent = t('scriptPreview');
            document.querySelector('[onclick="insertNewLine()"]').innerHTML = t('insert');
            document.querySelector('[onclick="clearScript()"]').innerHTML = t('clear');
            
            // æ›´æ–°ç©ºçŠ¶æ€æ–‡æœ¬
            updateEmptyStates();
            
            // æ›´æ–°å‘½ä»¤ç¼–è¾‘å™¨
            updateCommandEditor();
            
            // é‡æ–°æ¸²æŸ“å‘½ä»¤å’Œè„šæœ¬
            renderCommands();
            renderParameterForm();
            renderScript();
        }

        // æ›´æ–°æ ‡ç­¾é¡µ
        function updateTabs() {
            const categories = [
                { key: 'initSettings', dataCategory: 'åˆå§‹åŒ–è®¾ç½®' },
                { key: 'geometry', dataCategory: 'å‡ ä½•å®šä¹‰' },
                { key: 'materials', dataCategory: 'ææ–™å±æ€§' },
                { key: 'particles', dataCategory: 'é¢—ç²’è®¾ç½®' },
                { key: 'solver', dataCategory: 'æ±‚è§£æ§åˆ¶' },
                { key: 'output', dataCategory: 'è¾“å‡ºæ§åˆ¶' },
                { key: 'others', dataCategory: 'å…¶å®ƒè®¾ç½®' }
            ];
            
            const tabs = document.querySelectorAll('.tab');
            categories.forEach((cat, index) => {
                if (tabs[index]) {
                    const currentCount = tabs[index].querySelector('.tab-count')?.textContent || '0';
                    tabs[index].innerHTML = `<span class="tab-indicator ${tabs[index].querySelector('.tab-indicator').className.split(' ')[1]}"></span>${t(cat.key)}<span class="tab-count">${currentCount}</span>`;
                }
            });
            
            // æ›´æ–°è®¡æ•°
            updateTabCounts();
        }
        
        // æ›´æ–°æ ‡ç­¾è®¡æ•°
        function updateTabCounts() {
            const categories = ['åˆå§‹åŒ–è®¾ç½®', 'å‡ ä½•å®šä¹‰', 'ææ–™å±æ€§', 'é¢—ç²’è®¾ç½®', 'æ±‚è§£æ§åˆ¶', 'è¾“å‡ºæ§åˆ¶', 'å…¶å®ƒè®¾ç½®'];
            const tabs = document.querySelectorAll('.tab');
            
            categories.forEach((category, index) => {
                const commandCount = userCommands[category] ? Object.keys(userCommands[category]).length : 0;
                const countElement = tabs[index]?.querySelector('.tab-count');
                if (countElement) {
                    countElement.textContent = commandCount;
                }
            });
        }

        // æ›´æ–°è¿è¡ŒæŒ‰é’®
        function updateRunButton() {
            const runBtn = document.getElementById('runBtn');
            if (runBtn.textContent.includes('è¿è¡Œ') || runBtn.textContent.includes('Run')) {
                runBtn.innerHTML = t('run');
            } else {
                runBtn.innerHTML = t('stop');
            }
        }

        // æ›´æ–°ç©ºçŠ¶æ€
        function updateEmptyStates() {
            // è¿™ä¸ªå‡½æ•°å°†åœ¨æ¸²æŸ“å‡½æ•°ä¸­ä½¿ç”¨ï¼Œç¡®ä¿ç©ºçŠ¶æ€æ–‡æœ¬ä½¿ç”¨æ­£ç¡®çš„è¯­è¨€
        }

        // æ›´æ–°å‘½ä»¤ç¼–è¾‘å™¨æ–‡æœ¬
        function updateCommandEditor() {
            // æ›´æ–°ç¼–è¾‘å™¨é™æ€æ–‡æœ¬
            const cancelBtns = document.querySelectorAll('.command-editor-btn.secondary');
            const saveBtns = document.querySelectorAll('.command-editor-btn.primary');
            
            cancelBtns.forEach(btn => {
                if (btn.textContent.includes('å–æ¶ˆ') || btn.textContent.includes('Cancel')) {
                    btn.textContent = t('cancel');
                }
                if (btn.textContent.includes('æ·»åŠ å‚æ•°') || btn.textContent.includes('Add Parameter')) {
                    btn.innerHTML = t('addParam');
                }
            });
            
            saveBtns.forEach(btn => {
                if (btn.textContent.includes('ä¿å­˜') || btn.textContent.includes('Save')) {
                    btn.textContent = t('saveCmd');
                }
            });

            // æ›´æ–°åˆ—æ ‡é¢˜
            const columnTitles = document.querySelectorAll('.command-editor-column-title');
            if (columnTitles[0]) columnTitles[0].textContent = t('commandInfo');
            if (columnTitles[1]) columnTitles[1].textContent = t('paramDef');
            if (columnTitles[2]) columnTitles[2].textContent = t('exampleCommands');

            // æ›´æ–°è¾“å…¥æ¡†æ ‡ç­¾
            const labels = document.querySelectorAll('.command-editor-label');
            if (labels[0]) labels[0].textContent = t('commandName');
            if (labels[1]) labels[1].textContent = t('commandDesc');
            if (labels[2]) labels[2].textContent = currentLanguage === 'zh' ? 'å‘½ä»¤ç¤ºä¾‹ (æ¯è¡Œä¸€ä¸ªå®Œæ•´å‘½ä»¤)' : 'Command Examples (one per line)';

            // æ›´æ–°placeholders
            const nameInput = document.getElementById('commandNameInput');
            const descInput = document.getElementById('commandDescInput');
            const examplesInput = document.getElementById('commandExamplesInput');
            
            if (nameInput) nameInput.placeholder = currentLanguage === 'zh' ? 'è¯·è¾“å…¥å‘½ä»¤åç§°' : 'Enter command name';
            if (descInput) descInput.placeholder = currentLanguage === 'zh' ? 'è¯·è¾“å…¥å‘½ä»¤æè¿°' : 'Enter command description';
            if (examplesInput) {
                examplesInput.placeholder = currentLanguage === 'zh' ? 
                    'è¯·è¾“å…¥ç¤ºä¾‹å‘½ä»¤ï¼Œæ¯è¡Œä¸€ä¸ª\nä¾‹å¦‚ï¼š\nfix grav all gravity 9.81 vector 0 0 -1\nfix grav_x all gravity 5.0 vector 1 0 0' :
                    'Enter example commands, one per line\nFor example:\nfix grav all gravity 9.81 vector 0 0 -1\nfix grav_x all gravity 5.0 vector 1 0 0';
            }
        }

        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        let currentTheme = localStorage.getItem('theme') || 'light';
        
        // åˆå§‹åŒ–ä¸»é¢˜
        function initTheme() {
            document.documentElement.setAttribute('data-theme', currentTheme);
            updateThemeButton();
        }
        
        // åˆ‡æ¢ä¸»é¢˜
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            updateThemeButton();
        }
        
        // æ›´æ–°ä¸»é¢˜æŒ‰é’®æ–‡æœ¬
        function updateThemeButton() {
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                if (currentTheme === 'dark') {
                    themeToggle.innerHTML = t('themeLight');
                } else {
                    themeToggle.innerHTML = t('theme');
                }
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ä¸»é¢˜å’Œè¯­è¨€
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            updateLanguage();
        });

        // å‘½ä»¤æ•°æ®
        const commandCategories = {
            'åˆå§‹åŒ–è®¾ç½®': [
                { name: 'dimension', desc: 'è®¾ç½®ç»´åº¦', params: ['dimension'] },
                { name: 'units', desc: 'è®¾ç½®å•ä½ç³»ç»Ÿ', params: ['units'] },
                { name: 'atom_style', desc: 'åŸå­ç±»å‹', params: ['style'] },
                { name: 'boundary', desc: 'è¾¹ç•Œæ¡ä»¶', params: ['x', 'y', 'z'] },
                { name: 'newton', desc: 'ç‰›é¡¿ç¬¬ä¸‰å®šå¾‹', params: ['on/off'] }
            ],
            'å‡ ä½•å®šä¹‰': [
                { name: 'region', desc: 'å®šä¹‰åŒºåŸŸ', params: ['ID', 'type', 'args'] },
                { name: 'create_box', desc: 'åˆ›å»ºæ¨¡æ‹Ÿç›’å­', params: ['N', 'region-ID'] },
                { name: 'create_atoms', desc: 'åˆ›å»ºåŸå­', params: ['type', 'style', 'args'] },
                { name: 'lattice', desc: 'æ™¶æ ¼è®¾ç½®', params: ['style', 'scale'] }
            ],
            'ææ–™å±æ€§': [
                { name: 'pair_style', desc: 'å¯¹åŠ¿å‡½æ•°', params: ['style', 'args'] },
                { name: 'pair_coeff', desc: 'å¯¹åŠ¿ç³»æ•°', params: ['I', 'J', 'args'] },
                { name: 'fix wall/gran', desc: 'å£é¢è®¾ç½®', params: ['ID', 'group', 'style'] }
            ],
            'é¢—ç²’è®¾ç½®': [
                { name: 'fix insert', desc: 'é¢—ç²’æ’å…¥', params: ['ID', 'group', 'style'] },
                { name: 'fix gravity', desc: 'é‡åŠ›è®¾ç½®', params: ['ID', 'group', 'gravity'] },
                { name: 'fix nve/sphere', desc: 'çƒå½¢é¢—ç²’ç§¯åˆ†', params: ['ID', 'group'] }
            ],
            'æ±‚è§£æ§åˆ¶': [
                { name: 'timestep', desc: 'æ—¶é—´æ­¥é•¿', params: ['dt'] },
                { name: 'run', desc: 'è¿è¡Œæ­¥æ•°', params: ['N'] },
                { name: 'minimize', desc: 'èƒ½é‡æœ€å°åŒ–', params: ['etol', 'ftol', 'maxiter', 'maxeval'] },
                { name: 'reset_timestep', desc: 'é‡ç½®æ—¶é—´æ­¥', params: ['N'] }
            ],
            'è¾“å‡ºæ§åˆ¶': [
                { name: 'dump', desc: 'è¾“å‡ºdumpæ–‡ä»¶', params: ['ID', 'group', 'style', 'N', 'file'] },
                { name: 'thermo', desc: 'çƒ­åŠ›å­¦è¾“å‡º', params: ['N'] },
                { name: 'thermo_style', desc: 'è¾“å‡ºæ ¼å¼', params: ['style', 'args'] }
            ]
        };

        // å‚æ•°æ¨¡æ¿
        const parameterTemplates = {
            'dimension': { dimension: { type: 'select', options: ['2', '3'], default: '3' } },
            'units': { units: { type: 'select', options: ['lj', 'real', 'metal', 'si', 'cgs'], default: 'si' } },
            'atom_style': { style: { type: 'select', options: ['atomic', 'sphere', 'granular'], default: 'granular' } },
            'timestep': { dt: { type: 'number', default: '0.00001', step: '0.00001' } },
            'run': { N: { type: 'number', default: '10000', step: '1000' } }
        };

        // å…¨å±€çŠ¶æ€
        let activeCategory = 'åˆå§‹åŒ–è®¾ç½®';
        let selectedCommand = null;
        let scriptLines = [];
        let parameters = {};
        let currentProject = null; // å½“å‰é¡¹ç›®ä¿¡æ¯
        let projectName = ''; // é¡¹ç›®åç§°
        let currentFileHandle = null; // å½“å‰æ–‡ä»¶å¥æŸ„
        let previousScriptState = null; // ä¸Šä¸€æ¬¡è„šæœ¬çŠ¶æ€ï¼ˆç”¨äºæ’¤é”€ï¼‰
        let commandPositions = {}; // æ¯ä¸ªåˆ†ç±»çš„å‘½ä»¤ä½ç½®ï¼ˆç½‘æ ¼åæ ‡ï¼‰
        let userCommands = {}; // ç”¨æˆ·è‡ªå®šä¹‰å‘½ä»¤åº“
        // å‘½ä»¤ç¼–è¾‘å™¨çŠ¶æ€
        let currentEditingCommandId = null;
        let currentEditingPosition = null;
        
        // æ˜¾ç¤ºæ·»åŠ å‘½ä»¤ç¼–è¾‘å™¨
        function showAddCommandEditor(row, col) {
            // æ£€æŸ¥æ˜¯å¦æœ‰æ´»åŠ¨é¡¹ç›®
            if (!currentProject || !projectName) {
                const userChoice = confirm('éœ€è¦å…ˆåˆ›å»ºé¡¹ç›®æ‰èƒ½ä¿å­˜è‡ªå®šä¹‰å‘½ä»¤ã€‚\n\nç‚¹å‡»"ç¡®å®š"åˆ›å»ºæ–°é¡¹ç›®ï¼Œç‚¹å‡»"å–æ¶ˆ"è¿”å›ã€‚');
                if (userChoice) {
                    newProject();
                }
                return;
            }
            
            currentEditingCommandId = null;
            currentEditingPosition = { row, col };
            
            document.getElementById('commandEditorTitle').textContent = t('newCommand');
            document.getElementById('commandNameInput').value = '';
            document.getElementById('commandDescInput').value = '';
            document.getElementById('commandExamplesInput').value = '';
            
            // æ¸…ç©ºå‚æ•°è¡Œ
            clearParameterRows();
            
            showCommandEditor();
        }
        
        // æ˜¾ç¤ºç¼–è¾‘å‘½ä»¤ç¼–è¾‘å™¨
        function editUserCommand(commandId) {
            // æ£€æŸ¥æ˜¯å¦æœ‰æ´»åŠ¨é¡¹ç›®
            if (!currentProject || !projectName) {
                alert('éœ€è¦å…ˆåˆ›å»ºæˆ–æ‰“å¼€ä¸€ä¸ªé¡¹ç›®æ‰èƒ½ç¼–è¾‘å‘½ä»¤ã€‚');
                return;
            }
            
            const userCategoryCommands = userCommands[activeCategory] || {};
            const command = userCategoryCommands[commandId];
            
            if (!command) return;
            
            currentEditingCommandId = commandId;
            currentEditingPosition = commandPositions[activeCategory][commandId];
            
            document.getElementById('commandEditorTitle').textContent = t('editCommand');
            document.getElementById('commandNameInput').value = command.name;
            document.getElementById('commandDescInput').value = command.desc || '';
            document.getElementById('commandExamplesInput').value = (command.examples || []).join('\n');
            
            // åŠ è½½å‚æ•°è¡Œæ•°æ®
            loadParameterRows(command.parameterRows || []);
            
            showCommandEditor();
        }
        
        // æ˜¾ç¤ºå‘½ä»¤ç¼–è¾‘å™¨
        function showCommandEditor() {
            const overlay = document.getElementById('commandEditorOverlay');
            overlay.classList.add('show');
            
            // èšç„¦åˆ°å‘½ä»¤åç§°è¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('commandNameInput').focus();
            }, 300);
        }
        
        // éšè—å‘½ä»¤ç¼–è¾‘å™¨
        function hideCommandEditor() {
            const overlay = document.getElementById('commandEditorOverlay');
            overlay.classList.remove('show');
            
            currentEditingCommandId = null;
            currentEditingPosition = null;
        }
        
        // åˆ é™¤ç”¨æˆ·å‘½ä»¤
        function deleteUserCommand(commandId) {
            // æ£€æŸ¥æ˜¯å¦æœ‰æ´»åŠ¨é¡¹ç›®
            if (!currentProject || !projectName) {
                alert('éœ€è¦å…ˆåˆ›å»ºæˆ–æ‰“å¼€ä¸€ä¸ªé¡¹ç›®æ‰èƒ½åˆ é™¤å‘½ä»¤ã€‚');
                return;
            }
            
            const userCategoryCommands = userCommands[activeCategory] || {};
            const command = userCategoryCommands[commandId];
            
            if (!command) return;
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤å‘½ä»¤ "${command.name}" å—ï¼Ÿ`)) {
                // ä»ç”¨æˆ·å‘½ä»¤åº“ä¸­åˆ é™¤
                delete userCategoryCommands[commandId];
                
                // ä»ä½ç½®ä¿¡æ¯ä¸­åˆ é™¤
                if (commandPositions[activeCategory]) {
                    delete commandPositions[activeCategory][commandId];
                }
                
                // å¦‚æœå½“å‰é€‰ä¸­çš„æ˜¯è¿™ä¸ªå‘½ä»¤ï¼Œæ¸…é™¤é€‰ä¸­çŠ¶æ€
                if (selectedCommand && selectedCommand.id === commandId) {
                    selectedCommand = null;
                    parameters = {};
                }
                
                // é‡æ–°æ¸²æŸ“
                renderCommands();
                renderParameterForm();
                
                // æ›´æ–°é¡¹ç›®çŠ¶æ€
                updateProjectUserCommands();
                
                // æ›´æ–°æ ‡ç­¾è®¡æ•°
                updateTabCounts();
            }
        }
        
        // è®¾ç½®å‘½ä»¤ç¼–è¾‘å™¨è¡¨å•äº‹ä»¶
        function setupCommandEditorForm() {
            // ESC é”®å…³é—­ç¼–è¾‘å™¨
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const overlay = document.getElementById('commandEditorOverlay');
                    if (overlay && overlay.classList.contains('show')) {
                        hideCommandEditor();
                    }
                }
            });
        }
        
        // å‚æ•°è¡Œç®¡ç†å‡½æ•°
        let parameterRowCounter = 0;
        
        // æ·»åŠ å‚æ•°è¡Œ
        function addParameterRow() {
            const container = document.getElementById('parameterDefinitions');
            const rowId = `paramRow_${parameterRowCounter++}`;
            
            const rowHTML = `
                <div class="parameter-row" id="${rowId}">
                    <div class="parameter-row-field description">
                        <label class="parameter-row-label">å‚æ•°æè¿°</label>
                        <input type="text" class="parameter-row-input" placeholder="å¦‚ï¼šé‡åŠ›æ–¹å‘" data-field="description">
                    </div>
                    <div class="parameter-row-field options">
                        <label class="parameter-row-label">å‚æ•°æ¡†1</label>
                        <input type="text" class="parameter-row-input" placeholder="å¦‚ï¼šx,y,z" data-field="options1">
                    </div>
                    <div class="parameter-row-field options">
                        <label class="parameter-row-label">å‚æ•°æ¡†2</label>
                        <input type="text" class="parameter-row-input" placeholder="å¦‚ï¼švector,chute" data-field="options2">
                    </div>
                    <button type="button" class="parameter-row-remove" onclick="removeParameterRow('${rowId}')">Ã—</button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', rowHTML);
        }
        
        // åˆ é™¤å‚æ•°è¡Œ
        function removeParameterRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
            }
        }
        
        // è·å–æ‰€æœ‰å‚æ•°è¡Œæ•°æ®
        function getParameterRowsData() {
            const rows = document.querySelectorAll('.parameter-row');
            const parameterRows = [];
            
            rows.forEach(row => {
                const description = row.querySelector('[data-field="description"]').value.trim();
                const options1Text = row.querySelector('[data-field="options1"]').value.trim();
                const options2Text = row.querySelector('[data-field="options2"]').value.trim();
                
                // åªè¦æœ‰ä»»ä½•ä¸€ä¸ªå­—æ®µæœ‰å†…å®¹ï¼Œå°±ä¿å­˜è¿™ä¸€è¡Œï¼ˆä¸å†è¦æ±‚æè¿°å¿…å¡«ï¼‰
                if (description || options1Text || options2Text) {
                    parameterRows.push({
                        description: description || 'å‚æ•°', // å¦‚æœæè¿°ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤æè¿°
                        options1: parseOptionsText(options1Text),
                        options2: parseOptionsText(options2Text)
                    });
                }
            });
            
            return parameterRows;
        }
        
        // è§£æé€‰é¡¹æ–‡æœ¬ï¼Œæ”¯æŒé€—å·ã€ä¸­æ–‡é€—å·ã€oråˆ†éš”
        function parseOptionsText(text) {
            if (!text) return [];
            
            // æ”¯æŒé€—å·ã€ä¸­æ–‡é€—å·ã€orï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰åˆ†éš”
            return text.split(/[,ï¼Œ]|\s+or\s+/i)
                       .map(option => option.trim())
                       .filter(option => option);
        }
        
        // æ¸…ç©ºå‚æ•°è¡Œ
        function clearParameterRows() {
            const container = document.getElementById('parameterDefinitions');
            container.innerHTML = '';
            parameterRowCounter = 0;
        }
        
        // åŠ è½½å‚æ•°è¡Œæ•°æ®
        function loadParameterRows(parameterRows) {
            clearParameterRows();
            
            if (parameterRows && parameterRows.length > 0) {
                parameterRows.forEach(rowData => {
                    addParameterRow();
                    
                    // å¡«å……æœ€åä¸€è¡Œçš„æ•°æ®
                    const lastRow = document.querySelector('.parameter-row:last-child');
                    if (lastRow) {
                        lastRow.querySelector('[data-field="description"]').value = rowData.description || '';
                        lastRow.querySelector('[data-field="options1"]').value = (rowData.options1 || []).join(', ');
                        lastRow.querySelector('[data-field="options2"]').value = (rowData.options2 || []).join(', ');
                    }
                });
            }
        }
        
        // ä¿å­˜ç”¨æˆ·å‘½ä»¤
        function saveUserCommand() {
            // å†æ¬¡æ£€æŸ¥é¡¹ç›®çŠ¶æ€ï¼ˆé˜²æ­¢ç¼–è¾‘è¿‡ç¨‹ä¸­é¡¹ç›®çŠ¶æ€æ”¹å˜ï¼‰
            if (!currentProject || !projectName) {
                alert('ä¿å­˜å¤±è´¥ï¼šéœ€è¦å…ˆåˆ›å»ºé¡¹ç›®æ‰èƒ½ä¿å­˜å‘½ä»¤ï¼');
                hideCommandEditor();
                return;
            }
            
            const name = document.getElementById('commandNameInput').value.trim();
            const desc = document.getElementById('commandDescInput').value.trim();
            const examples = document.getElementById('commandExamplesInput').value.trim();
            
            if (!name) {
                alert('è¯·è¾“å…¥å‘½ä»¤åç§°ï¼');
                return;
            }
            
            // è·å–å‚æ•°è¡Œæ•°æ®
            const parameterRows = getParameterRowsData();
            
            // è§£æç¤ºä¾‹å‘½ä»¤
            const exampleLines = examples ? examples.split('\n').map(line => line.trim()).filter(line => line) : [];
            
            // åˆ›å»ºæˆ–æ›´æ–°å‘½ä»¤
            const commandId = currentEditingCommandId || generateCommandId();
            const position = currentEditingPosition;
            
            // åˆå§‹åŒ–åˆ†ç±»
            if (!userCommands[activeCategory]) {
                userCommands[activeCategory] = {};
            }
            
            if (!commandPositions[activeCategory]) {
                commandPositions[activeCategory] = {};
            }
            
            // ä¿å­˜å‘½ä»¤ï¼ˆæ–°æ•°æ®ç»“æ„ï¼‰
            userCommands[activeCategory][commandId] = {
                id: commandId,
                name: name,
                desc: desc || 'ç”¨æˆ·è‡ªå®šä¹‰å‘½ä»¤',
                parameterRows: parameterRows,
                examples: exampleLines
            };
            
            // ä¿å­˜ä½ç½®
            commandPositions[activeCategory][commandId] = position;
            
            // éšè—ç¼–è¾‘å™¨
            hideCommandEditor();
            
            // é‡æ–°æ¸²æŸ“
            renderCommands();
            
            // æ›´æ–°é¡¹ç›®çŠ¶æ€
            updateProjectUserCommands();
            
            // æ›´æ–°æ ‡ç­¾è®¡æ•°
            updateTabCounts();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            const action = currentEditingCommandId ? 'æ›´æ–°' : 'åˆ›å»º';
            alert(`å‘½ä»¤ "${name}" ${action}æˆåŠŸï¼\n\né¡¹ç›®ï¼š${projectName}`);
        }
        
        // ç”Ÿæˆå‘½ä»¤ID
        function generateCommandId() {
            return 'user_cmd_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // è·å–å‘½ä»¤å‚æ•°æ˜¾ç¤ºæ–‡æœ¬ï¼ˆå…¼å®¹æ–°æ—§æ ¼å¼ï¼‰
        function getCommandParamsDisplay(command) {
            if (command.parameterRows && command.parameterRows.length > 0) {
                // æ–°æ ¼å¼ï¼šå‚æ•°è¡Œ
                const paramCount = command.parameterRows.length;
                const exampleCount = (command.examples || []).length;
                return `å‚æ•°è¡Œ: ${paramCount} | ç¤ºä¾‹: ${exampleCount}`;
            } else if (command.params && command.params.length > 0) {
                // æ—§æ ¼å¼ï¼šå‚æ•°åˆ—è¡¨
                return `å‚æ•°: ${command.params.join(', ')}`;
            } else {
                return 'å‚æ•°: æ— ';
            }
        }
        
        // æ•°æ®æ ¼å¼å…¼å®¹æ€§å¤„ç†
        function migrateCommandToNewFormat(command) {
            // å¦‚æœå·²ç»æ˜¯æ–°æ ¼å¼ï¼Œç›´æ¥è¿”å›
            if (command.parameterRows) {
                return command;
            }
            
            // å¦‚æœæ˜¯æ—§æ ¼å¼ï¼Œè½¬æ¢ä¸ºæ–°æ ¼å¼
            const migratedCommand = {
                id: command.id,
                name: command.name,
                desc: command.desc,
                parameterRows: [],
                examples: []
            };
            
            // å¦‚æœæœ‰æ—§çš„æ¨¡æ¿ï¼Œæ·»åŠ ä¸ºç¤ºä¾‹
            if (command.template) {
                migratedCommand.examples.push(command.template);
            }
            
            // å¦‚æœæœ‰æ—§çš„å‚æ•°ï¼Œå°è¯•è½¬æ¢ï¼ˆè¿™æ˜¯ä¸€ä¸ªç®€å•çš„æ˜ å°„ï¼‰
            if (command.params && command.params.length > 0) {
                // ä¸ºæ¯ä¸ªæ—§å‚æ•°åˆ›å»ºä¸€ä¸ªå‚æ•°è¡Œ
                command.params.forEach(param => {
                    migratedCommand.parameterRows.push({
                        description: `å‚æ•°: ${param}`,
                        options1: [param],
                        options2: []
                    });
                });
            }
            
            return migratedCommand;
        }
        
        // ç¡®ä¿æ‰€æœ‰ç”¨æˆ·å‘½ä»¤éƒ½ä½¿ç”¨æ–°æ ¼å¼
        function ensureCommandsNewFormat() {
            Object.keys(userCommands).forEach(category => {
                const categoryCommands = userCommands[category];
                Object.keys(categoryCommands).forEach(commandId => {
                    categoryCommands[commandId] = migrateCommandToNewFormat(categoryCommands[commandId]);
                });
            });
        }
        
        // æ›´æ–°ç•Œé¢çŠ¶æ€ï¼ˆåŸºäºé¡¹ç›®çŠ¶æ€ï¼‰
        function updateInterfaceState() {
            const hasProject = currentProject && projectName;
            
            // å·¥å…·æ æŒ‰é’®çŠ¶æ€
            const saveBtn = document.querySelector('.toolbar-left .btn-gray:nth-child(4)');
            const importCommandsBtn = document.querySelector('.btn-primary[onclick="importCommands()"]');
            const importScriptBtn = document.querySelector('.btn-primary[onclick="importScript()"]');
            const exportBtn = document.querySelector('.btn-green[onclick="exportScript()"]');
            const runBtn = document.getElementById('runBtn');
            
            // è„šæœ¬åŒºæŒ‰é’®çŠ¶æ€ï¼ˆæ’¤é”€æŒ‰é’®éœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰
            const insertBtn = document.querySelector('.btn-primary[onclick="insertNewLine()"]');
            const undoBtn = document.getElementById('undoBtn');
            const clearBtn = document.querySelector('.btn-gray[onclick="clearScript()"]');
            
            // å‘½ä»¤ç½‘æ ¼å®¹å™¨
            const commandsContainer = document.getElementById('commandsContainer');
            const searchInput = document.getElementById('searchInput');
            const tabs = document.getElementById('tabs');
            
            if (hasProject) {
                // æœ‰é¡¹ç›®æ—¶ï¼šå¯ç”¨æ‰€æœ‰åŠŸèƒ½ï¼ˆé™¤äº†æ’¤é”€æŒ‰é’®ï¼‰
                [saveBtn, importCommandsBtn, importScriptBtn, exportBtn, runBtn, insertBtn, clearBtn].forEach(btn => {
                    if (btn) {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                        btn.style.pointerEvents = 'auto';
                    }
                });
                
                // æ’¤é”€æŒ‰é’®ç‰¹æ®Šå¤„ç†ï¼šå…ˆå¯ç”¨æ ·å¼ï¼Œç„¶åç”± updateUndoButton å†³å®šå®é™…çŠ¶æ€
                if (undoBtn) {
                    undoBtn.style.pointerEvents = 'auto';
                    undoBtn.style.cursor = 'pointer';
                    // ä¸åœ¨è¿™é‡Œè®¾ç½® disabled å’Œ opacityï¼Œç”± updateUndoButton å†³å®š
                }
                
                // å¯ç”¨æœç´¢å’Œæ ‡ç­¾
                if (searchInput) {
                    searchInput.disabled = false;
                    searchInput.style.opacity = '1';
                    searchInput.style.cursor = 'text';
                }
                
                // ç¡®ä¿æœç´¢å›¾æ ‡å¯è§
                const searchIcon = document.querySelector('.search-icon');
                if (searchIcon) {
                    searchIcon.style.opacity = '1';
                }
                
                if (tabs) {
                    tabs.style.pointerEvents = 'auto';
                    tabs.style.opacity = '1';
                }
                
                if (commandsContainer) {
                    commandsContainer.style.pointerEvents = 'auto';
                    commandsContainer.style.opacity = '1';
                }
                
                // æ’¤é”€æŒ‰é’®ç”±å®ƒè‡ªå·±çš„é€»è¾‘å†³å®šçŠ¶æ€
                updateUndoButton();
                
            } else {
                // æ— é¡¹ç›®æ—¶ï¼šç¦ç”¨å¤§éƒ¨åˆ†åŠŸèƒ½
                [saveBtn, importCommandsBtn, importScriptBtn, exportBtn, runBtn, insertBtn, undoBtn, clearBtn].forEach(btn => {
                    if (btn) {
                        btn.disabled = true;
                        btn.style.opacity = '0.4';
                        btn.style.cursor = 'not-allowed';
                        btn.style.pointerEvents = 'none';
                    }
                });
                
                // ç¦ç”¨æœç´¢å’Œæ ‡ç­¾
                if (searchInput) {
                    searchInput.disabled = true;
                    searchInput.style.opacity = '0.4';
                    searchInput.style.cursor = 'not-allowed';
                    searchInput.value = ''; // æ¸…ç©ºæœç´¢
                }
                
                // æœç´¢å›¾æ ‡ä¹Ÿéœ€è¦ç›¸åº”çš„é€æ˜åº¦å¤„ç†
                const searchIcon = document.querySelector('.search-icon');
                if (searchIcon) {
                    searchIcon.style.opacity = '0.4';
                }
                
                if (tabs) {
                    tabs.style.pointerEvents = 'none';
                    tabs.style.opacity = '0.4';
                }
                
                if (commandsContainer) {
                    commandsContainer.style.pointerEvents = 'none';
                    commandsContainer.style.opacity = '0.4';
                }
            }
        }
        
        // æ£€æŸ¥é¡¹ç›®çŠ¶æ€çš„é€šç”¨å‡½æ•°
        function checkProjectRequired(actionName = 'æ­¤æ“ä½œ') {
            if (!currentProject || !projectName) {
                alert(`${actionName}éœ€è¦å…ˆåˆ›å»ºæˆ–æ‰“å¼€ä¸€ä¸ªé¡¹ç›®ã€‚`);
                return false;
            }
            return true;
        }
        
        // æ›´æ–°é¡¹ç›®ä¸­çš„ç”¨æˆ·å‘½ä»¤
        function updateProjectUserCommands() {
            if (currentProject) {
                currentProject.userCommands = {...userCommands};
                currentProject.commandPositions = {...commandPositions};
                currentProject.timestamp = new Date().toISOString();
            }
        }

        // å‘½ä»¤æ­¥éª¤æ˜ å°„
        const commandStepMapping = {
            // åˆå§‹åŒ–è®¾ç½®
            'dimension': 'åˆå§‹åŒ–è®¾ç½®',
            'units': 'åˆå§‹åŒ–è®¾ç½®',
            'atom_style': 'åˆå§‹åŒ–è®¾ç½®',
            'boundary': 'åˆå§‹åŒ–è®¾ç½®',
            'newton': 'åˆå§‹åŒ–è®¾ç½®',
            
            // å‡ ä½•å®šä¹‰
            'region': 'å‡ ä½•å®šä¹‰',
            'create_box': 'å‡ ä½•å®šä¹‰',
            'create_atoms': 'å‡ ä½•å®šä¹‰',
            'lattice': 'å‡ ä½•å®šä¹‰',
            
            // ææ–™å±æ€§
            'pair_style': 'ææ–™å±æ€§',
            'pair_coeff': 'ææ–™å±æ€§',
            'fix wall/gran': 'ææ–™å±æ€§',
            
            // é¢—ç²’è®¾ç½®
            'fix insert': 'é¢—ç²’è®¾ç½®',
            'fix gravity': 'é¢—ç²’è®¾ç½®',
            'fix nve/sphere': 'é¢—ç²’è®¾ç½®',
            
            // æ±‚è§£æ§åˆ¶
            'timestep': 'æ±‚è§£æ§åˆ¶',
            'run': 'æ±‚è§£æ§åˆ¶',
            'minimize': 'æ±‚è§£æ§åˆ¶',
            'reset_timestep': 'æ±‚è§£æ§åˆ¶',
            
            // è¾“å‡ºæ§åˆ¶
            'dump': 'è¾“å‡ºæ§åˆ¶',
            'thermo': 'è¾“å‡ºæ§åˆ¶',
            'thermo_style': 'è¾“å‡ºæ§åˆ¶'
        };

        // æ­¥éª¤åˆ°CSSç±»çš„æ˜ å°„
        const stepToClassMapping = {
            'åˆå§‹åŒ–è®¾ç½®': 'step-init',
            'å‡ ä½•å®šä¹‰': 'step-geometry',
            'ææ–™å±æ€§': 'step-material',
            'é¢—ç²’è®¾ç½®': 'step-particle',
            'æ±‚è§£æ§åˆ¶': 'step-solver',
            'è¾“å‡ºæ§åˆ¶': 'step-output',
            'å…¶å®ƒè®¾ç½®': 'step-other'
        };

        // ä¿å­˜å½“å‰è„šæœ¬çŠ¶æ€ï¼ˆç”¨äºæ’¤é”€ï¼‰
        function saveScriptState() {
            previousScriptState = [...scriptLines];
            updateUndoButton();
        }

        // æ›´æ–°æ’¤é”€æŒ‰é’®çŠ¶æ€
        function updateUndoButton() {
            const undoBtn = document.getElementById('undoBtn');
            if (undoBtn) {
                const canUndo = previousScriptState !== null && previousScriptState.length !== scriptLines.length || 
                               (previousScriptState !== null && JSON.stringify(previousScriptState) !== JSON.stringify(scriptLines));
                undoBtn.disabled = !canUndo;
                undoBtn.style.opacity = canUndo ? '1' : '0.5';
            }
        }

        // æ’¤é”€ä¸Šæ¬¡æ›´æ”¹
        function undoLastChange() {
            if (!checkProjectRequired('æ’¤é”€æ“ä½œ')) return;
            if (previousScriptState !== null) {
                const currentState = [...scriptLines];
                scriptLines = [...previousScriptState];
                previousScriptState = null; // åªèƒ½æ’¤é”€ä¸€æ¬¡
                
                renderScript();
                
                // æ›´æ–°é¡¹ç›®çŠ¶æ€
                if (currentProject) {
                    currentProject.scriptLines = [...scriptLines];
                    currentProject.timestamp = new Date().toISOString();
                }
                
                updateUndoButton();
                
                // æ˜¾ç¤ºæ’¤é”€æç¤º
                const linesDiff = currentState.length - scriptLines.length;
                if (linesDiff > 0) {
                    console.log(`å·²æ’¤é”€ï¼šåˆ é™¤äº† ${linesDiff} è¡Œè„šæœ¬`);
                } else if (linesDiff < 0) {
                    console.log(`å·²æ’¤é”€ï¼šæ·»åŠ äº† ${Math.abs(linesDiff)} è¡Œè„šæœ¬`);
                } else {
                    console.log('å·²æ’¤é”€ï¼šæ¢å¤åˆ°ä¸Šä¸€æ¬¡çŠ¶æ€');
                }
            }
        }

        // è·å–å‘½ä»¤çš„æ­¥éª¤
        function getCommandStep(commandLine) {
            if (!commandLine || typeof commandLine !== 'string') {
                return 'åˆå§‹åŒ–è®¾ç½®'; // é»˜è®¤æ­¥éª¤
            }
            
            const command = commandLine.trim().split(' ')[0];
            
            // æ£€æŸ¥å®Œæ•´å‘½ä»¤å
            if (commandStepMapping[commandLine.trim()]) {
                return commandStepMapping[commandLine.trim()];
            }
            
            // æ£€æŸ¥å‘½ä»¤çš„ç¬¬ä¸€ä¸ªè¯
            if (commandStepMapping[command]) {
                return commandStepMapping[command];
            }
            
            // æ£€æŸ¥å¤åˆå‘½ä»¤ï¼ˆå¦‚ "fix insert"ï¼‰
            const firstTwoWords = commandLine.trim().split(' ').slice(0, 2).join(' ');
            if (commandStepMapping[firstTwoWords]) {
                return commandStepMapping[firstTwoWords];
            }
            
            // ç‰¹æ®Šå¤„ç†fixå‘½ä»¤
            if (command === 'fix') {
                const fixType = commandLine.trim().split(' ')[2];
                if (fixType) {
                    if (fixType.includes('wall') || fixType.includes('gran')) {
                        return 'ææ–™å±æ€§';
                    } else if (fixType.includes('insert')) {
                        return 'é¢—ç²’è®¾ç½®';
                    } else if (fixType.includes('gravity') || fixType.includes('nve')) {
                        return 'é¢—ç²’è®¾ç½®';
                    }
                }
            }
            
            return 'åˆå§‹åŒ–è®¾ç½®'; // é»˜è®¤æ­¥éª¤
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            renderCommands();
            setupEventListeners();
            setupCommandEditorForm();
            updateInterfaceState(); // åˆå§‹åŒ–ç•Œé¢çŠ¶æ€
            updateTabCounts(); // åˆå§‹åŒ–æ ‡ç­¾è®¡æ•°
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ ‡ç­¾åˆ‡æ¢
            document.getElementById('tabs').addEventListener('click', function(e) {
                if (e.target.classList.contains('tab')) {
                    switchTab(e.target.dataset.category);
                }
            });

            // æœç´¢
            document.getElementById('searchInput').addEventListener('input', function(e) {
                const searchTerm = e.target.value;
                updateSearchClearButton(searchTerm);
                performCrossTabSearch(searchTerm);
            });

            // è¿è¡ŒæŒ‰é’®
            document.getElementById('runBtn').addEventListener('click', function() {
                this.classList.toggle('btn-red');
                this.classList.toggle('btn-green');
                if (this.textContent.includes('è¿è¡Œ')) {
                    this.innerHTML = 'â¸ï¸ åœæ­¢';
                } else {
                    this.innerHTML = 'â–¶ï¸ è¿è¡Œ';
                }
            });

            // é¡¹ç›®ç®¡ç†æŒ‰é’®
            setupProjectButtons();
        }

        // è®¾ç½®é¡¹ç›®ç®¡ç†æŒ‰é’®äº‹ä»¶
        function setupProjectButtons() {
            // æ–°å»ºé¡¹ç›®æŒ‰é’®
            document.querySelector('.toolbar-left .btn-primary').addEventListener('click', newProject);
            
            // æ‰“å¼€é¡¹ç›®æŒ‰é’®
            document.querySelector('.toolbar-left .btn-gray:nth-child(3)').addEventListener('click', openProject);
            
            // ä¿å­˜é¡¹ç›®æŒ‰é’®
            document.querySelector('.toolbar-left .btn-gray:nth-child(4)').addEventListener('click', saveProject);
        }

        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(category) {
            activeCategory = category;
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.category === category);
            });
            renderCommands();
        }

        // æ›´æ–°æœç´¢æ¸…é™¤æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        function updateSearchClearButton(searchTerm) {
            const clearBtn = document.getElementById('searchClear');
            if (searchTerm.trim()) {
                clearBtn.classList.add('show');
            } else {
                clearBtn.classList.remove('show');
            }
        }

        // æ¸…é™¤æœç´¢
        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = '';
            updateSearchClearButton('');
            clearSearchHighlights();
            renderCommands();
        }

        // è·¨æ ‡ç­¾æœç´¢
        function performCrossTabSearch(searchTerm) {
            clearSearchHighlights();
            
            if (!searchTerm.trim()) {
                renderCommands();
                return;
            }

            const matchingCategories = [];
            const allCategories = ['åˆå§‹åŒ–è®¾ç½®', 'å‡ ä½•å®šä¹‰', 'ææ–™å±æ€§', 'é¢—ç²’è®¾ç½®', 'æ±‚è§£æ§åˆ¶', 'è¾“å‡ºæ§åˆ¶', 'å…¶å®ƒè®¾ç½®'];
            
            // æœç´¢æ‰€æœ‰åˆ†ç±»ä¸­çš„å‘½ä»¤
            allCategories.forEach(category => {
                const categoryCommands = userCommands[category] || {};
                const hasMatches = Object.values(categoryCommands).some(cmd => 
                    cmd.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    cmd.desc.toLowerCase().includes(searchTerm.toLowerCase())
                );
                
                if (hasMatches) {
                    matchingCategories.push(category);
                }
            });

            if (matchingCategories.length > 0) {
                // é«˜äº®åŒ¹é…çš„æ ‡ç­¾
                highlightSearchTabs(matchingCategories);
                
                // å¦‚æœå½“å‰æ ‡ç­¾æ²¡æœ‰åŒ¹é…ç»“æœï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªæœ‰ç»“æœçš„æ ‡ç­¾
                if (!matchingCategories.includes(activeCategory)) {
                    switchTab(matchingCategories[0]);
                } else {
                    renderCommands(searchTerm);
                }
            } else {
                renderCommands(searchTerm);
            }
        }

        // é«˜äº®æœç´¢åŒ¹é…çš„æ ‡ç­¾
        function highlightSearchTabs(matchingCategories) {
            document.querySelectorAll('.tab').forEach(tab => {
                const category = tab.dataset.category;
                if (matchingCategories.includes(category)) {
                    tab.classList.add('search-highlight');
                } else {
                    tab.classList.remove('search-highlight');
                }
            });
        }

        // æ¸…é™¤æœç´¢é«˜äº®
        function clearSearchHighlights() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('search-highlight');
            });
            document.querySelectorAll('.command-card').forEach(card => {
                card.classList.remove('search-highlight');
            });
        }

        // æ¸²æŸ“å‘½ä»¤ç½‘æ ¼å·¥ä½œå°
        function renderCommands(searchTerm = '') {
            const container = document.getElementById('commandsContainer');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰é¡¹ç›®
            if (!currentProject || !projectName) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1; grid-row: 1 / -1; opacity: 1 !important; margin-top: 430px;">
                        <div class="empty-icon" style="opacity: 1 !important;">ğŸ“</div>
                        <p style="opacity: 1 !important; color: #9ca3af !important;">${t('createProjectFirst')}</p>
                        <p style="font-size: 12px; margin-top: 8px; color: #9ca3af; opacity: 1 !important;">${t('needProjectToSave')}</p>
                    </div>
                `;
                return;
            }
            
            // è·å–ç”¨æˆ·å‘½ä»¤ï¼ˆå¦‚æœä¸ºç©ºåˆ™æ˜¾ç¤ºåˆå§‹çŠ¶æ€ï¼‰
            const userCategoryCommands = userCommands[activeCategory] || {};
            const commands = Object.values(userCategoryCommands);
            
            // è¿‡æ»¤å‘½ä»¤
            const filteredCommands = searchTerm ? commands.filter(cmd => 
                cmd.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                cmd.desc.toLowerCase().includes(searchTerm.toLowerCase())
            ) : commands;

            if (filteredCommands.length === 0 && searchTerm) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1; grid-row: 1 / -1;">
                        <div class="empty-icon">ğŸ”</div>
                        <p>æœªæ‰¾åˆ°åŒ¹é…çš„å‘½ä»¤</p>
                    </div>
                `;
                return;
            }

            // åŠ¨æ€è®¡ç®—ç½‘æ ¼å¤§å°
            const containerWidth = container.clientWidth;
            const cellMinWidth = 280;
            const actualCols = Math.max(2, Math.floor((containerWidth - 32) / (cellMinWidth + 12)));
            const minRows = 3; // æœ€å°‘æ˜¾ç¤º3è¡Œ
            const neededRows = Math.ceil((commands.length + 1) / actualCols); // +1 for add button
            const actualRows = Math.max(minRows, neededRows);
            
            // æ›´æ–°CSSç½‘æ ¼
            container.style.gridTemplateColumns = `repeat(${actualCols}, 1fr)`;
            container.style.gridTemplateRows = `repeat(${actualRows}, 120px)`;
            
            // åˆå§‹åŒ–ä½ç½®ä¿¡æ¯
            if (!commandPositions[activeCategory]) {
                commandPositions[activeCategory] = {};
            }
            
            // æ¸…ç†æ— æ•ˆä½ç½®ï¼ˆè¶…å‡ºç½‘æ ¼èŒƒå›´çš„ï¼‰
            const positions = commandPositions[activeCategory];
            Object.keys(positions).forEach(cmdId => {
                const pos = positions[cmdId];
                if (pos.row >= actualRows || pos.col >= actualCols) {
                    // é‡æ–°åˆ†é…ä½ç½®
                    const availablePos = findFirstAvailablePosition(actualRows, actualCols, positions, commands);
                    if (availablePos) {
                        positions[cmdId] = availablePos;
                    }
                }
            });
            
            // ä¸ºæ–°å‘½ä»¤åˆ†é…ä½ç½®ï¼ˆå¦‚æœæ²¡æœ‰ä½ç½®ä¿¡æ¯ï¼‰
            commands.forEach(cmd => {
                if (!positions[cmd.id]) {
                    const availablePos = findFirstAvailablePosition(actualRows, actualCols, positions, commands);
                    if (availablePos) {
                        positions[cmd.id] = availablePos;
                    }
                }
            });
            
            // æ‰¾åˆ°ç¬¬ä¸€ä¸ªç©ºç™½ä½ç½®ç”¨äºæ”¾ç½®æ·»åŠ æŒ‰é’®
            const addButtonPosition = findFirstAvailablePosition(actualRows, actualCols, positions, commands);
            
            let gridHTML = '';
            
            // ç”Ÿæˆæ‰€æœ‰ç½‘æ ¼å•å…ƒæ ¼
            for (let row = 0; row < actualRows; row++) {
                for (let col = 0; col < actualCols; col++) {
                    const command = findUserCommandAtPosition(row, col, filteredCommands);
                    
                    if (command) {
                        // æœ‰ç”¨æˆ·å‘½ä»¤çš„å•å…ƒæ ¼
                        gridHTML += `
                            <div class="grid-cell occupied" 
                                 data-row="${row}" 
                                 data-col="${col}"
                                 ondrop="handleGridDrop(event, ${row}, ${col})"
                                 ondragover="handleGridDragOver(event)">
                                <div class="command-card" 
                                     draggable="true" 
                                     data-command-id="${command.id}"
                                     onclick="selectUserCommand('${command.id}')"
                                     ondragstart="handleCommandDragStart(event)">
                                    <div class="command-actions">
                                        <button class="command-action-btn edit" onclick="editUserCommand('${command.id}'); event.stopPropagation();">âœ</button>
                                        <button class="command-action-btn delete" onclick="deleteUserCommand('${command.id}'); event.stopPropagation();">âœ•</button>
                                    </div>
                                    <div class="command-name">${command.name}</div>
                                    <div class="command-desc">${command.desc}</div>
                                    <div class="command-params">${getCommandParamsDisplay(command)}</div>
                                </div>
                            </div>
                        `;
                    } else if (!searchTerm && addButtonPosition && row === addButtonPosition.row && col === addButtonPosition.col) {
                        // æ·»åŠ å‘½ä»¤æŒ‰é’®ï¼ˆåªåœ¨éæœç´¢çŠ¶æ€ä¸‹æ˜¾ç¤ºï¼‰
                        gridHTML += `
                            <div class="grid-cell add-command" 
                                 data-row="${row}" 
                                 data-col="${col}"
                                 onclick="showAddCommandEditor(${row}, ${col})">
                                <div class="add-command-icon">â•</div>
                            </div>
                        `;
                    } else {
                        // ç©ºç™½å•å…ƒæ ¼
                        gridHTML += `
                            <div class="grid-cell" 
                                 data-row="${row}" 
                                 data-col="${col}"
                                 ondrop="handleGridDrop(event, ${row}, ${col})"
                                 ondragover="handleGridDragOver(event)">
                            </div>
                        `;
                    }
                }
            }
            
            container.innerHTML = gridHTML;
        }
        
        // æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨ä½ç½®
        function findFirstAvailablePosition(maxRows, maxCols, positions, commands) {
            const occupiedPositions = new Set();
            
            // æ ‡è®°æ‰€æœ‰å·²å ç”¨çš„ä½ç½®
            Object.values(positions).forEach(pos => {
                if (pos && pos.row < maxRows && pos.col < maxCols) {
                    occupiedPositions.add(`${pos.row}-${pos.col}`);
                }
            });
            
            // æ‰¾åˆ°ç¬¬ä¸€ä¸ªç©ºç™½ä½ç½®
            for (let row = 0; row < maxRows; row++) {
                for (let col = 0; col < maxCols; col++) {
                    const posKey = `${row}-${col}`;
                    if (!occupiedPositions.has(posKey)) {
                        return { row, col };
                    }
                }
            }
            
            return null; // æ²¡æœ‰å¯ç”¨ä½ç½®
        }

        // æ ¹æ®ä½ç½®æŸ¥æ‰¾ç”¨æˆ·å‘½ä»¤
        function findUserCommandAtPosition(row, col, commands) {
            const positions = commandPositions[activeCategory] || {};
            return commands.find(cmd => {
                const pos = positions[cmd.id];
                return pos && pos.row === row && pos.col === col;
            });
        }

        // é€‰æ‹©ç”¨æˆ·å‘½ä»¤
        function selectUserCommand(commandId) {
            const userCategoryCommands = userCommands[activeCategory] || {};
            selectedCommand = userCategoryCommands[commandId];
            parameters = {};
            
            // æ¸…ç©ºåŒå‚æ•°çŠ¶æ€ï¼ˆåˆ‡æ¢å‘½ä»¤æ—¶é‡ç½®ï¼‰
            dualParameters = [];
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.command-card').forEach(card => {
                const isSelected = card.dataset.commandId === commandId;
                card.classList.toggle('selected', isSelected);
            });

            renderParameterForm();
        }

        // ç½‘æ ¼æ‹–æ‹½å¤„ç†
        let draggedCommandId = null;
        let draggedFromPosition = null;

        function handleCommandDragStart(event) {
            const commandCard = event.target.closest('.command-card');
            const gridCell = event.target.closest('.grid-cell');
            
            draggedCommandId = commandCard.dataset.commandId;
            draggedFromPosition = {
                row: parseInt(gridCell.dataset.row),
                col: parseInt(gridCell.dataset.col)
            };
            
            // æ·»åŠ æ‹–æ‹½æ ·å¼
            commandCard.classList.add('dragging');
            
            // è®¾ç½®æ‹–æ‹½æ•°æ®
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', commandCard.outerHTML);
            
            // é«˜äº®æ‰€æœ‰å¯æ”¾ç½®çš„åŒºåŸŸ
            document.querySelectorAll('.grid-cell').forEach(cell => {
                cell.classList.add('drop-target');
            });
        }

        function handleGridDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }

        function handleGridDrop(event, targetRow, targetCol) {
            event.preventDefault();
            
            if (!draggedCommandId) return;
            
            const targetPosition = { row: targetRow, col: targetCol };
            const positions = commandPositions[activeCategory];
            
            // æ£€æŸ¥ç›®æ ‡ä½ç½®æ˜¯å¦æœ‰å‘½ä»¤
            const targetCommandId = Object.keys(positions || {}).find(cmdId => {
                const pos = positions[cmdId];
                return pos && pos.row === targetRow && pos.col === targetCol;
            });
            
            if (targetCommandId && targetCommandId !== draggedCommandId) {
                // ç›®æ ‡ä½ç½®æœ‰å…¶ä»–å‘½ä»¤ï¼Œäº¤æ¢ä½ç½®
                const draggedPos = positions[draggedCommandId];
                positions[targetCommandId] = draggedPos;
                positions[draggedCommandId] = targetPosition;
            } else if (!targetCommandId) {
                // ç›®æ ‡ä½ç½®ä¸ºç©ºï¼Œç›´æ¥ç§»åŠ¨
                positions[draggedCommandId] = targetPosition;
            }
            // å¦‚æœç›®æ ‡ä½ç½®æ˜¯è‡ªå·±ï¼Œä»€ä¹ˆéƒ½ä¸åš
            
            // æ¸…ç†æ‹–æ‹½çŠ¶æ€
            cleanupDragState();
            
            // é‡æ–°æ¸²æŸ“
            renderCommands();
            
            // æ›´æ–°é¡¹ç›®çŠ¶æ€
            updateProjectUserCommands();
            
            // æ›´æ–°æ ‡ç­¾è®¡æ•°
            updateTabCounts();
        }

        function cleanupDragState() {
            // æ¸…é™¤æ‰€æœ‰æ‹–æ‹½ç›¸å…³çš„æ ·å¼
            document.querySelectorAll('.command-card.dragging').forEach(card => {
                card.classList.remove('dragging');
            });
            
            document.querySelectorAll('.grid-cell').forEach(cell => {
                cell.classList.remove('drop-target', 'drop-invalid');
            });
            
            draggedCommandId = null;
            draggedFromPosition = null;
        }

        // ç›‘å¬æ‹–æ‹½ç»“æŸäº‹ä»¶
        document.addEventListener('dragend', function(event) {
            if (event.target.classList.contains('command-card')) {
                cleanupDragState();
            }
        });

        // æ›´æ–°é¡¹ç›®ä¸­çš„å‘½ä»¤ä½ç½®
        function updateProjectCommandPositions() {
            if (currentProject) {
                currentProject.commandPositions = {...commandPositions};
                currentProject.timestamp = new Date().toISOString();
            }
        }

        // æ¸²æŸ“å‚æ•°è¡¨å•
        function renderParameterForm() {
            const container = document.getElementById('paramsContent');
            
            if (!selectedCommand) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âš™ï¸</div>
                        <p>${t('selectCommand')}</p>
                    </div>
                `;
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ·è‡ªå®šä¹‰å‘½ä»¤
            const isUserCommand = selectedCommand.id && selectedCommand.id.startsWith('user_cmd_');
            
            if (isUserCommand) {
                // æ–°çš„ç”¨æˆ·è‡ªå®šä¹‰å‘½ä»¤ç»“æ„
                const parameterRows = selectedCommand.parameterRows || [];
                const examples = selectedCommand.examples || [];
                
                // å…ˆåˆå§‹åŒ–å‚æ•°æ•°ç»„
                initializeDualParameters(parameterRows.length, parameterRows);
                
                let parameterFormHTML = '';
                
                // ç”Ÿæˆå‚æ•°è¡Œè¡¨å•
                parameterRows.forEach((row, index) => {
                    // è·å–å½“å‰è¡Œçš„å€¼ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨é€‰é¡¹ä½œä¸ºé»˜è®¤å€¼
                    const defaultValue1 = (row.options1 && row.options1.length > 0) ? row.options1[0] : '';
                    const defaultValue2 = (row.options2 && row.options2.length > 0) ? row.options2[0] : '';
                    const currentValue1 = (dualParameters[index] && dualParameters[index][0] !== '') ? dualParameters[index][0] : defaultValue1;
                    const currentValue2 = (dualParameters[index] && dualParameters[index][1] !== '') ? dualParameters[index][1] : defaultValue2;
                    
                    parameterFormHTML += `
                        <div class="param-group">
                            <label class="param-label">${row.description}</label>
                            <div class="param-dual-select">
                                <select class="param-input" onchange="updateDualParameter(${index}, 0, this.value)">
                                    ${(row.options1 || []).map(option => `
                                        <option value="${option}" ${currentValue1 === option ? 'selected' : ''}>${option}</option>
                                    `).join('')}
                                    <option value="" ${currentValue1 === '' ? 'selected' : ''}>ç©ºç™½</option>
                                </select>
                                <select class="param-input" onchange="updateDualParameter(${index}, 1, this.value)">
                                    ${(row.options2 || []).map(option => `
                                        <option value="${option}" ${currentValue2 === option ? 'selected' : ''}>${option}</option>
                                    `).join('')}
                                    <option value="" ${currentValue2 === '' ? 'selected' : ''}>ç©ºç™½</option>
                                </select>
                            </div>
                        </div>
                    `;
                });
                
                // ç”Ÿæˆç¤ºä¾‹å‘½ä»¤åˆ—è¡¨
                let examplesHTML = '';
                if (examples.length > 0) {
                    examplesHTML = `
                        <div class="examples-section">
                            <h4 style="margin: 16px 0 8px 0; font-size: 14px; color: var(--text-primary);">ç¤ºä¾‹å‘½ä»¤</h4>
                            ${examples.map((example, index) => `
                                <div class="example-item">
                                    <code class="example-command">${example}</code>
                                    <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px; margin-left: 8px;" onclick="addExampleToScript('${example}')">æ·»åŠ </button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                container.innerHTML = `
                    <div class="params-form">
                        <div class="command-info">
                            <h3>${selectedCommand.name}</h3>
                            <p>${selectedCommand.desc}</p>
                        </div>
                        ${parameterFormHTML}
                        ${examplesHTML}
                        ${parameterRows.length > 0 ? '<button class="add-command-btn" onclick="addCommand()" style="margin-top: 16px;">ç”Ÿæˆå¹¶æ·»åŠ åˆ°è„šæœ¬</button>' : ''}
                    </div>
                `;
                
                // å‚æ•°å·²åœ¨å‰é¢åˆå§‹åŒ–ï¼Œä¸éœ€è¦é‡å¤åˆå§‹åŒ–
                
            } else {
                // æ—§çš„é¢„å®šä¹‰å‘½ä»¤ç»“æ„ï¼ˆä¿æŒå…¼å®¹ï¼‰
                const template = parameterTemplates[selectedCommand.name] || {};
                const commandParams = selectedCommand.params || [];
                
                container.innerHTML = `
                    <div class="params-form">
                        <div class="command-info">
                            <h3>${selectedCommand.name}</h3>
                            <p>${selectedCommand.desc}</p>
                        </div>
                        ${commandParams.map(param => {
                            const paramTemplate = template[param];
                            return `
                                <div class="param-group">
                                    <label class="param-label">${param}</label>
                                    ${paramTemplate?.type === 'select' ? `
                                        <select class="param-input" onchange="updateParameter('${param}', this.value)">
                                            ${paramTemplate.options.map(option => `
                                                <option value="${option}" ${option === paramTemplate.default ? 'selected' : ''}>${option}</option>
                                            `).join('')}
                                        </select>
                                    ` : `
                                        <input type="${paramTemplate?.type || 'text'}" 
                                               class="param-input" 
                                               placeholder="è¾“å…¥ ${param}"
                                               value="${paramTemplate?.default || ''}"
                                               ${paramTemplate?.step ? `step="${paramTemplate.step}"` : ''}
                                               onchange="updateParameter('${param}', this.value)">
                                    `}
                                </div>
                            `;
                        }).join('')}
                        <button class="add-command-btn" onclick="addCommand()">æ·»åŠ åˆ°è„šæœ¬</button>
                    </div>
                `;

                // åˆå§‹åŒ–å‚æ•°
                commandParams.forEach(param => {
                    const paramTemplate = template[param];
                    if (paramTemplate?.default) {
                        parameters[param] = paramTemplate.default;
                    }
                });
            }
        }

        // æ›´æ–°å‚æ•°
        function updateParameter(param, value) {
            parameters[param] = value;
        }
        
        // åŒå‚æ•°ç®¡ç†
        let dualParameters = [];
        
        // åˆå§‹åŒ–åŒå‚æ•°æ•°ç»„
        function initializeDualParameters(rowCount, parameterRows = []) {
            // åªæœ‰åœ¨æ•°ç»„é•¿åº¦ä¸åŒ¹é…æ—¶æ‰é‡æ–°åˆå§‹åŒ–ï¼Œä¿ç•™ç°æœ‰å€¼
            if (dualParameters.length !== rowCount) {
                const oldParameters = [...dualParameters];
                dualParameters = [];
                
                for (let i = 0; i < rowCount; i++) {
                    // å¦‚æœæ—§æ•°ç»„ä¸­æœ‰å€¼ï¼Œä¿ç•™å®ƒï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤å€¼
                    if (oldParameters[i]) {
                        dualParameters.push([...oldParameters[i]]);
                    } else {
                        // ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨é€‰é¡¹ä½œä¸ºé»˜è®¤å€¼ï¼Œå¦‚æœæ²¡æœ‰é€‰é¡¹åˆ™ä½¿ç”¨ç©ºå­—ç¬¦ä¸²
                        const row = parameterRows[i];
                        const defaultValue1 = (row && row.options1 && row.options1.length > 0) ? row.options1[0] : '';
                        const defaultValue2 = (row && row.options2 && row.options2.length > 0) ? row.options2[0] : '';
                        dualParameters.push([defaultValue1, defaultValue2]); // [å‚æ•°æ¡†1å€¼, å‚æ•°æ¡†2å€¼]
                    }
                }
                
                console.log('åˆå§‹åŒ–/æ›´æ–°å‚æ•°æ•°ç»„:', dualParameters);
            }
        }
        
        // æ›´æ–°åŒå‚æ•°å€¼
        function updateDualParameter(rowIndex, selectIndex, value) {
            if (dualParameters[rowIndex]) {
                // ç¡®ä¿ dualParameters æ•°ç»„å·²æ­£ç¡®åˆå§‹åŒ–
                dualParameters[rowIndex][selectIndex] = value;
                
                // è°ƒè¯•æ—¥å¿—ï¼ˆå¯ä»¥åœ¨å¼€å‘æ—¶æŸ¥çœ‹ï¼‰
                console.log(`æ›´æ–°å‚æ•° [${rowIndex}][${selectIndex}] = "${value}"`);
                console.log('å½“å‰æ‰€æœ‰å‚æ•°:', dualParameters);
            }
        }
        
        // æ·»åŠ ç¤ºä¾‹å‘½ä»¤åˆ°è„šæœ¬
        function addExampleToScript(example) {
            if (!checkProjectRequired('æ·»åŠ ç¤ºä¾‹å‘½ä»¤åˆ°è„šæœ¬')) return;
            
            // ä¿å­˜å½“å‰çŠ¶æ€ç”¨äºæ’¤é”€
            saveScriptState();
            
            // è®¡ç®—æœ€ä½³æ’å…¥ä½ç½®
            const insertPosition = calculateBestInsertPosition();
            
            // åœ¨æŒ‡å®šä½ç½®æ’å…¥ç¤ºä¾‹å‘½ä»¤
            scriptLines.splice(insertPosition, 0, example);
            
            renderScript();
            
            // æ›´æ–°é¡¹ç›®çŠ¶æ€
            if (currentProject) {
                currentProject.scriptLines = [...scriptLines];
                currentProject.timestamp = new Date().toISOString();
            }
            
            updateUndoButton();
            
            // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿ DOM æ›´æ–°å®Œæˆï¼Œç„¶åæ»šåŠ¨åˆ°æ–°æ’å…¥çš„è¡Œå¹¶é«˜äº®æ˜¾ç¤º
            setTimeout(() => {
                scrollToLine(insertPosition);
                highlightNewLine(insertPosition);
            }, 100);
        }

        // æ·»åŠ å‘½ä»¤åˆ°è„šæœ¬
        function addCommand() {
            if (!checkProjectRequired('æ·»åŠ å‘½ä»¤åˆ°è„šæœ¬')) return;
            if (!selectedCommand) return;
            
            // ä¿å­˜å½“å‰çŠ¶æ€ç”¨äºæ’¤é”€
            saveScriptState();
            
            let commandLine = '';
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ·è‡ªå®šä¹‰å‘½ä»¤
            const isUserCommand = selectedCommand.id && selectedCommand.id.startsWith('user_cmd_');
            
            if (isUserCommand) {
                // æ–°çš„ç”¨æˆ·è‡ªå®šä¹‰å‘½ä»¤ï¼šä½¿ç”¨åŒå‚æ•°ç”Ÿæˆ
                commandLine = selectedCommand.name;
                
                console.log('ç”Ÿæˆå‘½ä»¤å¼€å§‹:', commandLine);
                console.log('dualParameters:', dualParameters);
                
                if (dualParameters && dualParameters.length > 0) {
                    dualParameters.forEach((paramPair, index) => {
                        console.log(`å¤„ç†å‚æ•°è¡Œ ${index}:`, paramPair);
                        
                        // æ·»åŠ éç©ºçš„å‚æ•°å€¼ï¼ˆæ³¨æ„ï¼šç©ºå­—ç¬¦ä¸²""è¡¨ç¤ºç”¨æˆ·é€‰æ‹©äº†ç©ºç™½é€‰é¡¹ï¼‰
                        if (paramPair[0] && paramPair[0].trim() !== '') {
                            commandLine += ` ${paramPair[0]}`;
                            console.log(`æ·»åŠ å‚æ•°æ¡†1: "${paramPair[0]}"`);
                        }
                        if (paramPair[1] && paramPair[1].trim() !== '') {
                            commandLine += ` ${paramPair[1]}`;
                            console.log(`æ·»åŠ å‚æ•°æ¡†2: "${paramPair[1]}"`);
                        }
                    });
                }
                
                console.log('æœ€ç»ˆå‘½ä»¤:', commandLine);
                
            } else if (selectedCommand.template) {
                // æ—§ç‰ˆç”¨æˆ·æ¨¡æ¿æ–¹å¼ï¼ˆä¿æŒå…¼å®¹ï¼‰
                commandLine = selectedCommand.template;
                if (selectedCommand.params) {
                    selectedCommand.params.forEach(param => {
                        const value = parameters[param] || '';
                        const placeholder = `{${param}}`;
                        commandLine = commandLine.replace(new RegExp(placeholder, 'g'), value);
                    });
                }
            } else {
                // é¢„å®šä¹‰å‘½ä»¤æ–¹å¼
                commandLine = selectedCommand.name;
                const template = parameterTemplates[selectedCommand.name] || {};
                
                if (selectedCommand.params) {
                    selectedCommand.params.forEach(param => {
                        const value = parameters[param] || template[param]?.default || '';
                        if (value) commandLine += ` ${value}`;
                    });
                }
            }
            
            // æ¸…ç†å¤šä½™çš„ç©ºæ ¼
            commandLine = commandLine.replace(/\s+/g, ' ').trim();
            
            // è®¡ç®—æœ€ä½³æ’å…¥ä½ç½®
            const insertPosition = calculateBestInsertPosition();
            
            // åœ¨æŒ‡å®šä½ç½®æ’å…¥æ–°å‘½ä»¤
            scriptLines.splice(insertPosition, 0, commandLine);
            
            renderScript();
            
            // ä¸æ¸…ç©ºå‚æ•°çŠ¶æ€ï¼Œè®©ç”¨æˆ·å¯ä»¥é‡å¤ä½¿ç”¨ç›¸åŒå‚æ•°
            // parameters = {};
            // dualParameters = [];
            
            // æ›´æ–°é¡¹ç›®çŠ¶æ€
            if (currentProject) {
                currentProject.scriptLines = [...scriptLines];
                currentProject.timestamp = new Date().toISOString();
            }
            
            updateUndoButton();
            
            // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿ DOM æ›´æ–°å®Œæˆï¼Œç„¶åæ»šåŠ¨åˆ°æ–°æ’å…¥çš„è¡Œå¹¶é«˜äº®æ˜¾ç¤º
            setTimeout(() => {
                scrollToLine(insertPosition);
                highlightNewLine(insertPosition);
            }, 100);
        }

        // é«˜äº®æ˜¾ç¤ºæ–°æ’å…¥çš„è¡Œ
        function highlightNewLine(index) {
            const scriptLineElements = document.querySelectorAll('.script-line');
            if (scriptLineElements[index]) {
                const lineElement = scriptLineElements[index];
                
                // æ·»åŠ é«˜äº®æ•ˆæœ
                lineElement.style.backgroundColor = '#3b82f6';
                lineElement.style.color = 'white';
                lineElement.style.transform = 'scale(1.02)';
                lineElement.style.transition = 'all 0.3s ease';
                
                // 1.5ç§’åç§»é™¤é«˜äº®æ•ˆæœ
                setTimeout(() => {
                    lineElement.style.backgroundColor = '';
                    lineElement.style.color = '';
                    lineElement.style.transform = '';
                    lineElement.style.transition = 'all 0.5s ease';
                }, 1500);
            }
        }

        // æ¸²æŸ“è„šæœ¬
        function renderScript() {
            const container = document.getElementById('scriptContent');
            const lineCount = document.getElementById('lineCount');
            
            lineCount.textContent = `${scriptLines.length} ${t('lines')}`;
            
            if (scriptLines.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ‘ï¸</div>
                        <p>${t('scriptEmpty')}</p>
                        <p style="font-size: 12px; margin-top: 8px; color: #9ca3af;">${t('addAfterCommand')}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="step-legend">
                    <div class="legend-item">
                        <div class="legend-color step-init"></div>
                        <span>${t('init')}</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color step-geometry"></div>
                        <span>${t('geo')}</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color step-material"></div>
                        <span>${t('mat')}</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color step-particle"></div>
                        <span>${t('part')}</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color step-solver"></div>
                        <span>${t('sol')}</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color step-output"></div>
                        <span>${t('out')}</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color step-other"></div>
                        <span>${t('other')}</span>
                    </div>
                </div>
                <div class="drag-hint" id="dragHint">
                    <span>â‹®â‹®</span>
                    <span>${t('dragHint')}</span>
                </div>
                <div class="script-lines" id="scriptLines">
                    ${scriptLines.map((line, index) => {
                        const step = getCommandStep(line);
                        const stepClass = stepToClassMapping[step] || 'step-init';
                        return `
                            <div class="script-line ${stepClass}" draggable="true" data-index="${index}" data-step="${step}" ondblclick="editScriptLine(${index})">
                                <div style="display: flex; align-items: center; flex: 1;">
                                    <span class="drag-handle">â‹®â‹®</span>
                                    <span class="line-number" style="color: #9ca3af; margin-right: 8px; font-size: 11px; min-width: 20px;">${index + 1}.</span>
                                    <span class="line-content">${line}</span>
                                </div>
                                <button class="delete-btn" data-index="${index}">Ã—</button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            // ä¸ºåˆ é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬
            const deleteButtons = document.querySelectorAll('.delete-btn');
            deleteButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const index = parseInt(this.dataset.index);
                    removeScriptLine(index);
                });
            });
            
            // æ·»åŠ æ‹–æ‹½äº‹ä»¶ç›‘å¬
            setupDragAndDrop();
            
            // æ›´æ–°æ’¤é”€æŒ‰é’®çŠ¶æ€
            updateUndoButton();
        }

        // åˆ é™¤è„šæœ¬è¡Œ
        function removeScriptLine(index) {
            // ä¿å­˜å½“å‰çŠ¶æ€ç”¨äºæ’¤é”€
            saveScriptState();
            
            scriptLines.splice(index, 1);
            renderScript();
            updateUndoButton();
        }

        // æ¸…ç©ºè„šæœ¬
        function clearScript() {
            if (!checkProjectRequired('æ¸…ç©ºè„šæœ¬')) return;
            if (scriptLines.length > 0) {
                // ä¿å­˜å½“å‰çŠ¶æ€ç”¨äºæ’¤é”€
                saveScriptState();
                
                scriptLines = [];
                renderScript();
                updateUndoButton();
            }
        }

        // æ’å…¥æ–°è¡ŒåŠŸèƒ½
        function insertNewLine() {
            if (!checkProjectRequired('æ’å…¥æ–°è¡Œ')) return;
            // ä¿å­˜å½“å‰çŠ¶æ€ç”¨äºæ’¤é”€
            saveScriptState();
            
            // åœ¨æœ«å°¾æ·»åŠ ç©ºè¡Œ
            scriptLines.push('');
            
            // é‡æ–°æ¸²æŸ“è„šæœ¬
            renderScript();
            
            // æ›´æ–°é¡¹ç›®çŠ¶æ€
            if (currentProject) {
                currentProject.scriptLines = [...scriptLines];
                currentProject.timestamp = new Date().toISOString();
            }
            
            updateUndoButton();
            
            // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿DOMæ›´æ–°å®Œæˆï¼Œç„¶åè‡ªåŠ¨è¿›å…¥ç¼–è¾‘çŠ¶æ€
            setTimeout(() => {
                const newIndex = scriptLines.length - 1;
                scrollToLine(newIndex);
                editScriptLine(newIndex);
            }, 50);
        }

        // æ»šåŠ¨åˆ°æŒ‡å®šè¡Œ
        function scrollToLine(index) {
            const scriptContent = document.getElementById('scriptContent');
            const scriptLines = document.querySelectorAll('.script-line');
            
            if (scriptLines[index] && scriptContent) {
                // æ»šåŠ¨åˆ°ç›®æ ‡è¡Œ
                scriptLines[index].scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }
        }

        // è®¡ç®—æœ€ä½³æ’å…¥ä½ç½®
        function calculateBestInsertPosition() {
            // è·å–"æ·»åŠ åˆ°è„šæœ¬"æŒ‰é’®çš„ä½ç½®
            const addButton = document.querySelector('.add-command-btn');
            if (!addButton) {
                return scriptLines.length; // å¦‚æœæ‰¾ä¸åˆ°æŒ‰é’®ï¼Œæ’å…¥åˆ°æœ«å°¾
            }
            
            const buttonRect = addButton.getBoundingClientRect();
            const buttonCenterY = buttonRect.top + buttonRect.height / 2;
            
            // è·å–è„šæœ¬é¢„è§ˆåŒºåŸŸ
            const scriptContent = document.getElementById('scriptContent');
            if (!scriptContent) {
                return scriptLines.length; // å¦‚æœæ‰¾ä¸åˆ°è„šæœ¬åŒºåŸŸï¼Œæ’å…¥åˆ°æœ«å°¾
            }
            
            const scriptContentRect = scriptContent.getBoundingClientRect();
            
            // å¦‚æœæŒ‰é’®ä½ç½®åœ¨è„šæœ¬åŒºåŸŸä¸Šæ–¹ï¼Œæ’å…¥åˆ°å¼€å¤´
            if (buttonCenterY < scriptContentRect.top) {
                return 0;
            }
            
            // å¦‚æœæŒ‰é’®ä½ç½®åœ¨è„šæœ¬åŒºåŸŸä¸‹æ–¹ï¼Œæ’å…¥åˆ°æœ«å°¾
            if (buttonCenterY > scriptContentRect.bottom) {
                return scriptLines.length;
            }
            
            // è·å–æ‰€æœ‰è„šæœ¬è¡Œ
            const scriptLineElements = document.querySelectorAll('.script-line');
            if (scriptLineElements.length === 0) {
                return 0; // å¦‚æœæ²¡æœ‰è„šæœ¬è¡Œï¼Œæ’å…¥åˆ°å¼€å¤´
            }
            
            // æ‰¾åˆ°ä¸æŒ‰é’®ä½ç½®æœ€æ¥è¿‘çš„è„šæœ¬è¡Œ
            let bestIndex = scriptLines.length;
            let minDistance = Infinity;
            
            scriptLineElements.forEach((lineElement, index) => {
                const lineRect = lineElement.getBoundingClientRect();
                const lineCenterY = lineRect.top + lineRect.height / 2;
                const distance = Math.abs(buttonCenterY - lineCenterY);
                
                if (distance < minDistance) {
                    minDistance = distance;
                    // å¦‚æœæŒ‰é’®åœ¨è¯¥è¡Œä¸‹æ–¹ï¼Œæ’å…¥åˆ°è¯¥è¡Œåé¢ï¼›å¦åˆ™æ’å…¥åˆ°è¯¥è¡Œå‰é¢
                    bestIndex = buttonCenterY > lineCenterY ? index + 1 : index;
                }
            });
            
            // ç¡®ä¿æ’å…¥ä½ç½®åœ¨æœ‰æ•ˆèŒƒå›´å†…
            return Math.max(0, Math.min(bestIndex, scriptLines.length));
        }

        // è®¾ç½®æ‹–æ‹½åŠŸèƒ½
        function setupDragAndDrop() {
            const scriptContainer = document.getElementById('scriptLines');
            const dragHint = document.getElementById('dragHint');
            if (!scriptContainer) return;

            let draggedElement = null;
            let draggedIndex = null;
            let hasUserDragged = localStorage.getItem('hasUserDragged') === 'true';

            // å¦‚æœç”¨æˆ·å·²ç»æ‹–æ‹½è¿‡ï¼Œéšè—æç¤º
            if (hasUserDragged && dragHint) {
                dragHint.classList.add('hidden');
            }

            // ä¸ºæ¯ä¸ªè„šæœ¬è¡Œæ·»åŠ æ‹–æ‹½äº‹ä»¶
            const scriptLineElements = scriptContainer.querySelectorAll('.script-line');
            
            scriptLineElements.forEach((element, index) => {
                // æ‹–æ‹½å¼€å§‹
                element.addEventListener('dragstart', function(e) {
                    // å¦‚æœæ­£åœ¨ç¼–è¾‘ï¼Œç¦æ­¢æ‹–æ‹½
                    if (this.classList.contains('editing')) {
                        e.preventDefault();
                        return false;
                    }
                    
                    draggedElement = this;
                    draggedIndex = parseInt(this.dataset.index);
                    this.classList.add('dragging');
                    
                    // éšè—æ‹–æ‹½æç¤ºå¹¶è®°ä½ç”¨æˆ·å·²ç»æ‹–æ‹½è¿‡
                    if (dragHint && !hasUserDragged) {
                        dragHint.classList.add('hidden');
                        localStorage.setItem('hasUserDragged', 'true');
                        hasUserDragged = true;
                    }
                    
                    // è®¾ç½®æ‹–æ‹½æ•°æ®
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', this.outerHTML);
                });

                // æ‹–æ‹½ç»“æŸ
                element.addEventListener('dragend', function(e) {
                    this.classList.remove('dragging');
                    
                    // æ¸…é™¤æ‰€æœ‰æ‹–æ‹½çŠ¶æ€
                    scriptLineElements.forEach(el => {
                        el.classList.remove('drag-over');
                    });
                    
                    draggedElement = null;
                    draggedIndex = null;
                });

                // æ‹–æ‹½è¿›å…¥
                element.addEventListener('dragenter', function(e) {
                    e.preventDefault();
                    if (this !== draggedElement) {
                        this.classList.add('drag-over');
                    }
                });

                // æ‹–æ‹½ç»è¿‡
                element.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });

                // æ‹–æ‹½ç¦»å¼€
                element.addEventListener('dragleave', function(e) {
                    // åªæœ‰åœ¨çœŸæ­£ç¦»å¼€å…ƒç´ æ—¶æ‰ç§»é™¤æ ·å¼
                    if (!this.contains(e.relatedTarget)) {
                        this.classList.remove('drag-over');
                    }
                });

                // æ”¾ç½®
                element.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    
                    if (this !== draggedElement && draggedElement) {
                        const targetIndex = parseInt(this.dataset.index);
                        
                        // é‡æ–°æ’åˆ—è„šæœ¬è¡Œ
                        moveScriptLine(draggedIndex, targetIndex);
                    }
                });
            });
        }

        // ç§»åŠ¨è„šæœ¬è¡Œ
        function moveScriptLine(fromIndex, toIndex) {
            if (fromIndex === toIndex) return;
            
            // ä¿å­˜å½“å‰çŠ¶æ€ç”¨äºæ’¤é”€
            saveScriptState();
            
            // ä¿å­˜è¢«ç§»åŠ¨çš„è¡Œ
            const movedLine = scriptLines[fromIndex];
            
            // ä»åŸä½ç½®åˆ é™¤
            scriptLines.splice(fromIndex, 1);
            
            // æ’å…¥åˆ°æ–°ä½ç½®
            scriptLines.splice(toIndex, 0, movedLine);
            
            // é‡æ–°æ¸²æŸ“è„šæœ¬
            renderScript();
            
            // æ›´æ–°é¡¹ç›®çŠ¶æ€
            if (currentProject) {
                currentProject.scriptLines = [...scriptLines];
                currentProject.timestamp = new Date().toISOString();
            }
            
            updateUndoButton();
            
            // æ˜¾ç¤ºç§»åŠ¨æç¤ºï¼ˆå¯é€‰ï¼‰
            console.log(`è„šæœ¬è¡Œå·²ä»ä½ç½® ${fromIndex + 1} ç§»åŠ¨åˆ°ä½ç½® ${toIndex + 1}`);
        }

        // ç¼–è¾‘è„šæœ¬è¡Œ
        function editScriptLine(index) {
            const scriptLines = document.querySelectorAll('.script-line');
            const lineElement = scriptLines[index];
            
            if (!lineElement || lineElement.classList.contains('editing')) {
                return; // å¦‚æœå·²ç»åœ¨ç¼–è¾‘çŠ¶æ€ï¼Œå¿½ç•¥
            }
            
            // é€€å‡ºå…¶ä»–æ­£åœ¨ç¼–è¾‘çš„è¡Œ
            exitAllEditingStates();
            
            const lineContent = lineElement.querySelector('.line-content');
            const deleteBtn = lineElement.querySelector('.delete-btn');
            const currentText = lineContent.textContent;
            
            // ç¦ç”¨æ‹–æ‹½
            lineElement.draggable = false;
            lineElement.classList.add('editing');
            
            // æ›¿æ¢å†…å®¹ä¸ºç¼–è¾‘ç•Œé¢
            lineContent.innerHTML = `<input type="text" class="edit-input" value="${currentText}">`;
            
            // æ›¿æ¢åˆ é™¤æŒ‰é’®ä¸ºç¼–è¾‘æ“ä½œæŒ‰é’®
            deleteBtn.innerHTML = `
                <div class="edit-actions">
                    <button class="edit-btn save" data-action="save">âœ“</button>
                    <button class="edit-btn cancel" data-action="cancel">âœ•</button>
                </div>
            `;
            
            // ç§»é™¤åŸæ¥çš„onclickäº‹ä»¶
            deleteBtn.onclick = null;
            
            // ä¸ºç¼–è¾‘æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬
            const saveBtn = deleteBtn.querySelector('.edit-btn.save');
            const cancelBtn = deleteBtn.querySelector('.edit-btn.cancel');
            
            saveBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                saveScriptLine(index);
            });
            
            cancelBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                cancelEdit(index, currentText);
            });
            
            // è·å–è¾“å…¥æ¡†å¹¶èšç„¦
            const input = lineElement.querySelector('.edit-input');
            input.focus();
            input.select();
            
            // ç›‘å¬é”®ç›˜äº‹ä»¶
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveScriptLine(index);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit(index, currentText);
                }
            });
            
            // ç›‘å¬å¤±å»ç„¦ç‚¹äº‹ä»¶
            input.addEventListener('blur', function(e) {
                // å»¶è¿Ÿæ‰§è¡Œï¼Œä»¥ä¾¿æŒ‰é’®ç‚¹å‡»äº‹ä»¶èƒ½å¤Ÿè§¦å‘
                setTimeout(() => {
                    // æ£€æŸ¥ç„¦ç‚¹æ˜¯å¦åœ¨ç¼–è¾‘æŒ‰é’®ä¸Š
                    const activeElement = document.activeElement;
                    const isEditButtonFocused = activeElement && 
                        (activeElement.classList.contains('edit-btn') || 
                         activeElement.closest('.edit-actions'));
                    
                    // åªæœ‰åœ¨ç„¦ç‚¹ä¸åœ¨ç¼–è¾‘æŒ‰é’®ä¸Šä¸”ä»åœ¨ç¼–è¾‘çŠ¶æ€æ—¶æ‰è‡ªåŠ¨ä¿å­˜
                    if (lineElement.classList.contains('editing') && 
                        !lineElement.contains(document.activeElement) &&
                        !isEditButtonFocused) {
                        saveScriptLine(index);
                    }
                }, 150);
            });
        }

        // ä¿å­˜ç¼–è¾‘
        function saveScriptLine(index) {
            const lineElement = document.querySelectorAll('.script-line')[index];
            const input = lineElement.querySelector('.edit-input');
            
            if (!input) return;
            
            const newText = input.value.trim();
            
            // å¦‚æœç”¨æˆ·è¾“å…¥ä¸ºç©ºï¼Œåˆ é™¤è¿™ä¸€è¡Œ
            if (newText === '') {
                // ä¿å­˜å½“å‰çŠ¶æ€ç”¨äºæ’¤é”€
                saveScriptState();
                
                // åˆ é™¤ç©ºè¡Œ
                scriptLines.splice(index, 1);
                
                // æ›´æ–°é¡¹ç›®çŠ¶æ€
                if (currentProject) {
                    currentProject.scriptLines = [...scriptLines];
                    currentProject.timestamp = new Date().toISOString();
                }
                
                // é‡æ–°æ¸²æŸ“è„šæœ¬
                renderScript();
                updateUndoButton();
                return;
            }
            
            // åªæœ‰å½“æ–‡æœ¬çœŸæ­£æ”¹å˜æ—¶æ‰ä¿å­˜çŠ¶æ€
            if (newText !== scriptLines[index]) {
                // ä¿å­˜å½“å‰çŠ¶æ€ç”¨äºæ’¤é”€
                saveScriptState();
                
                // æ›´æ–°æ•°æ®
                scriptLines[index] = newText;
                
                // æ›´æ–°é¡¹ç›®çŠ¶æ€
                if (currentProject) {
                    currentProject.scriptLines = [...scriptLines];
                    currentProject.timestamp = new Date().toISOString();
                }
                
                updateUndoButton();
            }
            
            // é‡æ–°æ¸²æŸ“è„šæœ¬
            renderScript();
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEdit(index, originalText) {
            const lineElement = document.querySelectorAll('.script-line')[index];
            const lineContent = lineElement.querySelector('.line-content');
            const deleteBtn = lineElement.querySelector('.delete-btn');
            
            // æ¢å¤åŸå§‹çŠ¶æ€
            lineElement.classList.remove('editing');
            lineElement.draggable = true;
            
            // æ¢å¤åŸå§‹å†…å®¹
            lineContent.innerHTML = originalText;
            
            // æ¢å¤åˆ é™¤æŒ‰é’®
            deleteBtn.innerHTML = 'Ã—';
            deleteBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                removeScriptLine(index);
            };
        }

        // é€€å‡ºæ‰€æœ‰ç¼–è¾‘çŠ¶æ€
        function exitAllEditingStates() {
            const editingLines = document.querySelectorAll('.script-line.editing');
            editingLines.forEach((line) => {
                const input = line.querySelector('.edit-input');
                if (input) {
                    const index = parseInt(line.dataset.index);
                    const originalText = scriptLines[index];
                    cancelEdit(index, originalText);
                }
            });
        }

        // æ–°å»ºé¡¹ç›®
        async function newProject() {
            // å…ˆæ£€æŸ¥æµè§ˆå™¨æ”¯æŒï¼Œå†³å®šä½¿ç”¨å“ªç§æ–¹å¼
            const supportsFilePicker = window.showSaveFilePicker;
            
            // è·å–é¡¹ç›®åç§°
            const name = prompt('è¯·è¾“å…¥é¡¹ç›®åç§°ï¼š');
            if (!name || !name.trim()) {
                return; // ç”¨æˆ·å–æ¶ˆæˆ–æœªè¾“å…¥åç§°
            }
            
            const newProjectName = name.trim();
            
            // é‡ç½®æ‰€æœ‰çŠ¶æ€
            activeCategory = 'åˆå§‹åŒ–è®¾ç½®';
            selectedCommand = null;
            scriptLines = [];
            parameters = {};
            currentFileHandle = null;
            previousScriptState = null;
            commandPositions = {};
            userCommands = {};
            
            // åˆ›å»ºé¡¹ç›®å¯¹è±¡
            currentProject = {
                name: newProjectName,
                activeCategory: activeCategory,
                selectedCommand: selectedCommand,
                scriptLines: [...scriptLines],
                parameters: {...parameters},
                commandPositions: {...commandPositions},
                userCommands: {...userCommands},
                timestamp: new Date().toISOString()
            };
            
            try {
                if (supportsFilePicker) {
                    // ä½¿ç”¨æ–‡ä»¶ç³»ç»ŸAPIï¼Œä½†éœ€è¦é‡æ–°è§¦å‘ç”¨æˆ·æ‰‹åŠ¿
                    // æ˜¾ç¤ºä¸€ä¸ªç¡®è®¤å¯¹è¯æ¡†æ¥é‡æ–°è·å–ç”¨æˆ·æ‰‹åŠ¿
                    const shouldSaveNow = confirm(`é¡¹ç›® "${newProjectName}" å·²å‡†å¤‡å¥½ï¼\n\nç‚¹å‡»"ç¡®å®š"é€‰æ‹©ä¿å­˜ä½ç½®ï¼Œç‚¹å‡»"å–æ¶ˆ"ç¨åæ‰‹åŠ¨ä¿å­˜ã€‚`);
                    
                    if (shouldSaveNow) {
                        const fileHandle = await window.showSaveFilePicker({
                            suggestedName: `${newProjectName}.json`,
                            types: [{
                                description: 'LIGGGHTSé¡¹ç›®æ–‡ä»¶',
                                accept: {
                                    'application/json': ['.json']
                                }
                            }]
                        });
                        
                        currentFileHandle = fileHandle;
                        // æ›´æ–°å…¨å±€é¡¹ç›®åç§°
                        projectName = newProjectName;
                        await saveToFile();
                        
                        // æˆåŠŸåæ›´æ–°ç•Œé¢
                        resetInterface();
                        updateToolbarTitle();
                        updateUndoButton();
                        updateInterfaceState();
                        
                        alert(`é¡¹ç›® "${newProjectName}" åˆ›å»ºå¹¶ä¿å­˜æˆåŠŸï¼`);
                    } else {
                        // ç”¨æˆ·é€‰æ‹©ç¨åä¿å­˜ï¼Œå…ˆåˆ›å»ºé¡¹ç›®
                        projectName = newProjectName;
                        
                        // æ›´æ–°ç•Œé¢
                        resetInterface();
                        updateToolbarTitle();
                        updateUndoButton();
                        updateInterfaceState();
                        
                        alert(`é¡¹ç›® "${newProjectName}" å·²åˆ›å»ºï¼\n\nè¯·è®°å¾—ä½¿ç”¨"ä¿å­˜"æŒ‰é’®ä¿å­˜é¡¹ç›®æ–‡ä»¶ã€‚`);
                    }
                } else {
                    // æµè§ˆå™¨ä¸æ”¯æŒï¼Œç›´æ¥ä¸‹è½½
                    projectName = newProjectName;
                    downloadProjectFile();
                    
                    // æ›´æ–°ç•Œé¢
                    resetInterface();
                    updateToolbarTitle();
                    updateUndoButton();
                    updateInterfaceState();
                    
                    alert(`é¡¹ç›® "${newProjectName}" åˆ›å»ºæˆåŠŸï¼\næ³¨æ„ï¼šæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒç›´æ¥æ–‡ä»¶ä¿å­˜ã€‚`);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    // ç”¨æˆ·å–æ¶ˆäº†ä¿å­˜ï¼Œæ¢å¤åˆå§‹çŠ¶æ€
                    projectName = '';
                    currentProject = null;
                    currentFileHandle = null;
                    // ä¸æ›´æ–°ç•Œé¢ï¼Œä¿æŒç¦ç”¨çŠ¶æ€
                } else {
                    console.error('åˆ›å»ºé¡¹ç›®å¤±è´¥:', error);
                    
                    // å¦‚æœæ˜¯ç”¨æˆ·æ‰‹åŠ¿é”™è¯¯ï¼Œå…ˆåˆ›å»ºé¡¹ç›®ï¼Œç„¶åæç¤ºç”¨æˆ·æ‰‹åŠ¨ä¿å­˜
                    if (error.message && error.message.includes('user gesture')) {
                        projectName = newProjectName;
                        
                        // æ›´æ–°ç•Œé¢
                        resetInterface();
                        updateToolbarTitle();
                        updateUndoButton();
                        updateInterfaceState();
                        
                        alert(`é¡¹ç›® "${newProjectName}" å·²åˆ›å»ºï¼\n\nç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œè¯·ç‚¹å‡»"ä¿å­˜"æŒ‰é’®æ‰‹åŠ¨ä¿å­˜é¡¹ç›®æ–‡ä»¶ã€‚`);
                    } else {
                        alert(`é¡¹ç›®åˆ›å»ºå¤±è´¥ï¼š${error.message}`);
                        // å‘ç”Ÿé”™è¯¯æ—¶ä¹Ÿæ¢å¤åˆå§‹çŠ¶æ€
                        projectName = '';
                        currentProject = null;
                        currentFileHandle = null;
                    }
                }
            }
        }

        // ä¿å­˜é¡¹ç›®
        async function saveProject() {
            if (!projectName) {
                alert('è¯·å…ˆåˆ›å»ºé¡¹ç›®ï¼');
                return;
            }
            
            // æ›´æ–°é¡¹ç›®æ•°æ®
            currentProject = {
                name: projectName,
                activeCategory: activeCategory,
                selectedCommand: selectedCommand,
                scriptLines: [...scriptLines],
                parameters: {...parameters},
                commandPositions: {...commandPositions},
                userCommands: {...userCommands},
                timestamp: new Date().toISOString()
            };
            
            try {
                if (currentFileHandle) {
                    // æœ‰æ–‡ä»¶å¥æŸ„ï¼Œå°è¯•ç›´æ¥è¦†ç›–ä¿å­˜
                    try {
                        await saveToFile();
                        alert(`é¡¹ç›® "${projectName}" ä¿å­˜æˆåŠŸï¼`);
                        return; // ä¿å­˜æˆåŠŸï¼Œç›´æ¥è¿”å›
                    } catch (fileError) {
                        // å¦‚æœæ˜¯æ–‡ä»¶è®¿é—®é”™è¯¯ï¼Œæç¤ºç”¨æˆ·å¹¶é‡æ–°é€‰æ‹©ä½ç½®
                        if (fileError.message.includes('æ–‡ä»¶å·²è¢«ç§»åŠ¨æˆ–åˆ é™¤')) {
                            const shouldChooseNew = confirm(`âš ï¸ ${fileError.message}\n\nç‚¹å‡»"ç¡®å®š"é€‰æ‹©æ–°çš„ä¿å­˜ä½ç½®ï¼Œç‚¹å‡»"å–æ¶ˆ"å–æ¶ˆä¿å­˜ã€‚`);
                            if (!shouldChooseNew) {
                                return; // ç”¨æˆ·å–æ¶ˆä¿å­˜
                            }
                            // ç»§ç»­æ‰§è¡Œä¸‹é¢çš„æ–‡ä»¶é€‰æ‹©é€»è¾‘
                        } else {
                            // å…¶ä»–é”™è¯¯ç›´æ¥æŠ›å‡º
                            throw fileError;
                        }
                    }
                }
                
                if (window.showSaveFilePicker) {
                    // æ²¡æœ‰æ–‡ä»¶å¥æŸ„æˆ–æ–‡ä»¶å¥æŸ„å¤±æ•ˆï¼Œé€‰æ‹©ä¿å­˜ä½ç½®
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: `${projectName}.json`,
                        types: [{
                            description: 'LIGGGHTSé¡¹ç›®æ–‡ä»¶',
                            accept: {
                                'application/json': ['.json']
                            }
                        }]
                    });
                    
                    currentFileHandle = fileHandle;
                    await saveToFile();
                    alert(`é¡¹ç›® "${projectName}" ä¿å­˜æˆåŠŸï¼`);
                } else {
                    // æµè§ˆå™¨ä¸æ”¯æŒï¼Œä½¿ç”¨ä¸‹è½½æ–¹å¼
                    downloadProjectFile();
                    alert(`é¡¹ç›® "${projectName}" å·²ä¸‹è½½ï¼`);
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('ä¿å­˜é¡¹ç›®å¤±è´¥:', error);
                    alert(`ä¿å­˜é¡¹ç›®å¤±è´¥ï¼š${error.message}`);
                }
            }
        }

        // ä¿å­˜åˆ°æ–‡ä»¶ï¼ˆä½¿ç”¨æ–‡ä»¶å¥æŸ„ï¼‰
        async function saveToFile() {
            if (!currentFileHandle) {
                throw new Error('æ²¡æœ‰æ–‡ä»¶å¥æŸ„');
            }
            
            try {
                const dataStr = JSON.stringify(currentProject, null, 2);
                const writable = await currentFileHandle.createWritable();
                await writable.write(dataStr);
                await writable.close();
            } catch (error) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ–‡ä»¶è®¿é—®æƒé™é”™è¯¯ï¼ˆæ–‡ä»¶è¢«ç§»åŠ¨/åˆ é™¤ï¼‰
                if (error.name === 'NotAllowedError' || 
                    error.name === 'NotFoundError' || 
                    error.message.includes('not allowed') ||
                    error.message.includes('not found')) {
                    
                    // æ¸…é™¤æ— æ•ˆçš„æ–‡ä»¶å¥æŸ„
                    currentFileHandle = null;
                    
                    // æŠ›å‡ºè‡ªå®šä¹‰é”™è¯¯ï¼Œæä¾›æ›´æ˜ç¡®çš„ä¿¡æ¯
                    throw new Error('æ–‡ä»¶å·²è¢«ç§»åŠ¨æˆ–åˆ é™¤ï¼Œæ— æ³•ä¿å­˜åˆ°åŸä½ç½®ã€‚è¯·é€‰æ‹©æ–°çš„ä¿å­˜ä½ç½®ã€‚');
                } else {
                    // å…¶ä»–é”™è¯¯ç›´æ¥ä¼ é€’
                    throw error;
                }
            }
        }

        // ä¸‹è½½é¡¹ç›®æ–‡ä»¶ï¼ˆå›é€€æ–¹æ¡ˆï¼‰
        function downloadProjectFile() {
            const dataStr = JSON.stringify(currentProject, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${projectName}.json`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
        }

        // æ‰“å¼€é¡¹ç›®
        async function openProject() {
            try {
                if (window.showOpenFilePicker) {
                    // ä½¿ç”¨æ–‡ä»¶ç³»ç»ŸAPI
                    const [fileHandle] = await window.showOpenFilePicker({
                        types: [{
                            description: 'LIGGGHTSé¡¹ç›®æ–‡ä»¶',
                            accept: {
                                'application/json': ['.json']
                            }
                        }]
                    });
                    
                    const file = await fileHandle.getFile();
                    const contents = await file.text();
                    const projectData = JSON.parse(contents);
                    
                    // ä¿å­˜æ–‡ä»¶å¥æŸ„ä»¥ä¾¿åç»­ä¿å­˜
                    currentFileHandle = fileHandle;
                    
                    loadProject(projectData);
                } else {
                    // æµè§ˆå™¨ä¸æ”¯æŒï¼Œä½¿ç”¨ä¼ ç»Ÿæ–¹å¼
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.style.display = 'none';
                    
                    input.onchange = function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                try {
                                    const projectData = JSON.parse(e.target.result);
                                    // ä¼ ç»Ÿæ–¹å¼æ‰“å¼€çš„æ–‡ä»¶æ— æ³•è·å–å¥æŸ„
                                    currentFileHandle = null;
                                    loadProject(projectData);
                                } catch (error) {
                                    alert('é¡¹ç›®æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼');
                                }
                            };
                            reader.readAsText(file);
                        }
                    };
                    
                    document.body.appendChild(input);
                    input.click();
                    document.body.removeChild(input);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    // ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶é€‰æ‹©
                    return;
                } else {
                    console.error('æ‰“å¼€é¡¹ç›®å¤±è´¥:', error);
                    alert('æ‰“å¼€é¡¹ç›®å¤±è´¥ï¼');
                }
            }
        }

        // åŠ è½½é¡¹ç›®
        function loadProject(projectData) {
            // éªŒè¯é¡¹ç›®æ•°æ®
            if (!projectData.name) {
                alert('é¡¹ç›®æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘é¡¹ç›®åç§°ï¼');
                return;
            }
            
            // æ¢å¤é¡¹ç›®çŠ¶æ€
            currentProject = projectData;
            projectName = projectData.name;
            activeCategory = projectData.activeCategory || 'åˆå§‹åŒ–è®¾ç½®';
            selectedCommand = projectData.selectedCommand || null;
            scriptLines = [...(projectData.scriptLines || [])];
            parameters = {...(projectData.parameters || {})};
            // å…¼å®¹æ—§ç‰ˆæœ¬ï¼šä¼˜å…ˆä½¿ç”¨æ–°çš„commandPositionsï¼Œå›é€€åˆ°commandOrders
            commandPositions = {...(projectData.commandPositions || projectData.commandOrders || {})}; 
            userCommands = {...(projectData.userCommands || {})}; // æ¢å¤ç”¨æˆ·å‘½ä»¤
            previousScriptState = null; // é‡ç½®æ’¤é”€çŠ¶æ€
            
            // ç¡®ä¿ç”¨æˆ·å‘½ä»¤ä½¿ç”¨æ–°æ ¼å¼ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰
            ensureCommandsNewFormat();
            
            // é‡æ–°æ¸²æŸ“ç•Œé¢
            resetInterface();
            updateToolbarTitle();
            updateUndoButton();
            updateInterfaceState(); // æ›´æ–°ç•Œé¢çŠ¶æ€
            
            // æ¢å¤å½“å‰åˆ†ç±»æ ‡ç­¾
            switchTab(activeCategory);
            
            // æ›´æ–°æ ‡ç­¾è®¡æ•°
            updateTabCounts();
            
            // æ¢å¤è„šæœ¬æ˜¾ç¤º
            renderScript();
            
            // æ¢å¤å‘½ä»¤é€‰ä¸­çŠ¶æ€
            if (selectedCommand) {
                setTimeout(() => {
                    document.querySelectorAll('.command-card').forEach(card => {
                        // ç²¾ç¡®åŒ¹é…å‘½ä»¤åç§°
                        const cardCommandName = card.querySelector('.command-name');
                        if (cardCommandName && cardCommandName.textContent.trim() === selectedCommand.name) {
                            card.classList.add('selected');
                        }
                    });
                    renderParameterForm();
                }, 100);
            }
            
            // æ ¹æ®æ˜¯å¦æœ‰æ–‡ä»¶å¥æŸ„æ˜¾ç¤ºä¸åŒçš„æç¤º
            if (currentFileHandle) {
                alert(`é¡¹ç›® "${projectName}" åŠ è½½æˆåŠŸï¼\nâœ… æ”¯æŒè¦†ç›–ä¿å­˜ - ç‚¹å‡»ä¿å­˜æŒ‰é’®å°†ç›´æ¥æ›´æ–°åŸæ–‡ä»¶`);
            } else {
                alert(`é¡¹ç›® "${projectName}" åŠ è½½æˆåŠŸï¼\nâš ï¸ ä¸æ”¯æŒè¦†ç›–ä¿å­˜ - ç‚¹å‡»ä¿å­˜æŒ‰é’®å°†ä¸‹è½½æ–°æ–‡ä»¶`);
            }
        }

        // é‡ç½®ç•Œé¢
        function resetInterface() {
            // æ¸…é™¤é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.command-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // æ¸…ç©ºæœç´¢æ¡†
            document.getElementById('searchInput').value = '';
            
            // é‡æ–°æ¸²æŸ“æ‰€æœ‰ç•Œé¢ç»„ä»¶
            renderCommands();
            renderParameterForm();
            renderScript(); // æ¸…ç©ºè„šæœ¬åŒºåŸŸ
            
            // æ›´æ–°æ ‡ç­¾è®¡æ•°
            updateTabCounts();
        }

        // æ›´æ–°å·¥å…·æ æ ‡é¢˜
        function updateToolbarTitle() {
            const title = document.querySelector('.toolbar h1');
            if (projectName) {
                title.textContent = `LIGGGHTS å¯è§†åŒ–ç•Œé¢ - ${projectName}`;
            } else {
                title.textContent = 'LIGGGHTS å¯è§†åŒ–ç•Œé¢';
            }
        }

        // å¯¼å…¥è„šæœ¬
        async function importScript() {
            if (!checkProjectRequired('å¯¼å…¥è„šæœ¬')) return;
            try {
                if (window.showOpenFilePicker) {
                    // ä½¿ç”¨æ–‡ä»¶ç³»ç»ŸAPI
                    const [fileHandle] = await window.showOpenFilePicker({
                        types: [{
                            description: 'LIGGGHTSè„šæœ¬æ–‡ä»¶',
                            accept: {
                                'text/plain': ['.txt', '.in', '.lmp', '.liggghts'],
                                'application/octet-stream': ['.in', '.lmp', '.liggghts']
                            }
                        }]
                    });
                    
                    const file = await fileHandle.getFile();
                    const contents = await file.text();
                    
                    processImportedScript(contents, file.name);
                    
                } else {
                    // æµè§ˆå™¨ä¸æ”¯æŒï¼Œä½¿ç”¨ä¼ ç»Ÿæ–¹å¼
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.txt,.in,.lmp,.liggghts,text/plain';
                    input.style.display = 'none';
                    
                    input.onchange = function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const contents = e.target.result;
                                processImportedScript(contents, file.name);
                            };
                            reader.readAsText(file);
                        }
                    };
                    
                    document.body.appendChild(input);
                    input.click();
                    document.body.removeChild(input);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    // ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶é€‰æ‹©
                    return;
                } else {
                    console.error('å¯¼å…¥è„šæœ¬å¤±è´¥:', error);
                    alert('å¯¼å…¥è„šæœ¬å¤±è´¥ï¼');
                }
            }
        }

        // å¤„ç†å¯¼å…¥çš„è„šæœ¬å†…å®¹
        function processImportedScript(contents, fileName) {
            if (!contents || contents.trim() === '') {
                alert('è„šæœ¬æ–‡ä»¶ä¸ºç©ºï¼');
                return;
            }

            // é¢„å¤„ç†è„šæœ¬å†…å®¹ï¼Œè®¡ç®—æœ‰æ•ˆè¡Œæ•°
            const lines = contents.split('\n');
            const validLines = lines.filter(line => {
                const trimmedLine = line.trim();
                return trimmedLine && !trimmedLine.startsWith('#') && !trimmedLine.startsWith('//');
            });

            const currentScriptCount = scriptLines.length;
            const importLineCount = validLines.length;
            
            // æ˜¾ç¤ºå¯¼å…¥é€‰æ‹©å¯¹è¯æ¡†
            let mode = '';
            if (currentScriptCount === 0) {
                // å½“å‰è„šæœ¬ä¸ºç©ºï¼Œç›´æ¥å¯¼å…¥
                mode = 'replace';
            } else {
                // å½“å‰è„šæœ¬ä¸ä¸ºç©ºï¼Œè®©ç”¨æˆ·é€‰æ‹©
                const message = `è„šæœ¬æ–‡ä»¶ï¼š"${fileName}"\næœ‰æ•ˆå‘½ä»¤è¡Œæ•°ï¼š${importLineCount} è¡Œ\nå½“å‰è„šæœ¬è¡Œæ•°ï¼š${currentScriptCount} è¡Œ\n\nè¯·é€‰æ‹©å¯¼å…¥æ¨¡å¼ï¼š`;
                
                const choice = prompt(message + '\n\nè¾“å…¥ "1" = æ›¿æ¢å½“å‰è„šæœ¬\nè¾“å…¥ "2" = è¿½åŠ åˆ°å½“å‰è„šæœ¬\nè¾“å…¥å…¶ä»– = å–æ¶ˆå¯¼å…¥', '1');
                
                if (choice === '1') {
                    mode = 'replace';
                } else if (choice === '2') {
                    mode = 'append';
                } else {
                    alert('å·²å–æ¶ˆå¯¼å…¥');
                    return;
                }
            }
            
            if (mode === 'replace') {
                // æ›¿æ¢å½“å‰è„šæœ¬
                scriptLines = [];
            }
            
            // æ·»åŠ æœ‰æ•ˆè¡Œåˆ°è„šæœ¬
            validLines.forEach(line => {
                scriptLines.push(line.trim());
            });
            
            // æ›´æ–°ç•Œé¢æ˜¾ç¤º
            renderScript();
            
            // æ›´æ–°é¡¹ç›®çŠ¶æ€
            if (currentProject) {
                currentProject.scriptLines = [...scriptLines];
                currentProject.timestamp = new Date().toISOString();
            }
            
            // é‡ç½®æ’¤é”€çŠ¶æ€ï¼Œå› ä¸ºè¿™æ˜¯å¯¼å…¥æ“ä½œ
            previousScriptState = null;
            updateUndoButton();
            
            // æ˜¾ç¤ºå¯¼å…¥ç»“æœ
            const actionText = mode === 'replace' ? 'æ›¿æ¢' : 'è¿½åŠ ';
            const resultMessage = `âœ… è„šæœ¬å¯¼å…¥æˆåŠŸï¼\n\nğŸ“„ æ–‡ä»¶ï¼š${fileName}\nğŸ”„ æ¨¡å¼ï¼š${actionText}\nğŸ“ å¯¼å…¥ï¼š${importLineCount} è¡Œ\nğŸ“Š æ€»è®¡ï¼š${scriptLines.length} è¡Œ`;
            
            alert(resultMessage);
        }

        // å¯¼å‡ºè„šæœ¬
        async function exportScript() {
            if (!checkProjectRequired('å¯¼å‡ºè„šæœ¬')) return;
            if (scriptLines.length === 0) {
                alert('å½“å‰è„šæœ¬ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡ºï¼\nè¯·å…ˆæ·»åŠ ä¸€äº›å‘½ä»¤åˆ°è„šæœ¬ä¸­ã€‚');
                return;
            }

            try {
                // è®©ç”¨æˆ·é€‰æ‹©å¯¼å‡ºæ ¼å¼
                const format = prompt('é€‰æ‹©å¯¼å‡ºæ ¼å¼ï¼š\n\nè¾“å…¥ "1" = LIGGGHTSè¾“å…¥æ–‡ä»¶ (.in)\nè¾“å…¥ "2" = æ–‡æœ¬æ–‡ä»¶ (.txt)\nè¾“å…¥ "3" = LAMMPSè„šæœ¬ (.lmp)\nè¾“å…¥å…¶ä»– = å–æ¶ˆå¯¼å‡º', '1');
                
                let fileExtension = '';
                let fileDescription = '';
                
                switch (format) {
                    case '1':
                        fileExtension = '.in';
                        fileDescription = 'LIGGGHTSè¾“å…¥æ–‡ä»¶';
                        break;
                    case '2':
                        fileExtension = '.txt';
                        fileDescription = 'æ–‡æœ¬æ–‡ä»¶';
                        break;
                    case '3':
                        fileExtension = '.lmp';
                        fileDescription = 'LAMMPSè„šæœ¬æ–‡ä»¶';
                        break;
                    default:
                        alert('å·²å–æ¶ˆå¯¼å‡º');
                        return;
                }

                // ç”Ÿæˆè„šæœ¬å†…å®¹
                const scriptContent = generateScriptContent(fileExtension);
                
                // ç¡®å®šæ–‡ä»¶å
                let fileName = projectName ? `${projectName}${fileExtension}` : `liggghts_script${fileExtension}`;
                
                if (window.showSaveFilePicker) {
                    // ä½¿ç”¨æ–‡ä»¶ç³»ç»ŸAPI
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: fileName,
                        types: [{
                            description: fileDescription,
                            accept: {
                                'text/plain': [fileExtension]
                            }
                        }]
                    });
                    
                    const writable = await fileHandle.createWritable();
                    await writable.write(scriptContent);
                    await writable.close();
                    
                    alert(`âœ… è„šæœ¬å¯¼å‡ºæˆåŠŸï¼\n\nğŸ“„ æ–‡ä»¶ï¼š${fileName}\nğŸ“ è¡Œæ•°ï¼š${scriptLines.length} è¡Œ\nğŸ’¾ å·²ä¿å­˜åˆ°æŒ‡å®šä½ç½®`);
                    
                } else {
                    // æµè§ˆå™¨ä¸æ”¯æŒï¼Œä½¿ç”¨ä¸‹è½½æ–¹å¼
                    downloadScriptFile(scriptContent, fileName);
                    alert(`âœ… è„šæœ¬å¯¼å‡ºæˆåŠŸï¼\n\nğŸ“„ æ–‡ä»¶ï¼š${fileName}\nğŸ“ è¡Œæ•°ï¼š${scriptLines.length} è¡Œ\nğŸ“¥ å·²ä¸‹è½½åˆ°é»˜è®¤ä½ç½®`);
                }
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    // ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶ä¿å­˜
                    return;
                } else {
                    console.error('å¯¼å‡ºè„šæœ¬å¤±è´¥:', error);
                    alert('å¯¼å‡ºè„šæœ¬å¤±è´¥ï¼');
                }
            }
        }

        // ç”Ÿæˆè„šæœ¬å†…å®¹
        function generateScriptContent(fileExtension) {
            const now = new Date();
            const timestamp = now.toLocaleString();
            
            let content = '';
            
            // æ·»åŠ æ–‡ä»¶å¤´æ³¨é‡Š
            content += `# ${fileExtension === '.in' ? 'LIGGGHTS Input Script' : fileExtension === '.lmp' ? 'LAMMPS Script' : 'Script'}\n`;
            content += `# Generated by LIGGGHTS å¯è§†åŒ–ç•Œé¢\n`;
            content += `# Project: ${projectName || 'Untitled'}\n`;
            content += `# Created: ${timestamp}\n`;
            content += `# Total Commands: ${scriptLines.length}\n`;
            content += `#\n`;
            content += `# This script was automatically generated from the visual interface.\n`;
            content += `# You can run this script directly with LIGGGHTS/LAMMPS.\n`;
            content += `#\n\n`;
            
            // æ·»åŠ åˆ†éš”ç¬¦
            content += `${'#'.repeat(60)}\n`;
            content += `# SCRIPT CONTENT\n`;
            content += `${'#'.repeat(60)}\n\n`;
            
            // æ·»åŠ è„šæœ¬å‘½ä»¤
            scriptLines.forEach((line, index) => {
                content += `${line}\n`;
                
                // åœ¨å…³é”®å‘½ä»¤åæ·»åŠ ç©ºè¡Œä»¥æé«˜å¯è¯»æ€§
                const nextLine = scriptLines[index + 1];
                if (line.startsWith('run') || 
                    line.startsWith('minimize') || 
                    line.startsWith('dump') ||
                    line.startsWith('fix') ||
                    (nextLine && (nextLine.startsWith('run') || nextLine.startsWith('minimize')))) {
                    content += '\n';
                }
            });
            
            // æ·»åŠ æ–‡ä»¶å°¾æ³¨é‡Š
            content += `\n${'#'.repeat(60)}\n`;
            content += `# END OF SCRIPT\n`;
            content += `${'#'.repeat(60)}\n`;
            
            return content;
        }

        // ä¸‹è½½è„šæœ¬æ–‡ä»¶ï¼ˆå›é€€æ–¹æ¡ˆï¼‰
        function downloadScriptFile(content, fileName) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
        }

        // å¯¼å…¥å‘½ä»¤åº“
        async function importCommands() {
            if (!checkProjectRequired('å¯¼å…¥å‘½ä»¤åº“')) return;
            
            try {
                if (window.showOpenFilePicker) {
                    // ä½¿ç”¨æ–‡ä»¶ç³»ç»ŸAPI
                    const [fileHandle] = await window.showOpenFilePicker({
                        types: [{
                            description: 'LIGGGHTSé¡¹ç›®æ–‡ä»¶',
                            accept: {
                                'application/json': ['.json']
                            }
                        }]
                    });
                    
                    const file = await fileHandle.getFile();
                    const contents = await file.text();
                    const projectData = JSON.parse(contents);
                    
                    processImportedCommands(projectData, file.name);
                    
                } else {
                    // æµè§ˆå™¨ä¸æ”¯æŒï¼Œä½¿ç”¨ä¼ ç»Ÿæ–¹å¼
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.style.display = 'none';
                    
                    input.onchange = function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                try {
                                    const projectData = JSON.parse(e.target.result);
                                    processImportedCommands(projectData, file.name);
                                } catch (error) {
                                    alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼è¯·ç¡®ä¿æ–‡ä»¶æ˜¯æœ‰æ•ˆçš„JSONé¡¹ç›®æ–‡ä»¶ã€‚');
                                }
                            };
                            reader.readAsText(file);
                        }
                    };
                    
                    document.body.appendChild(input);
                    input.click();
                    document.body.removeChild(input);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    // ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶é€‰æ‹©
                    return;
                } else {
                    console.error('å¯¼å…¥å‘½ä»¤åº“å¤±è´¥:', error);
                    alert('å¯¼å…¥å‘½ä»¤åº“å¤±è´¥ï¼');
                }
            }
        }

        // å¤„ç†å¯¼å…¥çš„å‘½ä»¤åº“
        function processImportedCommands(projectData, fileName) {
            if (!projectData || typeof projectData !== 'object') {
                alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼šä¸æ˜¯æœ‰æ•ˆçš„JSONé¡¹ç›®æ–‡ä»¶ï¼');
                return;
            }

            // æå–å‘½ä»¤åº“éƒ¨åˆ†ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™è¯´æ˜æ˜¯ç©ºé¡¹ç›®æˆ–æ ¼å¼é”™è¯¯ï¼‰
            const commandLibrary = projectData.userCommands || {};
            
            if (!commandLibrary || typeof commandLibrary !== 'object') {
                alert(`å¯¼å…¥å¤±è´¥ï¼šé¡¹ç›®æ–‡ä»¶ "${fileName}" ä¸­æ²¡æœ‰å‘½ä»¤åº“ï¼\n\nå¯èƒ½çš„åŸå› ï¼š\n1. è¿™æ˜¯ä¸€ä¸ªç©ºé¡¹ç›®ï¼ˆæ²¡æœ‰è‡ªå®šä¹‰å‘½ä»¤ï¼‰\n2. æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®\n\nğŸ’¡ æç¤ºï¼šè¦åˆ†äº«å‘½ä»¤åº“ï¼Œè¯·å…ˆåœ¨é¡¹ç›®ä¸­åˆ›å»ºä¸€äº›è‡ªå®šä¹‰å‘½ä»¤ã€‚`);
                return;
            }

            let importedCount = 0;
            let totalCommands = 0;
            let categoriesAdded = [];

            // éå†å‘½ä»¤åº“ä¸­çš„æ‰€æœ‰åˆ†ç±»
            Object.keys(commandLibrary).forEach(category => {
                const categoryCommands = commandLibrary[category];
                
                if (!categoryCommands || typeof categoryCommands !== 'object') {
                    console.warn(`è·³è¿‡æ— æ•ˆåˆ†ç±»: ${category}`);
                    return;
                }

                // è®¡ç®—è¯¥åˆ†ç±»çš„å‘½ä»¤æ€»æ•°
                const commandCount = Object.keys(categoryCommands).length;
                totalCommands += commandCount;

                if (commandCount === 0) {
                    return; // è·³è¿‡ç©ºåˆ†ç±»
                }

                // åˆå§‹åŒ–ç›®æ ‡åˆ†ç±»ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                if (!userCommands[category]) {
                    userCommands[category] = {};
                    categoriesAdded.push(category);
                }

                if (!commandPositions[category]) {
                    commandPositions[category] = {};
                }

                // å¯¼å…¥è¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰å‘½ä»¤ï¼ˆä¸è¦†ç›–ï¼Œé¢å¤–å¢åŠ ï¼‰
                Object.keys(categoryCommands).forEach(commandId => {
                    const command = categoryCommands[commandId];
                    
                    // éªŒè¯å‘½ä»¤ç»“æ„
                    if (!command || !command.name) {
                        console.warn(`è·³è¿‡æ— æ•ˆå‘½ä»¤: ${commandId} in ${category}`);
                        return;
                    }

                    // ç”Ÿæˆæ–°çš„å‘½ä»¤IDä»¥é¿å…å†²çª
                    const newCommandId = generateCommandId();
                    
                    // ç¡®ä¿å‘½ä»¤ä½¿ç”¨æ–°æ ¼å¼ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰
                    const migratedCommand = migrateCommandToNewFormat({
                        ...command,
                        id: newCommandId
                    });

                    // æ·»åŠ å‘½ä»¤åˆ°åº“ä¸­
                    userCommands[category][newCommandId] = migratedCommand;

                    // ä¸ºå‘½ä»¤åˆ†é…ä½ç½®ï¼ˆå¦‚æœæ²¡æœ‰ä½ç½®ä¿¡æ¯ï¼‰
                    const availablePos = findFirstAvailablePosition(10, 4, commandPositions[category], Object.values(userCommands[category]));
                    if (availablePos) {
                        commandPositions[category][newCommandId] = availablePos;
                    }

                    importedCount++;
                });
            });

            if (importedCount === 0) {
                alert(`å¯¼å…¥å¤±è´¥ï¼šé¡¹ç›®æ–‡ä»¶ "${fileName}" ä¸­æ²¡æœ‰æœ‰æ•ˆçš„å‘½ä»¤ï¼\n\nå¯èƒ½çš„åŸå› ï¼š\n1. æ‰€æœ‰å‘½ä»¤æ ¼å¼ä¸æ­£ç¡®\n2. å‘½ä»¤æ•°æ®æŸå\n\nè¯·æ£€æŸ¥é¡¹ç›®æ–‡ä»¶çš„å®Œæ•´æ€§ã€‚`);
                return;
            }

            // ç¡®ä¿æ‰€æœ‰å‘½ä»¤éƒ½ä½¿ç”¨æ–°æ ¼å¼
            ensureCommandsNewFormat();

            // é‡æ–°æ¸²æŸ“ç•Œé¢
            renderCommands();

            // æ›´æ–°é¡¹ç›®çŠ¶æ€
            updateProjectUserCommands();
            
            // æ›´æ–°æ ‡ç­¾è®¡æ•°
            updateTabCounts();

            // æ˜¾ç¤ºå¯¼å…¥ç»“æœ
            const categoryInfo = categoriesAdded.length > 0 ? 
                `\nğŸ†• æ–°å¢åˆ†ç±»: ${categoriesAdded.join(', ')}` : '';
            
            const resultMessage = `âœ… å‘½ä»¤å¯¼å…¥æˆåŠŸï¼\n\nğŸ“„ é¡¹ç›®æ–‡ä»¶ï¼š${fileName}\nğŸ“¦ å¯¼å…¥å‘½ä»¤ï¼š${importedCount} ä¸ª\nğŸ“Š æ–‡ä»¶æ€»å‘½ä»¤ï¼š${totalCommands} ä¸ª${categoryInfo}\n\nğŸ’¡ å¯¼å…¥çš„å‘½ä»¤å·²æ·»åŠ åˆ°æ‚¨çš„å‘½ä»¤åº“ä¸­ï¼Œä¸ä¼šè¦†ç›–ç°æœ‰å‘½ä»¤ã€‚`;
            
            alert(resultMessage);
        }
    </script>
</body>
</html>